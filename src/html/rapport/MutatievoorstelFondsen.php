<?php
/*
Author  						: $Author: rvv $
Laatste aanpassing	: $Date: 2020/06/20 12:13:32 $
File Versie					: $Revision: 1.117 $

$Log: MutatievoorstelFondsen.php,v $
Revision 1.117  2020/06/20 12:13:32  rvv
*** empty log message ***

Revision 1.116  2020/06/13 15:14:32  rvv
*** empty log message ***

Revision 1.115  2020/03/11 16:20:55  rvv
*** empty log message ***

Revision 1.114  2020/03/07 14:42:04  rvv
*** empty log message ***

Revision 1.113  2020/02/29 16:21:30  rvv
*** empty log message ***

Revision 1.112  2019/12/07 17:46:47  rvv
*** empty log message ***

Revision 1.111  2019/11/16 17:36:34  rvv
*** empty log message ***

Revision 1.110  2019/10/02 15:12:07  rvv
*** empty log message ***

Revision 1.109  2019/09/28 17:18:43  rvv
*** empty log message ***

Revision 1.108  2019/09/21 16:30:52  rvv
*** empty log message ***

Revision 1.107  2019/08/28 15:43:33  rvv
*** empty log message ***

Revision 1.106  2019/08/24 16:58:46  rvv
*** empty log message ***

Revision 1.105  2019/08/17 18:10:40  rvv
*** empty log message ***

Revision 1.104  2018/11/18 11:00:55  rvv
*** empty log message ***

Revision 1.103  2018/11/17 17:33:40  rvv
*** empty log message ***

Revision 1.102  2018/11/07 17:07:17  rvv
*** empty log message ***

Revision 1.101  2018/10/31 17:22:23  rvv
*** empty log message ***

Revision 1.100  2018/09/08 17:45:21  rvv
*** empty log message ***

Revision 1.99  2018/08/25 17:27:08  rvv
*** empty log message ***

Revision 1.98  2018/08/18 12:40:14  rvv
php 5.6 & consolidatie

Revision 1.97  2018/07/25 16:09:04  rvv
*** empty log message ***

Revision 1.96  2018/07/22 12:51:02  rvv
*** empty log message ***

Revision 1.95  2018/06/27 16:13:04  rvv
*** empty log message ***

Revision 1.94  2018/05/12 15:45:14  rvv
*** empty log message ***

Revision 1.93  2018/04/07 15:24:45  rvv
*** empty log message ***

Revision 1.92  2018/04/04 15:45:49  rvv
*** empty log message ***

Revision 1.91  2017/11/18 18:57:49  rvv
*** empty log message ***

Revision 1.90  2017/11/12 13:26:02  rvv
*** empty log message ***

Revision 1.89  2017/11/11 18:23:19  rvv
*** empty log message ***

Revision 1.88  2017/07/13 06:53:01  rvv
*** empty log message ***

Revision 1.87  2017/07/12 15:39:25  rvv
*** empty log message ***

Revision 1.86  2017/07/02 12:12:06  rvv
*** empty log message ***

Revision 1.85  2017/05/06 17:28:05  rvv
*** empty log message ***

Revision 1.84  2017/04/08 18:21:06  rvv
*** empty log message ***

Revision 1.83  2017/03/25 15:59:41  rvv
*** empty log message ***

Revision 1.82  2017/03/05 12:06:19  rvv
*** empty log message ***

Revision 1.81  2016/10/26 16:14:22  rvv
*** empty log message ***

Revision 1.80  2016/07/24 09:49:54  rvv
*** empty log message ***

Revision 1.79  2016/07/13 15:41:40  rvv
*** empty log message ***

Revision 1.78  2016/07/03 08:52:49  rvv
*** empty log message ***

Revision 1.77  2016/06/05 12:21:26  rvv
*** empty log message ***

Revision 1.76  2016/05/12 13:21:23  rvv
*** empty log message ***

Revision 1.75  2016/05/11 16:02:54  rvv
*** empty log message ***

Revision 1.74  2016/03/13 16:12:33  rvv
*** empty log message ***

Revision 1.73  2016/02/21 17:22:42  rvv
*** empty log message ***

Revision 1.72  2015/12/27 16:33:52  rvv
*** empty log message ***

Revision 1.71  2015/12/20 16:45:30  rvv
*** empty log message ***

Revision 1.70  2015/12/06 18:05:04  rvv
*** empty log message ***

Revision 1.69  2015/12/05 13:46:44  rvv
*** empty log message ***

Revision 1.68  2015/11/22 14:30:47  rvv
*** empty log message ***

Revision 1.67  2015/11/15 12:23:46  rvv
*** empty log message ***

Revision 1.66  2015/10/18 13:45:43  rvv
*** empty log message ***

Revision 1.65  2015/10/14 16:10:15  rvv
*** empty log message ***

Revision 1.64  2015/10/11 17:32:40  rvv
*** empty log message ***

Revision 1.63  2015/10/07 19:38:13  rvv
*** empty log message ***

Revision 1.62  2015/09/30 07:59:02  rvv
*** empty log message ***

Revision 1.61  2015/06/20 15:33:40  rvv
*** empty log message ***

Revision 1.60  2015/04/04 15:14:38  rvv
*** empty log message ***

Revision 1.59  2015/03/29 07:41:53  rvv
*** empty log message ***

Revision 1.58  2015/01/25 10:07:31  rvv
*** empty log message ***

Revision 1.57  2015/01/24 19:53:08  rvv
*** empty log message ***

Revision 1.56  2014/12/22 19:12:53  rvv
*** empty log message ***

Revision 1.55  2014/12/21 10:32:26  rvv
*** empty log message ***

Revision 1.54  2014/12/17 16:09:04  rvv
*** empty log message ***

Revision 1.53  2014/12/16 14:20:02  rvv
*** empty log message ***

Revision 1.52  2014/12/06 18:12:47  rvv
*** empty log message ***

Revision 1.51  2014/11/30 13:18:31  rvv
*** empty log message ***

Revision 1.50  2014/07/27 11:30:28  rvv
*** empty log message ***

Revision 1.49  2014/03/01 14:01:04  rvv
*** empty log message ***

Revision 1.48  2014/02/22 18:43:07  rvv
*** empty log message ***

Revision 1.47  2014/02/02 10:49:26  rvv
*** empty log message ***

Revision 1.46  2013/10/05 15:57:41  rvv
*** empty log message ***

Revision 1.45  2013/10/02 15:47:44  rvv
*** empty log message ***

Revision 1.44  2013/08/28 16:02:00  rvv
*** empty log message ***

Revision 1.43  2013/08/24 15:48:07  rvv
*** empty log message ***

Revision 1.42  2013/08/18 12:22:31  rvv
*** empty log message ***


*/

include_once("rapportRekenClass.php");
include_once("rapport/Zorgplichtcontrole.php");

class MutatievoorstelFondsen
{
	/*
		PDF en CSV en Order
	*/
	var $selectData;
	var $excelData;
	var $orderData;
	var $extraOrderData;

	function MutatievoorstelFondsen( $selectData )
	{
		$this->selectData = $selectData;
		$this->pdf->excelData = array();

		$this->pdf = new PDFOverzicht('L','mm');
		$this->pdf->rapport_type = "mutatievoorstel";
		$this->pdf->SetAutoPageBreak(true,15);
		$this->pdf->pagebreak = 190;

		$this->pdf->marge = 10;
		$this->pdf->SetLeftMargin($this->pdf->marge);
		$this->pdf->SetRightMargin($this->pdf->marge);
		$this->pdf->SetTopMargin($this->pdf->marge);
		$this->pdf->SetFont("Times","",10);

		$this->pdf->tmdatum = $this->selectData['datumTm'];
		// selectdata ook aan PDF geven
		$this->pdf->selectData = &$this->selectData;
	}

	function formatGetal($waarde, $dec)
	{
		return number_format($waarde,$dec,",",".");
	}
  
  function formatAantal($waarde, $dec, $VierDecimalenZonderNullen=false)
	{
	  if ($VierDecimalenZonderNullen)
	  {
	   $getal = explode('.',$waarde);
	   $decimaalDeel = substr($getal[1],0,6);
	   if ($decimaalDeel != '000000' )
	   {
	     for ($i = strlen($decimaalDeel); $i >=0; $i--)
	     {
         $decimaal = $decimaalDeel[$i-1];
	       if ($decimaal != '0' && !$newDec)
	       {
	         $newDec = $i;
	       }
	     }
	     return number_format($waarde,$newDec,",",".");
	   }
	  else
	   return number_format($waarde,$dec,",",".");
	  }
	  else
	   return number_format($waarde,$dec,",",".");
	}

	function printKop($title)
	{
		$this->pdf->SetFont("Times", "bi", 10);
		$this->pdf->Cell(100 , 4 , $title , 0, 1, "L");
		$this->pdf->SetFont("Times", "", 10);
	}

	function berekenModelPercentage($model, $fonds, $datum)
	{
		global $__appvar;

    $DB = new DB();
		$query="SELECT Fixed FROM ModelPortefeuilles WHERE Portefeuille='".$model."'";
    $DB->SQL($query);
	  $DB->Query();
	  $modelType = $DB->nextRecord(); 
    if($modelType['Fixed']==1)
      $portefeuilleData = berekenFixedModelPortefeuille($model,$datum);
   elseif($modelType['Fixed']==3)
      $portefeuilleData = berekenMeervoudigeModelPortefeuille($this->portefeuille,$datum,$model);
    else
		  $portefeuilleData = berekenPortefeuilleWaardeQuick($model, $datum);
   	vulTijdelijkeTabel($portefeuilleData,$model,$datum);

		// selecteer totaalwaarde portefeuille
		$query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal ".
						 "FROM TijdelijkeRapportage WHERE ".
						 " rapportageDatum ='".$datum."' AND TijdelijkeRapportage.type <> 'rente' AND ".
						 " portefeuille = '".$model."' "
						  .$__appvar['TijdelijkeRapportageMaakUniek'];
		debugSpecial($query,__FILE__,__LINE__);

		$DB = new DB();
		$DB->SQL($query);
		$DB->Query();
		$tdata = $DB->nextRecord();
		$totaalWaarde = $tdata['totaal'];

			// selecteer fondswaarde portefeuille
		$query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal ".
						 "FROM TijdelijkeRapportage WHERE ".
							" type = 'fondsen' AND ".
						 " Fonds = '".$fonds."' AND ".
						 " rapportageDatum ='".$datum."' AND TijdelijkeRapportage.type <> 'rente' AND ".
						 " portefeuille = '".$model."' "
						 .$__appvar['TijdelijkeRapportageMaakUniek'];
		debugSpecial($query,__FILE__,__LINE__);

		$DB2 = new DB();
		$DB2->SQL($query);
		$DB2->Query();
		$fondsWaarde = $DB2->nextRecord();
		$fondsWaarde = $fondsWaarde['totaal'];

		$percentage = ($fondsWaarde / $totaalWaarde) * 100;
		verwijderTijdelijkeTabel($model,$datum);
		return $percentage;
	}

	function writeRapport()
	{
		global $__appvar,$USR;
		$this->pdf->__appvar = $__appvar;
		$einddatum = jul2sql($this->selectData['datumTm']);
    $begindatum = jul2sql($this->selectData['datumVan']);
		// maak array voor modelloop

   
    

    $db = new DB();
$query="SELECT max(Vermogensbeheerders.OrderuitvoerBewaarder) as OrderuitvoerBewaarder, max(Vermogensbeheerders.orderViaConsolidatie) as orderViaConsolidatie FROM
Vermogensbeheerders JOIN VermogensbeheerdersPerGebruiker ON VermogensbeheerdersPerGebruiker.Vermogensbeheerder = Vermogensbeheerders.Vermogensbeheerder
WHERE VermogensbeheerdersPerGebruiker.Gebruiker =  '$USR' ";
$db->SQL($query);
$bewaarder=$db->lookupRecord();
    
  $gekoppeldeModelPortefueilles=array();
  if($this->selectData['skipPortefeuilleSelectie']==true)
  {
    $portefeuilleList = $this->selectData['selectedPortefeuilles'];
  }
  else
  {
    $selectie = new portefeuilleSelectie($this->selectData, $this->orderby);
    $records = $selectie->getRecords();
    $portefeuilles = $selectie->getSelectie();
    $verwijderdePortefeuilles=array();
    foreach($portefeuilles as $portefeuille=>$pData)
    {
      if($this->selectData['filetype']=='order' && $pData['consolidatie']==1 && $db->QRecords("SELECT orderViaConsolidatie FROM Vermogensbeheerders WHERE Vermogensbeheerder='".mysql_real_escape_string($pData['Vermogensbeheerder'])."' AND orderViaConsolidatie=1")==0)
      {
         $verwijderdePortefeuilles[]=$portefeuille;
         unset($portefeuilles[$portefeuille]);
      }
      
      if($pData['ModelPortefeuille']<>''&& !in_array($pData['ModelPortefeuille'],$gekoppeldeModelPortefueilles))
        $gekoppeldeModelPortefueilles[]=$pData['ModelPortefeuille'];
    }
    $portefeuilleList = array_keys($portefeuilles);
    if(count($verwijderdePortefeuilles)>0)
    {
      echo "<script>alert('Geconsolideerde portefeuilles uit selectie verwijderd.');</script>";
      //echo "<script>parent.AEMessage('Geconsolideerde portefeuilles uit selectie verwijderd.', function () {  }); </script>";
      logscherm("Geconsolideerde portefeuilles (".implode(",",$verwijderdePortefeuilles).") verwijderd.");
    }
  }
    
    if(is_array($this->selectData['modelportefeuille']))
    {
      $modelloop=$this->selectData['modelportefeuille'];
    }
    if($this->selectData['modelportefeuille'] == "Allemaal" && $this->selectData['type'] == "Model")
    {
      // select modelportefeuilles
      if(checkAccess())
        $join = "";
      else
        $join = "INNER JOIN VermogensbeheerdersPerGebruiker ON Portefeuilles.Vermogensbeheerder = VermogensbeheerdersPerGebruiker.Vermogensbeheerder ".
          "AND VermogensbeheerdersPerGebruiker.Gebruiker = '".$this->USR."' ";
      
      $DB = new DB();
      $query = "SELECT DISTINCT(Modelportefeuille) AS Portefeuille FROM Portefeuilles ".$join." WHERE Portefeuilles.Modelportefeuille <> '' ORDER BY Modelportefeuille ";
      $DB->SQL($query);
      $DB->Query();
      while($gb = $DB->NextRecord())
      {
        $modelloop[] = $gb['Portefeuille'];
      }
      
    }
    else
    {
      if(!is_array($this->selectData['modelportefeuille']))
        $modelloop[] = $this->selectData['modelportefeuille'];
    }
    
    $newModelLoop=array();
    foreach($modelloop as $modelPortefeuille)
		{
			if(in_array($modelPortefeuille,$gekoppeldeModelPortefueilles))
        $newModelLoop[]=$modelPortefeuille;
		}
		if(count($newModelLoop)>0)
			$modelloop=$newModelLoop;


		if($this->selectData['transactieType']=='switch')
		{
			$this->selectData['berekeningswijze']='Switch';
			$query = "SELECT Fondsen.Fonds, Fondskoersen.Koers , Fondsen.Fondseenheid, Fondsen.ISINCode, Fondsen.Omschrijving FROM Fondskoersen, Fondsen WHERE ".
				" Fondskoersen.Fonds = Fondsen.Fonds AND ".
				" Fondskoersen.Fonds = '".$this->selectData['fonds']."' AND ".
				" Fondskoersen.Datum <='".$einddatum."' ORDER BY Fondskoersen.Datum DESC LIMIT 1";

			$DB2 = new DB();
			$DB2->SQL($query);
			$DB2->Query();
			$verkoopFonds 	= $DB2->nextRecord();
			
			$handelsFonds = $this->selectData['aankoopFonds'];
			$this->pdf->selectData['verkoopFondsDetails'] = $verkoopFonds;
			$this->pdf->selectData['verkoopFonds'] = $verkoopFonds['Fonds'];
			$this->pdf->selectData['aankoopFonds'] = $handelsFonds;
		}
		else
		{
			$handelsFonds=$this->selectData['fonds'];
		}

		for($a=0; $a < count($modelloop); $a++)
		{
			$this->selectData['modelportefeuille'] = $modelloop[$a];

			if($this->selectData['type'] == "Model")
			{
				// haal percentage van Fonds uit model!
				$this->selectData['percentage'] = round($this->berekenModelPercentage($this->selectData['modelportefeuille'], $handelsFonds, $einddatum),2);
      }
			// selecteer koers van fonds op datum uit fonds tabel.
			$query = "SELECT Valutakoersen.Koers FROM Valutakoersen, Fondsen WHERE ".
							 " Fondsen.Fonds  			= '".$handelsFonds."' AND ".
							 " Valutakoersen.Valuta = Fondsen.Valuta AND ".
							 " Valutakoersen.Datum <= '".$einddatum."' ORDER BY Valutakoersen.Datum DESC LIMIT 1 ";

			$DB2 = new DB();
			$DB2->SQL($query);
			$DB2->Query();
			$kdata 	= $DB2->nextRecord();
			$valutakoers = $kdata[Koers];

			if ($this->selectData['newFondsValutaKoers'])
        $valutakoers = $this->selectData['newFondsValutaKoers'];

			// selecteer koers van fonds op datum uit fonds tabel.
			$query = "SELECT Fondskoersen.Koers , Fondsen.Fondseenheid, Fondsen.ISINCode, Fondsen.Omschrijving FROM Fondskoersen, Fondsen WHERE ".
							 " Fondskoersen.Fonds = Fondsen.Fonds AND ".
							 " Fondskoersen.Fonds = '".$handelsFonds."' AND ".
							 " Fondskoersen.Datum <='".$einddatum."' ORDER BY Fondskoersen.Datum DESC LIMIT 1";

			$DB2 = new DB();
			$DB2->SQL($query);
			$DB2->Query();
			$koersWaarde 	= $DB2->nextRecord();

			$this->selectData['fondsOmschrijving'] = $koersWaarde['Omschrijving'];
			$fondseenheid = $koersWaarde['Fondseenheid'];
			$fondsisin = $koersWaarde['ISINCode'];
			$koersWaarde 	= $koersWaarde['Koers'];
			$this->selectData['koersWaarde'] = $koersWaarde;

			if ($this->selectData['newFondsValutaCode'])
			  $fondsValutaCode = ' '.$this->selectData['newFondsValutaCode'];

			if ($this->selectData['newFondsKoers'])
			{
			  $this->selectData['koersWaarde'] = $this->selectData['newFondsKoers'];
			  $koersWaarde = $this->selectData['newFondsKoers'];
			}
			if ($this->selectData['newFonds'])
			{
			  $this->selectData['fonds'] = $this->selectData['newFonds'];
				$handelsFonds=$this->selectData['fonds'];
			  $this->selectData['fondsOmschrijving'] = $this->selectData['newFonds'];
			}
			if ($this->selectData['newFondsEenheid'] > 0)
			  $fondseenheid = $this->selectData['newFondsEenheid'];

			if ($this->selectData['newFondsISIN'])
			  $fondsisin = $this->selectData['newFondsISIN'];

			if ($this->selectData['newFondsValutaKoers'])
			  $valutakoers = $this->selectData['newFondsValutaKoers'];

		  $extraquery=" AND Portefeuilles.Portefeuille IN('".implode("','",$portefeuilleList)."') ";


			if($this->selectData['type'] == "Model")
				$extraquery .= " AND Portefeuilles.ModelPortefeuille = '".$this->selectData['modelportefeuille']."' ";

      if($bewaarder['OrderuitvoerBewaarder']==1 || $bewaarder['orderViaConsolidatie']==1)
      {
        
        $q = "SELECT 
        Portefeuilles.Portefeuille,
        Portefeuilles.Depotbank,
        (SELECT Rekeningen.Depotbank FROM Rekeningen WHERE Rekeningen.Portefeuille=Portefeuilles.Portefeuille AND Rekeningen.afdrukvolgorde <> 0 AND Rekeningen.memoriaal=1 AND Rekeningen.Inactief=0 ORDER BY Rekeningen.afdrukvolgorde limit 1) as VolgordeDepotbank,
        SUM(Rekeningmutaties.aantal) as aantal,
        max(if(Rekeningmutaties.Bewaarder is null,'',Rekeningmutaties.Bewaarder)) as MutatieDepotbank,
        max(Rekeningen.Depotbank) AS RekeningDepotbank
        FROM
        Portefeuilles 
        INNER JOIN Clienten ON Portefeuilles.Client = Clienten.Client
        INNER JOIN Rekeningen ON Portefeuilles.Portefeuille = Rekeningen.Portefeuille
        LEFT JOIN Rekeningmutaties ON Rekeningen.Rekening = Rekeningmutaties.Rekening AND  year(Rekeningmutaties.Boekdatum)='".substr($einddatum,0,4)."' AND 
        Rekeningmutaties.Fonds='".mysql_real_escape_string($this->selectData['fonds'])."' AND Grootboekrekening='FONDS' 
        WHERE 1 $extraquery
        GROUP BY Portefeuilles.Portefeuille,Rekeningmutaties.Bewaarder
        ORDER BY aantal,VolgordeDepotbank";
        $DB2->SQL($q);
			  $DB2->Query();
				$bewaarderPerPortefeuille=array();
        while($pdata 	= $DB2->nextRecord())
        {
          
          if($pdata['MutatieDepotbank'] <> '')
          	$bewaarderRecord=$pdata['MutatieDepotbank'];
          elseif($pdata['VolgordeDepotbank'] <> '')
            $bewaarderRecord=$pdata['VolgordeDepotbank'];
					elseif($pdata['RekeningDepotbank'] <> '')
            $bewaarderRecord=$pdata['RekeningDepotbank'];
					else
            $bewaarderRecord=$pdata['Depotbank'];
  
          $pdata['bewaarder']=$bewaarderRecord;
					
					$bewaarderPerPortefeuille[$pdata['Portefeuille']]=$pdata;
        }
        foreach($bewaarderPerPortefeuille as $portefeuille=>$pdata)
				{
					$extraFilterData[$pdata['bewaarder']][] = $pdata['Portefeuille'];
					$loopdata[$pdata['bewaarder']]['Depotbank'] = $pdata['bewaarder'];
				}
      }
      else
      {
    	  $q = "SELECT 
        Portefeuilles.Portefeuille,
        Portefeuilles.Depotbank
        FROM
        Portefeuilles 
        WHERE 1 $extraquery
        ORDER BY Depotbank";
        $DB2->SQL($q);
			  $DB2->Query();
        while($pdata 	= $DB2->nextRecord())
        {
          $extraFilterData[$pdata['Depotbank']][]=$pdata['Portefeuille'];
          $loopdata[$pdata['Depotbank']]=$pdata;
        }
      }

			// Maak header voor CSV bestand
			if($this->pdf->selectData['transactieType']=='switch')
      {
        $huidige = 'Te verkopen aantal';
        $verkoop = 'Verkoop ';
      }
			else
      {
        $huidige = 'Totale waarde geselecteerd';
        $verkoop='';
      }

			$xlsheader=array("Client",
												"Portefeuille",
												"Accountmanager",
                        'Soort overeenkomst',
                        'Risicoprofiel',
												"Depotbank",
												"Naam",
												"Totale waarde portefeuille",
				                $huidige,
												'Aantal in pos.',
												"Totale waarde liquide middelen",
												"Voldoet aan zorgplicht",
												"Aan te kopen waarde",
												"Aan te kopen aantal",
												"Waarde liq. middelen indien actief",
												'Overige beperkingen',
                        'AFMstandaarddeviatie voor',
                        'AFMstandaarddeviatie na',
                        'Zorgplicht voor',
                        'Zorgplicht na',
				                'Modelportefeuille',
        $verkoop.'ISIN',$verkoop.'Fondsvaluta',$verkoop.'Fonds',$verkoop.'Fonds Omschrijving');
			if($this->pdf->selectData['transactieType']=='switch')
      {
      	$velden=array('ISIN','Fondsvaluta','Fonds','Fonds Omschrijving');
      	foreach($velden as $veld)
          $xlsheader[]='Aankoop '.$veld;
      }


      $this->pdf->excelData[] = $xlsheader;


			foreach($loopdata as $ddata)
			{
				// set 0 waarden
				$totaalAantal = 0;

				// set depotbanknaam voor header
				$this->selectData['depotbank'] = $ddata['Depotbank'];

          if(is_array($extraFilterData[$this->selectData['depotbank']]))
            $extrafilter="AND Portefeuilles.Portefeuille IN('".implode("','",$extraFilterData[$this->selectData['depotbank']])."')";
          else
            $extrafilter='';

				$q = "SELECT Clienten.Naam, ".
				" Portefeuilles.ClientVermogensbeheerder, ".
			  " Portefeuilles.Vermogensbeheerder, ".
				" Portefeuilles.Risicoklasse, ".
				" Portefeuilles.Portefeuille, ".
				" Portefeuilles.Startdatum, ".
				" Portefeuilles.Client, ".
				" Portefeuilles.Depotbank, ".
				" Portefeuilles.Remisier, ".
				" Portefeuilles.Accountmanager, 
          Portefeuilles.Modelportefeuille,".
				" Portefeuilles.Startdatum,
				  Portefeuilles.Risicoklasse,
          Portefeuilles.soortOvereenkomst,
				  CRM_naw.profielOverigeBeperkingen ".
				" FROM (Portefeuilles, Clienten) LEFT JOIN CRM_naw ON Portefeuilles.Portefeuille=CRM_naw.portefeuille ".$join." WHERE ".
  			" Portefeuilles.Client = Clienten.Client ".$extraquery." ".$extrafilter.
				" ORDER BY Depotbank, Portefeuilles.Client ";
 
				$DB = new DB();
				$DB->SQL($q); 
				$DB->Query();

				$records = $DB->records();

				if($this->progressbar)
				{
					$this->progressbar->moveStep(0);
					$pro_step = 0;
					$pro_multiplier = 100 / $records;
				}

				
				$this->pdf->AddPage();
				$this->pdf->SetFont("Times","",10);

				while($portefeuille = $DB->NextRecord())
				{
				  $this->portefeuille=$portefeuille['Portefeuille'];
          
          if($this->selectData['modelportefeuille']<>'')
   			  	$this->selectData['percentage'] = round($this->berekenModelPercentage($this->selectData['modelportefeuille'], $this->selectData['fonds'], $einddatum),10);

				  $crmNaam=getCrmNaam($portefeuille['Portefeuille']);
          if($crmNaam)
          {
            $portefeuille['Naam'] = $crmNaam['naam'];
            $portefeuille['Naam1'] = $crmNaam['naam1'];
          }
          $DB2 = new DB();
          
          $DB2->SQL("SELECT Rekening FROM Rekeningen WHERE Portefeuille = '".$portefeuille['Portefeuille']."' AND Valuta = 'EUR' AND Memoriaal = 0 AND Termijnrekening = 0 AND Inactief=0");
          $rekeningRec = $DB2->lookupRecord();
    
          $query="SELECT Fixed,Beleggingscategorie FROM ModelPortefeuilles WHERE Portefeuille='".$this->selectData['modelportefeuille']."'";
          $DB2->SQL($query);
	    	  $DB2->Query();
	    	  $modelType = $DB2->nextRecord();
          if($modelType['Beleggingscategorie'] <> '')
          {
            $extraCategorieFilter=" AND TijdelijkeRapportage.Beleggingscategorie='".$modelType['Beleggingscategorie']."' ";
  
          }
          
          $query = "SELECT ZorgplichtPerRisicoklasse.Zorgplicht,ZorgplichtPerRisicoklasse.norm FROM
          Fondsen
          JOIN BeleggingscategoriePerFonds ON Fondsen.Fonds = BeleggingscategoriePerFonds.Fonds AND BeleggingscategoriePerFonds.Vermogensbeheerder='".$portefeuille['Vermogensbeheerder']."'
          JOIN ZorgplichtPerBeleggingscategorie ON BeleggingscategoriePerFonds.Beleggingscategorie = ZorgplichtPerBeleggingscategorie.Beleggingscategorie AND ZorgplichtPerBeleggingscategorie.Vermogensbeheerder='".$portefeuille['Vermogensbeheerder']."'
          JOIN ZorgplichtPerRisicoklasse ON ZorgplichtPerBeleggingscategorie.Zorgplicht = ZorgplichtPerRisicoklasse.Zorgplicht AND ZorgplichtPerRisicoklasse.Vermogensbeheerder='".$portefeuille['Vermogensbeheerder']."' AND ZorgplichtPerRisicoklasse.Risicoklasse='".$portefeuille['Risicoklasse']."'
          WHERE Fondsen.Fonds = '".$this->selectData['fonds']."'";

         	$DB2->SQL($query);
		      $DB2->Query();
		      $norm = $DB2->nextRecord();

          if(substr($einddatum,5,5)=='01-01')
            $beginJaar=true;
          else
            $beginJaar=false;
					$portefeuilleData = berekenPortefeuilleWaarde($portefeuille['Portefeuille'], $einddatum,$beginJaar,'EUR',$begindatum,4);

					vulTijdelijkeTabel($portefeuilleData,$portefeuille['Portefeuille'],$einddatum);
          runPreProcessor($portefeuille['Portefeuille']);
  
					// selecteer totaalwaarde portefeuille
					/*
					$query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal ".
									 "FROM TijdelijkeRapportage WHERE ".
									 " rapportageDatum ='".$einddatum."' AND ".
									 " portefeuille = '".$portefeuille['Portefeuille']."' AND TijdelijkeRapportage.type <> 'rente'   "
									 .$__appvar['TijdelijkeRapportageMaakUniek'];
					debugSpecial($query,__FILE__,__LINE__);
					$DB2->SQL($query);
					$DB2->Query();
					$totaalWaarde = $DB2->nextRecord();
					$totaalWaardeZonderUitsluitingen = $totaalWaarde['totaal'];
					*/
          
          $uitsluitingen=bepaalModelUitsluitingen($portefeuille['Portefeuille'],$einddatum);
          $totaalWaardeZonderUitsluitingen=$uitsluitingen['portefwaarde'];

          
          // selecteer totaalwaarde portefeuille
          $query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal ".
            "FROM TijdelijkeRapportage WHERE ".
            " rapportageDatum ='".$einddatum."' AND ".
            " portefeuille = '".$portefeuille['Portefeuille']."' AND TijdelijkeRapportage.type <> 'rente'   "
            .$__appvar['TijdelijkeRapportageMaakUniek'];
          debugSpecial($query,__FILE__,__LINE__);
          $DB2->SQL($query);
          $DB2->Query();
          $totaalWaardeNaUisluitingen = $DB2->nextRecord();
          $totaalWaardeNaUisluitingen = $totaalWaardeNaUisluitingen['totaal'];
          $totaalWaarde=$totaalWaardeNaUisluitingen;
          
          
  					// selecteer fondswaarde portefeuille
					$query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal, max(totaalAantal) as fondsAantal ".
									 "FROM TijdelijkeRapportage WHERE ".
										" type = 'fondsen' AND ".
									 " (Fonds = '".$this->selectData['fonds']."' ) AND ".
									 " rapportageDatum ='".$einddatum."' AND ".
									 " portefeuille = '".$portefeuille['Portefeuille']."' "
									 .$__appvar['TijdelijkeRapportageMaakUniek'];
					debugSpecial($query,__FILE__,__LINE__);

					$DB2 = new DB();
					$DB2->SQL($query);
					$DB2->Query();
					$fondsWaarde = $DB2->nextRecord();
          $fondsAantal = $fondsWaarde['fondsAantal'];
					$fondsWaarde = $fondsWaarde['totaal'];


					if ($this->pdf->selectData['depositoUitsluiten'])
					{
					// selecteer fondswaarde portefeuille
					$query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal ".
									 "FROM
									   TijdelijkeRapportage
									   JOIN Rekeningen on ( TijdelijkeRapportage.rekening = Rekeningen.Rekening AND TijdelijkeRapportage.portefeuille = Rekeningen.portefeuille )
									  WHERE ".
									 " Rekeningen.Deposito = 0 AND TijdelijkeRapportage.type = 'rekening' AND ".
									 " TijdelijkeRapportage.rapportageDatum ='".$einddatum."' AND ".
									 " TijdelijkeRapportage.portefeuille = '".$portefeuille['Portefeuille']."' "
									 .$__appvar['TijdelijkeRapportageMaakUniek'];
					}
					else
					{
					$query = "SELECT SUM(actuelePortefeuilleWaardeEuro) AS totaal ".
									 "FROM
									   TijdelijkeRapportage
									  WHERE ".
									 " TijdelijkeRapportage.type = 'rekening' AND ".
									 " TijdelijkeRapportage.rapportageDatum ='".$einddatum."' AND ".
									 " TijdelijkeRapportage.portefeuille = '".$portefeuille['Portefeuille']."' "
									 .$__appvar['TijdelijkeRapportageMaakUniek'];
				  }
				  debugSpecial($query,__FILE__,__LINE__);
					//	echo $query; exit;

					$DB2 = new DB();
					$DB2->SQL($query);
					$DB2->Query();
					$liqWaarde = $DB2->nextRecord();
					$liqWaarde = $liqWaarde['totaal'];


					// selecteer belegingscategorie
					$query="SELECT
	BeleggingscategoriePerFonds.Beleggingscategorie,Fondsen.ISINCode,Fondsen.Valuta,Fondsen.Omschrijving as FondsOmschrijving,Fondsen.Fonds
  FROM
	Portefeuilles
  JOIN BeleggingscategoriePerFonds ON Portefeuilles.Vermogensbeheerder = BeleggingscategoriePerFonds.Vermogensbeheerder AND BeleggingscategoriePerFonds.Fonds = '".mysql_real_escape_string($this->selectData['fonds'])."'
  JOIN Fondsen ON Fondsen.Fonds=BeleggingscategoriePerFonds.Fonds AND Fondsen.Fonds = '".mysql_real_escape_string($this->selectData['fonds'])."'
  WHERE
	Portefeuilles.Portefeuille = '".$portefeuille['Portefeuille']."'";

					$DB2 = new DB();
					$DB2->SQL($query);
					$DB2->Query();
					$fondsdata = $DB2->nextRecord();
     
					if($this->selectData['aankoopFonds']<>'')
          {
            $query = "SELECT
	BeleggingscategoriePerFonds.Beleggingscategorie,Fondsen.ISINCode,Fondsen.Valuta,Fondsen.Omschrijving as FondsOmschrijving,Fondsen.Fonds
  FROM
	Portefeuilles
  JOIN BeleggingscategoriePerFonds ON Portefeuilles.Vermogensbeheerder = BeleggingscategoriePerFonds.Vermogensbeheerder AND BeleggingscategoriePerFonds.Fonds = '" . mysql_real_escape_string($this->selectData['aankoopFonds']) . "'
  JOIN Fondsen ON Fondsen.Fonds=BeleggingscategoriePerFonds.Fonds AND Fondsen.Fonds = '" . mysql_real_escape_string($this->selectData['aankoopFonds']) . "'
  WHERE
	Portefeuilles.Portefeuille = '" . $portefeuille['Portefeuille'] . "'";
            $DB2->SQL($query);
            $DB2->Query();
            $fondsdataAankoop = $DB2->nextRecord();
            //listarray($fondsdataAankoop);
          }
          
					$categorie = $fondsdata['Beleggingscategorie'];

					// selecteer beleggingscategorie waarde
					$query = "SELECT SUM(TijdelijkeRapportage.actuelePortefeuilleWaardeEuro) AS totaal ".
									 "FROM TijdelijkeRapportage WHERE ".
									 " TijdelijkeRapportage.beleggingscategorie  = '".$categorie."' AND ".
									 " TijdelijkeRapportage.type = 'fondsen' AND ".
									 " TijdelijkeRapportage.rapportageDatum ='".$einddatum."' AND ".
									 " TijdelijkeRapportage.portefeuille = '".$portefeuille['Portefeuille']."' "
									 .$__appvar['TijdelijkeRapportageMaakUniek'];
					debugSpecial($query,__FILE__,__LINE__);

					$DB2 = new DB();
					$DB2->SQL($query);
					$DB2->Query();
					$categorieWaarde = $DB2->nextRecord();
					$categorieWaarde = $categorieWaarde['totaal'];

					$totaalRekenwaarde = $totaalWaarde;
					switch($this->selectData['berekeningswijze'])
					{
						case "Totaal vermogen" :
							$totaalRekenwaarde = $totaalWaarde;
						break;
						case "Totaal belegd vermogen" :
							$totaalRekenwaarde = $totaalWaarde - $liqWaarde;
						break;
						case "Belegd vermogen per beleggingscategorie" :
             	$totaalRekenwaarde = $categorieWaarde;
						break;
					}
          
           if($this->selectData['berekeningswijzeViaNorm']==1 && $norm['norm'] <> '')
           {
             $aankoopWaarde 	= $totaalRekenwaarde*($norm['norm']/100) * ($this->selectData['percentage'] / 100) - $fondsWaarde;
           }
					 elseif($this->selectData['berekeningswijzeViaBedrag']==true && $this->selectData['bedrag'] <> '')
					 {
						 $aankoopWaarde = $this->selectData['bedrag'];
					 }
           else
           {
             $aankoopWaarde 	= $totaalRekenwaarde * ($this->selectData['percentage'] / 100) - $fondsWaarde;
						// echo " $aankoopWaarde 	= $totaalRekenwaarde * (".$this->selectData['percentage']." / 100) - $fondsWaarde";
           }
           $afwijkingsbedrag=$aankoopWaarde;

					// uitrekenen wat het percentage moet zijn
					

					// uitrekenen hoeveel er gekocht moet worden.

				//	$handelsFonds
//					if($this->pdf->selectData['transactieType']=='switch')


					$aankoopStuks 	= (($aankoopWaarde / ($koersWaarde * $valutakoers)) /$fondseenheid);
					//logscherm("$aankoopStuks 	= (($aankoopWaarde / ($koersWaarde * $valutakoers)) /$fondseenheid)");



					if($this->pdf->selectData['transactieType']=='switch')
					{
    			  if($fondseenheid == '0.01')
						{
							if($aankoopStuks > 0)
								$aankoopStuks=floor($aankoopStuks/100)*100;
  						else
								$aankoopStuks=ceil($aankoopStuks/100)*100;
						}

            $aankoopStuks=round($aankoopStuks*-1);
            $aankoopWaarde=($aankoopStuks * $koersWaarde * $valutakoers * $fondseenheid);
						$verkoopWaarde=$aankoopWaarde*-1;
						$verkoopStuks=$fondsAantal;
            
            
            $query = "SELECT Fonds, max(totaalAantal) as fondsAantal ".
              "FROM TijdelijkeRapportage WHERE ".
              " type = 'fondsen' AND ".
              " Fonds IN ('".mysql_real_escape_string($this->pdf->selectData['verkoopFonds'])."','".mysql_real_escape_string($this->pdf->selectData['aankoopFonds'])."') AND ".
              " rapportageDatum ='".$einddatum."' AND ".
              " portefeuille = '".$portefeuille['Portefeuille']."' "
              .$__appvar['TijdelijkeRapportageMaakUniek']." GROUP BY Fonds";
            $DB2->SQL($query);
            $DB2->Query();
            while($switchData=$DB2->nextRecord())
            {
              $switchAanezigeAantal[$switchData['Fonds']] = $switchData['fondsAantal'];
            }
						//logscherm("aankoop: $aankoopStuks 	= (($aankoopWaarde / ($koersWaarde * $valutakoers)) /$fondseenheid); ");
						//logscherm($portefeuille['Portefeuille']." | ".$this->selectData['fonds']." -> $handelsFonds | $verkoopStuks | $aankoopStuks ");

					}
          elseif(round($this->selectData['percentage'],1)==0)
          {
						if($this->selectData['berekeningswijzeViaBedrag']==false)
              $aankoopStuks=$fondsAantal*-1;
          }
          else
          {
    			  if($fondseenheid == '0.01')
		        {
              if($aankoopStuks > 0)
		            $aankoopStuks=floor($aankoopStuks/100)*100;
              else
                $aankoopStuks=ceil($aankoopStuks/100)*100; 
		        }
            
            $aankoopStuks=round($aankoopStuks);
            //$aankoopWaarde=round($aankoopWaarde);
            
            $aankoopWaarde=($aankoopStuks * $koersWaarde * $valutakoers * $fondseenheid);
            //echo "  $aankoopWaarde=($aankoopStuks * $koersWaarde * $valutakoers * ".$fondseenheid.");";
          }

					if($this->selectData['afronding'] <>1 && $this->selectData['afronding']<>'')
						$aankoopStuks  = round(($aankoopStuks / $this->selectData['afronding']),0) * $this->selectData['afronding']  ;


					if(($negatief = ($liqWaarde - (($aankoopStuks*$fondseenheid) * ($koersWaarde * $valutakoers)))) > 0)
					{
						$negatief = "";
						$negatief_csv = "";
					}
					else
					{
						$negatief_csv = round($negatief,2);
						$negatief = $this->formatGetal($negatief,2);
					}
          
          $afmVoor=AFMstd($portefeuille['Portefeuille'],$einddatum);

          $zorgplicht = new Zorgplichtcontrole();
					$zpwaarde=$zorgplicht->zorgplichtMeting($portefeuille,$einddatum);
          $zpPercVoor=0;
          $selectedCat='';
          foreach($zpwaarde['detail'] as $cat=>$fondsen)
          {
            if(isset($fondsen[$this->selectData['fonds']]))
            {
              $selectedCat=$cat;
            }
          }
					if($selectedCat=='')
					{
						$query="SELECT
ZorgplichtPerBeleggingscategorie.Zorgplicht FROM ZorgplichtPerBeleggingscategorie
INNER JOIN BeleggingscategoriePerFonds ON ZorgplichtPerBeleggingscategorie.Vermogensbeheerder = BeleggingscategoriePerFonds.Vermogensbeheerder AND ZorgplichtPerBeleggingscategorie.Beleggingscategorie = BeleggingscategoriePerFonds.Beleggingscategorie
WHERE BeleggingscategoriePerFonds.Vermogensbeheerder='".$portefeuille['Vermogensbeheerder']."' AND BeleggingscategoriePerFonds.Fonds='".mysql_real_escape_string($this->selectData['fonds'])."'";
						$DB2->SQL($query);
						$DB2->Query();
						$tmp=$DB2->lookupRecord();
						$selectedCat=$tmp['Zorgplicht'];
					}

          foreach($zpwaarde['conclusie'] as $cat=>$velden)
          {
            if($velden[0]==$selectedCat)
            {
              $zpPercVoor=str_replace(',','.',$velden[2]);
            }
          }

          $geenNieuweAfm=false;
			//		if($this->pdf->selectData['transactieType']=='switch1')

				  	// voer fictieve transactie uit op de tijdelijke rapportage ivm zorgplicht berekening.
				  	$query="SELECT id FROM TijdelijkeRapportage WHERE TijdelijkeRapportage.type = 'fondsen' AND ".
									 " TijdelijkeRapportage.rapportageDatum ='".$einddatum."' AND ".
									 " TijdelijkeRapportage.portefeuille = '".$portefeuille['Portefeuille']."'  AND ".
									 " TijdelijkeRapportage.Fonds = '".$this->selectData['fonds']."' ".$__appvar['TijdelijkeRapportageMaakUniek'];
					  $DB2->SQL($query);
				  	$DB2->Query();

            if($DB2->records() > 0)
            {
              $query="UPDATE TijdelijkeRapportage SET actuelePortefeuilleWaardeEuro=actuelePortefeuilleWaardeEuro+$aankoopWaarde
					          WHERE TijdelijkeRapportage.type = 'fondsen' AND ".
									 " TijdelijkeRapportage.rapportageDatum ='".$einddatum."' AND ".
									 " TijdelijkeRapportage.portefeuille = '".$portefeuille['Portefeuille']."'  AND ".
									 " TijdelijkeRapportage.Fonds = '".$this->selectData['fonds']."' ".$__appvar['TijdelijkeRapportageMaakUniek'];
            }
            else
            {

              $query="SELECT Fonds,Beleggingscategorie,afmCategorie FROM BeleggingscategoriePerFonds WHERE Vermogensbeheerder='".$portefeuille['Vermogensbeheerder']."' AND Fonds = '".mysql_real_escape_string($this->selectData['fonds'])."' ";
              $DB2->SQL($query);
    		      $Beleggingscategorie=$DB2->lookupRecord();
              $afmCategorie=$Beleggingscategorie['afmCategorie'];
    		      $Beleggingscategorie=$Beleggingscategorie['Beleggingscategorie'];
              if($afmCategorie=='')
                $geenNieuweAfm=true;

    		      $query="INSERT INTO TijdelijkeRapportage SET actuelePortefeuilleWaardeEuro='$aankoopWaarde', add_user='$USR', TijdelijkeRapportage.sessionId = '".$_SESSION['usersession']['sessionId']."',
                    TijdelijkeRapportage.type = 'fondsen', Beleggingscategorie='$Beleggingscategorie', afmCategorie='$afmCategorie',
                    rapportageDatum ='".$einddatum."',
                    portefeuille = '".$portefeuille['Portefeuille']."',
                    Fonds='".$this->selectData['fonds']."',
                    fondsOmschrijving='".$this->selectData['fonds']."' ";
                    
            }

				  	$DB2->SQL($query);
				  	$DB2->Query();
            $query="UPDATE TijdelijkeRapportage SET actuelePortefeuilleWaardeEuro=actuelePortefeuilleWaardeEuro-$aankoopWaarde
					          WHERE TijdelijkeRapportage.type = 'Rekening' AND ".
									 " TijdelijkeRapportage.rapportageDatum ='".$einddatum."' AND ".
									 " TijdelijkeRapportage.portefeuille = '".$portefeuille['Portefeuille']."' ".$__appvar['TijdelijkeRapportageMaakUniek']." LIMIT 1 ";
					  $DB2->SQL($query);
					  $DB2->Query();


					$zorgplicht = new Zorgplichtcontrole();
					$zpwaarde=$zorgplicht->zorgplichtMeting($portefeuille,$einddatum);
          $zpPercNa=0;
          $selectedCat='';
          foreach($zpwaarde['detail'] as $cat=>$fondsen)
          {
            if(isset($fondsen[$this->selectData['fonds']]))
            {
              $selectedCat=$cat;
            }
          }
					if($selectedCat=='')
					{
						$query="SELECT
ZorgplichtPerBeleggingscategorie.Zorgplicht FROM ZorgplichtPerBeleggingscategorie
INNER JOIN BeleggingscategoriePerFonds ON ZorgplichtPerBeleggingscategorie.Vermogensbeheerder = BeleggingscategoriePerFonds.Vermogensbeheerder AND ZorgplichtPerBeleggingscategorie.Beleggingscategorie = BeleggingscategoriePerFonds.Beleggingscategorie
WHERE BeleggingscategoriePerFonds.Vermogensbeheerder='".$portefeuille['Vermogensbeheerder']."' AND BeleggingscategoriePerFonds.Fonds='".mysql_real_escape_string($this->selectData['fonds'])."'";
						$DB2->SQL($query);
						$DB2->Query();
						$tmp=$DB2->lookupRecord();
						$selectedCat=$tmp['Zorgplicht'];
					}
          foreach($zpwaarde['conclusie'] as $cat=>$velden)
          {
            if($velden[0]==$selectedCat)
            {
              $zpPercNa=str_replace(',','.',$velden[2]);
            }
          }
          //conclusie

					if($this->pdf->selectData['transactieType']=='switch')
					{
						$huidigeTxt=$this->formatAantal($verkoopStuks,0,true);
						$huidigeXls=$verkoopStuks;
					}
					else
					{
						$huidigeTxt=$this->formatGetal($fondsWaarde,2);
						$huidigeXls=round($fondsWaarde,2);
					}

					if($this->selectData['transactieType']=='switch')
					{
						$this->selectData['nulUitlsuiten']=1;
					}
					//
					$afm=array();
					if($aankoopStuks <> 0 || $this->selectData['nulUitlsuiten']==0)
					{
					 if($portefeuille['RestTijdelijk'] <> '' || $portefeuille['profielOverigeBeperkingen'] <> '')
             $restTijdelijk='X';
           else
             $restTijdelijk='';  
					$data = array($portefeuille['Client'],
												$portefeuille['Portefeuille'],
												substr($portefeuille['Naam'],0,40),
												$this->formatGetal($totaalRekenwaarde,2),
												$huidigeTxt,
												$this->formatGetal($liqWaarde,2),
												$zpwaarde['voldoet'],
												$this->formatGetal($aankoopWaarde,2),
												$this->formatAantal($aankoopStuks,0,true),
												$negatief,
                        $restTijdelijk );
                        
          $afm=AFMstd($portefeuille['Portefeuille'],$einddatum);
          if($geenNieuweAfm==true)
            $afmNa='NB';
          else
            $afmNa=round($afm['std'],2);

          $xlsRow=array($portefeuille['Client'],
												$portefeuille['Portefeuille'],
												$portefeuille['Accountmanager'],
                        $portefeuille['soortOvereenkomst'],
                        $portefeuille['Risicoklasse'],
												$portefeuille['Depotbank'],
												$portefeuille['Naam'],
												round($totaalRekenwaarde,2),
						            $huidigeXls,
                        $fondsAantal,
												round($liqWaarde,2),
												$zpwaarde['voldoet'],
												round($aankoopWaarde,2),
												round($aankoopStuks,6),
												$negatief_csv,
												$portefeuille['profielOverigeBeperkingen'],
                        round($afmVoor['std'],2),
                        $afmNa,
                        round($zpPercVoor,2),
                        round($zpPercNa,2),
						            $portefeuille['Modelportefeuille'],
						            $fondsdata['ISINCode'],
						            $fondsdata['Valuta'],
						            $fondsdata['Fonds'],
						            $fondsdata['FondsOmschrijving']);
          
      if($this->pdf->selectData['transactieType']=='switch')
      {
      	$velden=array('ISINCode','Valuta','Fonds','FondsOmschrijving');
      	foreach($velden as $veld)
          $xlsRow[]=$fondsdataAankoop[$veld];
      }
				   $this->pdf->excelData[] = $xlsRow;
 					 $this->pdf->Row($data);
           if(count($uitsluitingen['portefeuilleRegels']) >0)
           {
             foreach ($uitsluitingen['portefeuilleRegels'] as $regel)
             {
               $this->pdf->Row(array('', '', $regel[0]));
             }
             unset($uitsluitingen['portefeuilleRegels']);
           }
					 $totaalAantal += $aankoopStuks;                       
          }
					// ISIN + aantal
					if($aankoopStuks <> 0)
					{
					 
            if($bewaarder['OrderuitvoerBewaarder']==1)
            {
              $query="SELECT  SUM(Rekeningmutaties.aantal) as aantal,
        max(if(Rekeningmutaties.Bewaarder is null,'',Rekeningmutaties.Bewaarder)) as Bewaarder,
        max(Rekeningen.Depotbank) as RekeningDepotbank
                FROM Rekeningen 
                INNER JOIN Rekeningmutaties ON Rekeningen.Rekening = Rekeningmutaties.Rekening
                WHERE  YEAR(Rekeningmutaties.Boekdatum)='".substr($einddatum,0,4)."' AND 
                Rekeningen.Portefeuille='".$portefeuille['Portefeuille']."' AND(Rekeningmutaties.Grootboekrekening = 'FONDS' OR (Rekeningmutaties.Grootboekrekening = 'KRUIS'  AND Rekeningmutaties.Fonds <> '')) AND
                Rekeningmutaties.Fonds='".mysql_real_escape_string($this->selectData['fonds'])."'
                GROUP BY Bewaarder
                ORDER BY aantal desc";
        		  $DB2->SQL($query);
				      $DB2->Query();
              $tmp=$DB2->nextRecord();

              if($tmp['Bewaarder']=='' && $tmp['RekeningDepotbank']=='')
              {
                if($this->selectData['orderDepotbank'] <> '')
                {
                  $depotbank = $this->selectData['orderDepotbank'];
                  $aantalInPositie=$tmp['aantal'];
                }
                else
                  $depotbank='NB';
              }
              else
              {
              	if($tmp['Bewaarder'] <> '')
                  $depotbank = $tmp['Bewaarder'];
              	elseif($tmp['RekeningDepotbank'] <> '')
                  $depotbank = $tmp['RekeningDepotbank'];
              	else
                  $depotbank = $ddata['Depotbank'];
                $aantalInPositie=$fondsAantal;
              }
            }
            else
            {
              $depotbank = $ddata['Depotbank'];
              $aantalInPositie=$fondsAantal;
            }
            $this->selectData['depotbank'] = $depotbank;


						if($this->pdf->selectData['transactieType']=='switch')
						{
							$percentagePortefeuille=$fondsWaarde/$totaalWaarde*100;
							$percentageGewenst=($aankoopWaarde)/$totaalWaarde*100;
							$this->extraOrderData[] = array('afmStdevVoor'=>$afmVoor['std'],'afmStdevNa'=>$afm['std'],'externeBatchId'=>$this->selectData['externeBatchId'],'aantalInPositie'=> $switchAanezigeAantal[$handelsFonds],'nieuwAantal'=>$switchAanezigeAantal[$handelsFonds]+$aankoopStuks);
							$this->extraOrderData[] = array('afmStdevVoor'=>$afmVoor['std'],'afmStdevNa'=>$afm['std'],'externeBatchId'=>$this->selectData['externeBatchId'],'aantalInPositie'=>$switchAanezigeAantal[$verkoopFonds['Fonds']],'nieuwAantal'=>$switchAanezigeAantal[$verkoopFonds['Fonds']]-$verkoopStuks);
							$this->orderData[] = array($handelsFonds,$fondsisin,$portefeuille['Portefeuille'],round($aankoopStuks,6),round($koersWaarde,2),$portefeuille['Client'],$this->selectData['fondsOmschrijving'],$depotbank,$aankoopWaarde,0,$percentageGewenst,$categorie);
							$this->orderData[] = array($verkoopFonds['Fonds'],$verkoopFonds['ISINCode'],$portefeuille['Portefeuille'],round($verkoopStuks*-1,6),round($verkoopFonds['Koers'],2),$portefeuille['Client'],$verkoopFonds['Omschrijving'],$depotbank,$verkoopWaarde,$percentagePortefeuille,0,$categorie);
						}
						else
						{
							$percentagePortefeuille=$fondsWaarde/$totaalWaarde*100;
							$percentageGewenst=($fondsWaarde+$aankoopWaarde)/$totaalWaarde*100;

							$this->extraOrderData[] = array('afmStdevVoor'=>$afmVoor['std'],'afmStdevNa'=>$afm['std'],'externeBatchId'=>$this->selectData['externeBatchId'],'afwijkingsbedrag'=>$afwijkingsbedrag,'aantalInPositie'=>$aantalInPositie,'nieuwAantal'=>$aantalInPositie+$aankoopStuks);
							$this->orderData[] = array($this->selectData['fonds'],
								$fondsisin,
								$portefeuille['Portefeuille'],
								round($aankoopStuks,6),
								round($koersWaarde,2),
								$portefeuille['Client'],
								$this->selectData['fondsOmschrijving'],
								$depotbank,
								$aankoopWaarde,
								$percentagePortefeuille,
								$percentageGewenst,
								$categorie
              );
						}


					}
					// verwijder Data van tijdelijke tabel
					verwijderTijdelijkeTabel($portefeuille['Portefeuille'],$einddatum);
					if($this->progressbar)
					{
						$pro_step += $pro_multiplier;
						$this->progressbar->moveStep($pro_step);
					}
				}

				if($this->pdf->GetY() > 140)
					$this->pdf->AddPage();

				// druk totaal af.
				$this->pdf->ln();

				$this->pdf->Cell(202, 4 , "", 0, 0, "L");
				$this->pdf->SetFont("Times","b",10);
				$this->pdf->Cell(22 , 4 , "Totaal aantal:" , 0, 0, "R");
				$this->pdf->SetFont("Times","",10);
				$this->pdf->Cell(18 , 4 , $this->formatAantal($totaalAantal,0,true) , 0, 0, "R");
				$this->pdf->Cell(25 , 4 , "" , 0, 1, "R");

				$this->pdf->ln();

				$this->pdf->Cell(202 , 4 , "" , 0, 0, "L");
				$this->pdf->Cell(22 , 4 , "Koers:" , 0, 0, "R");
				$this->pdf->Cell(18 , 4 , $this->formatGetal($koersWaarde,2) , 0, 0, "R");
				$this->pdf->Cell(25 , 4 , "" , 0, 1, "R");

				$this->pdf->Cell(202 , 4 , "" , 0, 0, "L");
				$this->pdf->Cell(22 , 4 , "Valutakoers$fondsValutaCode:" , 0, 0, "R");
				$this->pdf->Cell(18 , 4 , $this->formatGetal($valutakoers,2) , 0, 0, "R");
				$this->pdf->Cell(25 , 4 , "" , 0, 1, "R");

				$this->pdf->Cell(202 , 4 , "" , 0, 0, "L");
				$this->pdf->Cell(22 , 4 , "Factor:" , 0, 0, "R");
				$this->pdf->Cell(18 , 4 , $this->formatGetal($fondseenheid,2) , 0, 0, "R");
				$this->pdf->Cell(25 , 4 , "" , 0, 1, "R");

				$this->pdf->ln();
				$this->pdf->Cell(202 , 4 , "" , 0, 0, "L");
				$this->pdf->SetFont("Times","b",10);
				$this->pdf->Cell(22 , 4 , "Totale in te kopen waarde:" , 0, 0, "R");
				$this->pdf->SetFont("Times","",10);
				$this->pdf->Cell(18 , 4 , $this->formatGetal(($totaalAantal * ($koersWaarde * $fondseenheid) * $valutakoers),0) , 0, 0, "R");
				$this->pdf->Cell(25 , 4 , "" , 0, 1, "R");
			}

			$totaalAantal = 0;
			$koersWaarde = 0;
			$valutakoers = 0;
			$fondseenheid = 0;

		}

		if($this->progressbar)
			$this->progressbar->hide();
     
	}


	function OutputOrder()
	{
	 global $USR;
		/*
				$this->orderData[] = array($this->selectData[fonds],
											$fondsisin,
											$portefeuille[Portefeuille],
											round($aankoopStuks,2)
											);
											*/
   $ordermoduleAccess=GetModuleAccess("ORDER");
   if($ordermoduleAccess==2)
   {
     include_once('orderControlleRekenClassV2.php');
     $ordercheck=new orderControlleBerekeningV2(true);
		 $fix = new AE_FIXtransport();
     $insertedIds=array();
		 $orderlog = new orderLogs();
     for($t=0; $t < count($this->orderData); $t++)
		 {
		   $db=new DB();
        
       $extraData=$ordercheck->getPortefeuilleOpties($this->orderData[$t][2],$this->orderData[$t][0],$this->orderData[$t][7]);
       $extraData['transactieSoort']=$ordercheck->getTransactieSoort($this->orderData[$t][2],$this->orderData[$t][0],$this->orderData[$t][3],$this->pdf->tmdatum);

       foreach($extraData as $key=>$value)
       {
         if($value=='' && $key<>'Rekening')
           logScherm('Ordercontrole '.$this->orderData[$t][2].' Veld '.$key.' is leeg?');
       }
			 $query="SELECT id,OptieType,OptieExpDatum,OptieUitoefenPrijs,optieCode,fondssoort,Fondseenheid FROM Fondsen WHERE fonds='".mysql_escape_string($this->orderData[$t][0])."'";
			 $db->SQL($query);
			 $db->Query();
			 if($db->records() > 0)
			 {
				 $extraFondsData=$db->nextRecord();
				 $fonds = $this->orderData[$t][0];
			 }
			 else
			 {
				 $fonds = "";
				 $extraFondsData['Fondseenheid']= $this->selectData['newFondsEenheid'];
         $extraData['fondsValuta']= $this->selectData['newFondsValutaCode'];
			 }
			 $orderregel['fondsBankcode']=$fix->getFondscode($extraData['Depotbank'], $fonds);
       $orderregel['beurs']=$fix->getBeurs($extraData['Depotbank'], $fonds);
//listarray($extraData);exit;

       $query ="INSERT INTO TijdelijkeBulkOrdersV2 SET add_user='$USR',change_user='$USR',add_date=NOW(),change_date=NOW(),".
               " bron = 'mutatievoorstelFondsen', ".
               " fonds = '".mysql_escape_string($fonds)."', ".
			 	       " fondsOmschrijving = '".mysql_escape_string($this->orderData[$t][6])."', ".
							 " ISINCode = '".$this->orderData[$t][1]."', ".
							 " portefeuille = '".$this->orderData[$t][2]."', ".
               " accountmanager = '".$extraData['accountmanager']."', ".
							 " client = '".mysql_escape_string($this->orderData[$t][5])."', ".
							 " aantal = '".abs($this->orderData[$t][3])."', ".
               " Rekening = '".$extraData['Rekening']."', ".
               " transactieSoort = '".$extraData['transactieSoort']."', ".
               " fondsValuta = '".$extraData['fondsValuta']."', ".
               " portefeuillePercentage = '".$this->orderData[$t][9]."', ".
				 " modelPercentage = '".$this->orderData[$t][10]."', ".
         " afwijking = '".($this->orderData[$t][10]-$this->orderData[$t][9])."', ".
				 " Beleggingscategorie = '".$this->orderData[$t][11]."', ".
               " koers ='".$this->orderData[$t][4]."', ".
							 " orderbedrag = '".($this->orderData[$t][8]*-1)."', ".
				 " afmStdevVoor = '".$this->extraOrderData[$t]['afmStdevVoor']."', ".
				 " afmStdevNa = '".$this->extraOrderData[$t]['afmStdevNa']."', ".
         " externeBatchId = '".$this->extraOrderData[$t]['externeBatchId']."', ".
         " afwijkingsbedrag = '".$this->extraOrderData[$t]['afwijkingsbedrag']."', ".
				 //" fondsValuta= '".mysql_escape_string($extraFondsData['Valuta'])."', ".
         " aantalInPositie = '".$this->extraOrderData[$t]['aantalInPositie']."', ".
			   " nieuwAantal = '".$this->extraOrderData[$t]['nieuwAantal']."', ".
				 " fondseenheid= '".mysql_escape_string($extraFondsData['Fondseenheid'])."', ".
				 " fondssoort= '".mysql_escape_string($extraFondsData['fondssoort'])."', ".
				 " optieSymbool= '".mysql_escape_string($extraFondsData['optieCode'])."', ".
				 " optieType= '".mysql_escape_string($extraFondsData['OptieType'])."', ".
				 " optieUitoefenprijs= '".mysql_escape_string($extraFondsData['OptieUitoefenPrijs'])."', ".
				 " optieExpDatum= '".mysql_escape_string($extraFondsData['OptieExpDatum'])."', ".
				 " fondsBankcode= '".mysql_escape_string($orderregel['fondsBankcode'])."', ".
         " beurs= '".mysql_escape_string($orderregel['beurs'])."', ".
							 " depotbank = '".$extraData['Depotbank']."' ";
       $db->SQL($query);
			 $db->Query();
       $lastId=$db->last_id();
			 $insertedIds[]=$lastId;
			 $orderlog->addToBulkLog($lastId,"Portefeuille ".$this->orderData[$t][2]." aangemaakt via Mutatievoorstel fondsen");

			 global $__appvar;
			 if(isset($__appvar['extraOrderLogging']))
				 $extraLog=$__appvar['extraOrderLogging'];
			 else
				 $extraLog=false;
			 if($extraLog)
				 logIt("Portefeuille ".$this->orderData[$t][2]." fonds:".$fonds." aantal:".abs($this->orderData[$t][3])." aangemaakt via Mutatievoorstel");

		 }
     
     if($_POST['extra']=='validatieUitvoeren')
     { 
       if($this->progressbar)
       {
      	 $this->progressbar->moveStep(0);
		  	 $pro_step = 0;
		  	 $pro_multiplier = 100 / count($insertedIds);
         $this->progressbar->show();
       }
       foreach($insertedIds as $id)
       { 
         if($this->progressbar)
			   {
			     $pro_step += $pro_multiplier;
			     $this->progressbar->moveStep($pro_step);
			   }
         $ordercheck->updateChecksByBulkorderregelId($id);
         logScherm('Ordercontrole '.$id. " (".round($pro_step,1)."%)");
       }
     }
     return array('versie'=>'V2','aantal'=>count($this->orderData),'message'=>count($this->orderData)." orderregels aangemaakt in de tijdelijke orderregel tabel.");
   }
   else
   {
		$table = "CREATE TABLE `tmpOrder` ( ".
						"`id` int(11) NOT NULL auto_increment, ".
						"`tmpOrdernr` int(11) NOT NULL default '0', ".
						"`Fonds` varchar(25) NOT NULL default '', ".
						"`FondsOmschrijving` varchar(50) NOT NULL default '', ".
						"`ISINCode` varchar(26) NOT NULL default '', ".
						"`Portefeuille` varchar(24) NOT NULL default '', ".
						"`ClientNaam` varchar(60) NOT NULL default '', ".
						"`Aantal` double NOT NULL default '0.00', ".
						"`AankoopWaarde` double NOT NULL default '0.00',
						 `Depotbank` varchar(10) NOT NULL default '',".
						"`add_user` varchar(10) NOT NULL default '', ".
						"`add_date` datetime NOT NULL default '0000-00-00 00:00:00', ".
						"`change_user` varchar(10) NOT NULL default '', ".
						"`change_date` datetime NOT NULL default '0000-00-00 00:00:00', ".
						" PRIMARY KEY  (`id`) ".
						")";

		$db = new DB;
		$query = "show tables like 'tmpOrder'";

		$db->SQL($query);
		if ($db->lookupRecord())
		{
		  $db->SQL('DROP table tmpOrder');
			$db->Query();	  
			$db->SQL($table);
			$db->Query();
		}

		$tmpOrdernr = mktime();
		$t=0;
		for($t=0; $t < count($this->orderData); $t++)
		{
		  /*
      		 `id` int(11) NOT NULL auto_increment,
 			   `fonds` varchar(25) NOT NULL default '',
 			   `portefeuille` varchar(24) NOT NULL default '',
         `depotbank` varchar(10) NOT NULL default '',
         `rekening` varchar(25) NOT NULL default '',
         `orderbedrag` double(16,2) NOT NULL default '0.00',
  			 `modelPercentage` double(8,4) NOT NULL,
  			 `portefeuillePercentage` double(8,4) NOT NULL,
  			 `afwijking` double(8,4) NOT NULL,
  			 `valuta` varchar(6) NOT NULL default '',
  		   `kopen` double(12,4) NOT NULL default '0.0000',
  			 `verkopen` double(12,4) NOT NULL default '0.0000',
  			 `modelWaarde` double(16,2) NOT NULL default '0.00',
 			   `koers` double(12,4) NOT NULL default '0.0000',
 			   `add_date` datetime NOT NULL default '0000-00-00 00:00:00',
 			   `add_user` varchar(10) NOT NULL default '',
         
		  $query="INSERT INTO TijdelijkeOrderRegels SET add_user='$USR',change_user='$USR',add_date=NOW(),change_date=NOW(),
      fonds='".mysql_escape_string($this->orderData[$t][0])."',
      portefeuille='".$this->orderData[$t][2]."',
      depotbank='".$this->orderData[$t][7]."',
      rekening='',
      orderbedrag='".$this->orderData[$t][4]."',
      modelPercentage='',
      portefeuillePercentage='',
      afwijking='',
      valuta='',
      kopen='".$this->orderData[$t][3]."',
      verkopen='',
      modelWaarde='',
      koers=''";
      
      CREATE TABLE `TijdelijkeBulkOrders` (
  `id` int(11) NOT NULL auto_increment,
  `portefeuille` varchar(24) NOT NULL,
  `client` varchar(25) NOT NULL,
  `ISINCode` varchar(26) NOT NULL default '',
  `fonds` varchar(25) NOT NULL default '',
  `aantal` double NOT NULL default '0',
  `transactieSoort` varchar(2) NOT NULL default '',
  `add_date` datetime NOT NULL default '0000-00-00 00:00:00',
  `add_user` varchar(10) NOT NULL default '',
  `change_date` datetime NOT NULL default '0000-00-00 00:00:00',
  `change_user` varchar(10) NOT NULL default '',
  `koersLimiet` double NOT NULL default '0',
  `pagina` int(11) NOT NULL,
  `checkResult` tinyint(4) NOT NULL,
  `checkResultRegels` text NOT NULL,
  `statusLog` text NOT NULL,
  `regelNr` int(11) NOT NULL,
  `depotbank` varchar(10) NOT NULL default '',
  
      */
			$insert = "INSERT INTO tmpOrder SET ".
									" tmpOrdernr = '".$tmpOrdernr."', ".
									" Fonds = '".mysql_escape_string($this->orderData[$t][0])."', ".
									" FondsOmschrijving = '".mysql_escape_string($this->orderData[$t][6])."', ".
									" ISINCode = '".$this->orderData[$t][1]."', ".
									" Portefeuille = '".$this->orderData[$t][2]."', ".
									" ClientNaam = '".mysql_escape_string($this->orderData[$t][5])."', ".
									" Aantal = '".$this->orderData[$t][3]."', ".
									" AankoopWaarde = '".$this->orderData[$t][4]."', ".
									" Depotbank = '".$this->orderData[$t][7]."', ".
									" change_date = NOW(), ".
									" change_user = '".$this->USR."', ".
									" add_date = NOW(), ".
									" add_user = '".$this->USR."' ";

				$db->SQL($insert);
				$db->Query();

		}

		if($t>0)
			return $tmpOrdernr;
		else
			return false;
    }
	}
}
?>
