<?php
/*
Author  						: $Author: rvv $
Laatste aanpassing	: $Date: 2019/08/21 15:32:46 $
File Versie					: $Revision: 1.28 $

$Log: RapportPERF_L77.php,v $
Revision 1.28  2019/08/21 15:32:46  rvv
*** empty log message ***

Revision 1.27  2019/02/09 10:06:23  rvv
*** empty log message ***

Revision 1.26  2019/02/06 16:07:12  rvv
*** empty log message ***

Revision 1.25  2019/01/09 15:52:19  rvv
*** empty log message ***

Revision 1.24  2019/01/05 09:16:36  rvv
*** empty log message ***

Revision 1.23  2018/12/29 13:57:23  rvv
*** empty log message ***

Revision 1.22  2018/12/05 16:36:17  rvv
*** empty log message ***

Revision 1.21  2018/11/24 19:11:26  rvv
*** empty log message ***

Revision 1.20  2018/11/22 07:25:26  rvv
*** empty log message ***

Revision 1.19  2018/11/21 16:48:32  rvv
*** empty log message ***

Revision 1.18  2018/11/16 10:18:07  rvv
*** empty log message ***

Revision 1.17  2018/11/10 09:09:31  rvv
*** empty log message ***

Revision 1.16  2018/10/31 17:23:34  rvv
*** empty log message ***

Revision 1.15  2018/10/29 12:04:17  cvs
aanpassing netto rendement tekst

Revision 1.14  2018/10/27 16:49:57  rvv
*** empty log message ***

Revision 1.13  2018/10/24 16:00:59  rvv
*** empty log message ***

Revision 1.12  2018/10/22 13:46:44  cvs
call 6665 testen vervangen door kosten

Revision 1.11  2018/10/22 10:45:06  rvv
*** empty log message ***

Revision 1.8  2018/10/20 18:05:20  rvv
*** empty log message ***

Revision 1.7  2018/10/17 15:37:17  rvv
*** empty log message ***

Revision 1.6  2018/10/13 17:18:13  rvv
*** empty log message ***

Revision 1.5  2018/10/10 15:50:56  rvv
*** empty log message ***

Revision 1.4  2018/10/06 17:20:57  rvv
*** empty log message ***

Revision 1.3  2018/09/26 15:53:28  rvv
*** empty log message ***

Revision 1.2  2018/09/19 17:35:08  rvv
*** empty log message ***

Revision 1.1  2018/05/20 10:39:24  rvv
*** empty log message ***

Revision 1.51  2014/11/30 13:18:31  rvv
*** empty log message ***

Revision 1.50  2014/11/19 16:41:56  rvv
*** empty log message ***

Revision 1.49  2014/02/08 17:42:52  rvv
*** empty log message ***

Revision 1.48  2013/10/26 15:42:06  rvv
*** empty log message ***

Revision 1.47  2013/07/17 15:52:10  rvv
*** empty log message ***

Revision 1.46  2012/10/10 13:36:56  cvs
update 10-10-2012

Revision 1.45  2012/10/07 14:56:44  rvv
*** empty log message ***

Revision 1.44  2011/09/14 09:26:56  rvv
*** empty log message ***

Revision 1.43  2010/07/31 16:07:05  rvv
*** empty log message ***

Revision 1.42  2010/06/30 16:10:10  rvv
*** empty log message ***

Revision 1.41  2010/06/09 16:38:21  rvv
*** empty log message ***

Revision 1.40  2009/07/18 14:11:49  rvv
*** empty log message ***

Revision 1.39  2009/03/14 13:24:27  rvv
*** empty log message ***

Revision 1.38  2009/01/20 17:44:09  rvv
*** empty log message ***

Revision 1.37  2008/05/16 08:12:57  rvv
*** empty log message ***

Revision 1.36  2008/03/18 09:30:24  rvv
*** empty log message ***

Revision 1.35  2007/11/16 11:22:27  rvv
*** empty log message ***

Revision 1.34  2007/11/02 12:53:13  rvv
met liquiditeiten

Revision 1.33  2007/10/12 10:06:33  rvv
*** empty log message ***

Revision 1.32  2007/10/10 08:18:40  rvv
*** empty log message ***

Revision 1.31  2007/10/04 12:01:30  rvv
*** empty log message ***

Revision 1.30  2007/08/09 08:58:31  rvv
*** empty log message ***

Revision 1.29  2007/07/10 15:54:49  rvv
AFS update

Revision 1.28  2007/07/05 12:28:39  rvv
*** empty log message ***

Revision 1.27  2007/06/29 11:38:56  rvv
L14 aanpassingen

Revision 1.26  2007/06/05 11:38:25  rvv
*** empty log message ***

Revision 1.25  2007/03/29 10:37:11  rvv
fix performance met jaarovergang

Revision 1.24  2007/03/27 14:58:20  rvv
VreemdeValutaRapportage

Revision 1.23  2006/11/03 11:24:04  rvv
Na user update

Revision 1.22  2006/10/31 12:11:04  rvv
Voor user update

Revision 1.21  2006/08/18 07:33:20  rvv
Toevoeging om het ongerealiseerde koersresultaat uit het vorige jaar mee te nemen.

Revision 1.20  2006/08/10 15:15:42  cvs
*** empty log message ***

Revision 1.19  2006/07/13 18:31:24  cvs
*** empty log message ***

Revision 1.18  2006/03/21 10:13:26  jwellner
*** empty log message ***

Revision 1.17  2006/03/01 07:56:20  jwellner
*** empty log message ***

Revision 1.16  2006/01/13 15:46:51  jwellner
diverse aanpassingen

Revision 1.15  2005/12/19 13:23:27  jwellner
no message

Revision 1.14  2005/11/30 08:37:39  jwellner
layout stuff

Revision 1.13  2005/11/25 09:30:08  jwellner
- verdiept overzicht
- layout

Revision 1.12  2005/11/21 08:39:26  jwellner
layout

Revision 1.11  2005/11/18 15:15:01  jwellner
no message

Revision 1.10  2005/11/11 16:13:50  jwellner
bufix in MUT2 , PERF en Rekenclass

Revision 1.9  2005/11/09 10:21:05  jwellner
no message

Revision 1.8  2005/11/07 10:29:17  jwellner
no message

Revision 1.7  2005/10/04 12:34:41  jwellner
no message

Revision 1.6  2005/09/30 14:05:13  jwellner
- rapport OIH
- rapport MUT2
- Layout 5
- selectieschermen

Revision 1.5  2005/09/29 15:00:18  jwellner
no message

Revision 1.4  2005/09/16 07:32:55  jwellner
aanpassingen rapportage.

Revision 1.3  2005/09/09 11:31:46  jwellner
diverse aanpassingen zie e-mails Theo

Revision 1.2  2005/07/28 15:12:37  jwellner
no message

Revision 1.1  2005/07/15 11:21:00  jwellner
Layout verwijderd, alles samengevoegd in PDFRapport

Revision 1.4  2005/07/12 15:04:20  jwellner
diverse aanpassingen

Revision 1.3  2005/07/12 07:09:50  jwellner
no message

Revision 1.2  2005/07/08 13:52:01  jwellner
no message

Revision 1.1  2005/06/30 08:22:56  jwellner
Rapportage toegevoegd

*/

include_once("rapportRekenClass.php");
include_once($__appvar["basedir"]."/html/rapport/rapportVertaal.php");

class RapportPERFG_L77
{

	function RapportPERFG_L77($pdf, $portefeuille, $rapportageDatumVanaf, $rapportageDatum)
	{
		$this->pdf = &$pdf;
		$this->pdf->rapport_type = "PERF";
		$this->pdf->rapport_datum = db2jul($rapportageDatum);
		$this->pdf->rapport_datumvanaf = db2jul($rapportageDatumVanaf);
    
		$this->pdf->rapport_titel = "Totaal vermogen";


		//$this->pdf->rapport_PERF_displayType

		$this->portefeuille = $portefeuille;
		$this->rapportageDatumVanaf = $rapportageDatumVanaf;
		$this->rapportageDatum = $rapportageDatum;

   
    if($rapportageDatumVanaf==$rapportageDatum && substr($rapportageDatumVanaf,5,5)=='01-01')
      $this->rapportageDatumVanaf=(substr($rapportageDatumVanaf,0,4)-1).'-12-31';
	}

	function formatGetal($waarde, $dec)
	{
		return number_format($waarde,$dec,",",".");
	}

	function formatGetalKoers($waarde, $dec , $start = false)
	{
	  if ($start == false)
	    $waarde = $waarde / $this->pdf->ValutaKoersEind;
	  else
	    $waarde = $waarde / $this->pdf->ValutaKoersStart;

	  return number_format($waarde,$dec,",",".");
  }


	function writeRapport()
	{
		// voor kopjes
    
    $this->getKleuren();
    
    $this->pdf->AddPage();
		$this->pdf->templateVars[$this->pdf->rapport_type.'Paginas']=$this->pdf->page;
		$this->pdf->templateVarsOmschrijving[$this->pdf->rapport_type.'Paginas']=$this->pdf->rapport_titel;
		$this->pdf->SetDrawColor(0,0,0);
		$this->pdf->SetTextColor($this->pdf->rapport_fontcolor['r'],$this->pdf->rapport_fontcolor['g'],$this->pdf->rapport_fontcolor['b']);

    $portefeuilleWaarden=$this->bepaalPortefeuilleWaarden();
    $this->toonTabel($portefeuilleWaarden['verslagperiodeWaarden'],$portefeuilleWaarden['jaarWaarden']);
    $this->addGrafiekWaardeontwikkeling($portefeuilleWaarden['grafiekVerdelingOpDatum'],'OIB');
    $this->addGrafiekRendement($portefeuilleWaarden['huidigeJaarGrafiek']);
    

    $this->pdf->rapport_titel = "TOTAAL VERMOGEN Liquide";
    $this->pdf->addPage();
    $hoofdcatData=$this->getComponentData('Hoofdcategorie','Liquide','depotbank');
    $this->toonTabel($hoofdcatData['verslagperiodeWaarden'],$hoofdcatData['jaarWaarden']);
    $this->addGrafiekWaardeontwikkeling($hoofdcatData['grafiekVerdelingOpDatum'],'DEP',$hoofdcatData['categorieOmschrijving']);
    $this->addGrafiekRendement($hoofdcatData['huidigeJaarGrafiek']);

	}
	
	function getKleuren()
  {
    $q="SELECT grafiek_kleur ,grafiek_sortering FROM Vermogensbeheerders WHERE Vermogensbeheerder = '".$this->pdf->portefeuilledata['Vermogensbeheerder']."'";
    $DB = new DB();
    $DB->SQL($q);
    $DB->Query();
    $kleuren = $DB->LookupRecord();
    $allekleuren = unserialize($kleuren['grafiek_kleur']);
    $this->categorieKleuren=$allekleuren;
  
    $this->pdf->widthB = array(85,2,40);
    $this->pdf->alignB = array('L','R','R','R');
  }
	
	function getComponentData($verdeling,$categorie,$waardeGrafiekVerdeling)
  {
    include_once("rapport/include/ATTberekening_L77.php");
  
  
    $categorieOmschrijving=array();
    $jaarWaarden=array();
    $grafiekVerdelingOpDatum=array();
    $huidigeJaarGrafiek=array();
    
    if(!isset($this->waarden[$verdeling]))
    {
      $this->att = new ATTberekening_L77($this);
      $this->att->indexPerformance = false;
      $this->waarden[$verdeling] = $this->att->bereken($this->rapportageDatumVanaf, $this->rapportageDatum, $verdeling);
    }
    $verslagperiodeWaarden=$this->waarden[$verdeling][$categorie];
  
    $laatsteDatum='';
    foreach($this->waarden[$verdeling][$categorie]['perfWaarden'] as $datum=>$maandwaarden)
    {
      $huidigeJaarGrafiek[$datum]['performance']=$maandwaarden['procent']*100;
      $huidigeJaarGrafiek[$datum]['performanceCumu']=((1+$huidigeJaarGrafiek[$laatsteDatum]['performanceCumu']/100) * (1+$maandwaarden['procent'])-1)*100 ;
      $laatsteDatum=$datum;

    }
  //listarray($huidigeJaarGrafiek);
    //$this->att=new ATTberekening_L77($this,'jaar');
    if(!isset($this->waarden[$verdeling.'_jaarWaarden']))
    {
      $beginDatum = substr($this->pdf->PortefeuilleStartdatum, 0, 10);
      $this->waarden[$verdeling . '_jaarWaarden'] = $this->att->bereken($beginDatum, $this->rapportageDatum, $verdeling);
    }
    $maanden=array();
    foreach($this->waarden[$verdeling . '_jaarWaarden'][$categorie]['perfWaarden'] as $datum=>$periodeWaarden)
    {
      $maanden[]=$datum;
      $jaar = substr($datum, 0, 4);
      $beginDatum=substr($periodeWaarden['periode'],0,10);
      if(!isset($jaarWaarden[$jaar]['waardeBegin']))
      {
        $jaarWaarden[$jaar]['waardeBegin'] = $periodeWaarden['waardeBegin'];
        $jaarWaarden[$jaar]['beginDatum'] = $beginDatum;
      }
  
     // $beginDatum = substr($periodeWaarden['periode'], 0, 10);
      $jaarWaarden[$jaar]['waardeHuidige'] = $periodeWaarden['eindwaarde'];
      $jaarWaarden[$jaar]['resultaatVerslagperiode'] += $periodeWaarden['resultaat'];
      $jaarWaarden[$jaar]['opbrengsten'] += $periodeWaarden['opbrengst'];
      $jaarWaarden[$jaar]['stortingen'] += $periodeWaarden['storting'];
      $jaarWaarden[$jaar]['onttrekkingen'] += $periodeWaarden['onttrekking'];
      $jaarWaarden[$jaar]['kosten'] += $periodeWaarden['kosten'];
      $jaarWaarden[$jaar]['waardeMutatie'] += $periodeWaarden['eindwaarde']-$periodeWaarden['beginwaarde'];
      $jaarWaarden[$jaar]['resultaatBruto'] += ($periodeWaarden['resultaatBruto'] );
      $jaarWaarden[$jaar]['performance'] = ((1 + $jaarWaarden[$jaar]['performance'] / 100) * (1 + $periodeWaarden['procentBruto']) - 1) * 100;
      $jaarWaarden[$jaar]['benchmark'] = ((1 + $jaarWaarden[$jaar]['benchmark'] / 100) * (1 + $periodeWaarden['indexPerf']) - 1) * 100;
    }

    if(isset($this->pdf->portefeuilles) && count($this->pdf->portefeuilles)>1)
    {
      $portefeuilles=$this->pdf->portefeuilles;
    }
    else
    {
      $portefeuilles=array($this->portefeuille);
    }
  
    $DB=new DB();
    $query="SELECT Portefeuilles.Portefeuille, Portefeuilles.depotbank,Depotbanken.Omschrijving FROM Portefeuilles JOIN Depotbanken ON Portefeuilles.Depotbank=Depotbanken.Depotbank WHERE Portefeuilles.portefeuille IN('".implode("','",$portefeuilles)."')";
    $DB->SQL($query);
    $DB->Query();
    $depotbankenMetWaarde=array();
    while($data=$DB->nextRecord())
    {
      if($waardeGrafiekVerdeling=='depotbank')
      {
        $portefeuilleDetails[$data['Portefeuille']] = $data;
        $depotwaarde[$data['depotbank']] = 0;
        $depotbankenMetWaarde[$data['depotbank']] = false;
        
      }
      $categorieOmschrijving[$data['depotbank']] = $data['Omschrijving'];
    }
    
    if($waardeGrafiekVerdeling=='depotbank')
    {
      foreach($portefeuilles as $portefeuille)
      {
        $depotbank=$portefeuilleDetails[$portefeuille]['depotbank'];
        foreach($maanden as $maand)
        {
          if(!isset($grafiekVerdelingOpDatum[$maand]))
              $grafiekVerdelingOpDatum[$maand]=$depotwaarde;
  
          $waarde=0;
          $fondswaarden =  berekenPortefeuilleWaarde($portefeuille,$maand,(substr($maand, 5, 5) == '01-01')?true:false,'EUR',$maand);
          foreach ($fondswaarden as $regel)
          {
            if($categorie=='Liquide'||$categorie=='Illiquide')
            {
              if($regel[strtolower($verdeling)]==$categorie)
                $waarde += $regel['actuelePortefeuilleWaardeEuro'];
            }
            else
              $waarde += $regel['actuelePortefeuilleWaardeEuro'];
          }
         
          $grafiekVerdelingOpDatum[$maand][$depotbank]+=$waarde;
          if($waarde<>0)
            $depotbankenMetWaarde[$depotbank]=true;
        }
      }
      
      //foreach($grafiekVerdelingOpDatum)
      foreach($grafiekVerdelingOpDatum as $datum=>$waarden)
      {
        foreach($depotbankenMetWaarde as $depotbank=>$heeftWaarde)
        {
          if($heeftWaarde==false)
            unset($grafiekVerdelingOpDatum[$datum][$depotbank]);
        }
      }

     // listarray($grafiekVerdelingOpDatum);exit;

    }
    if($waardeGrafiekVerdeling='Beleggingscategorie' && $verdeling=='Bewaarder')
    {
      $DB=new DB();
      $query="SELECT IFNULL(BeleggingscategoriePerFonds.Beleggingscategorie,Rekeningen.Beleggingscategorie) as categorie,Rekeningen.Portefeuille,Rekeningen.Depotbank FROM
	Rekeningen JOIN Rekeningmutaties ON Rekeningen.Rekening=Rekeningmutaties.Rekening
  LEFT JOIN BeleggingscategoriePerFonds ON Rekeningmutaties.Fonds=BeleggingscategoriePerFonds.Fonds AND BeleggingscategoriePerFonds.Vermogensbeheerder='AND'
  WHERE Rekeningen.Depotbank='$categorie' AND Rekeningen.portefeuille IN('".implode("','",$portefeuilles)."')
  GROUP BY categorie,Portefeuille";
      $DB->SQL($query);
      $DB->Query();
      $categorien=array();
      $categoriewaarde=array();
      while($data=$DB->nextRecord())
      {
        $portefeuilleDetails[$data['Portefeuille']]=$data;
        $categorien[$data['categorie']]=$data['categorie'];
        $categoriewaarde[$data['categorie']]=0;
      }
     
      $query="SELECT
KeuzePerVermogensbeheerder.vermogensbeheerder,
KeuzePerVermogensbeheerder.categorie,
KeuzePerVermogensbeheerder.waarde,
Beleggingscategorien.Omschrijving,
KeuzePerVermogensbeheerder.Afdrukvolgorde
FROM
KeuzePerVermogensbeheerder
INNER JOIN Beleggingscategorien ON KeuzePerVermogensbeheerder.waarde = Beleggingscategorien.Beleggingscategorie
WHERE
KeuzePerVermogensbeheerder.vermogensbeheerder='".$this->pdf->portefeuilledata['Vermogensbeheerder']."' AND
KeuzePerVermogensbeheerder.categorie='Beleggingscategorien' AND
	KeuzePerVermogensbeheerder.waarde  IN('".implode("','",$categorien)."')
ORDER BY KeuzePerVermogensbeheerder.Afdrukvolgorde";
      $DB->SQL($query);
      $DB->Query();
      while($data=$DB->nextRecord())
      {
        $categorieOmschrijving[$data['waarde']] = $data['Omschrijving'];
      }
    
      foreach($portefeuilleDetails as $portefeuille=>$details)
      {
        foreach($maanden as $maand)
        {
          if(!isset($grafiekVerdelingOpDatum[$maand]))
            $grafiekVerdelingOpDatum[$maand]=$categoriewaarde;
          $fondswaarden = berekenPortefeuilleWaarde($portefeuille,$maand,(substr($maand, 5, 5) == '01-01')?true:false,'EUR',$maand);
          foreach ($fondswaarden as $regel)
          {
            $grafiekVerdelingOpDatum[$maand][$regel['beleggingscategorie']]+=$regel['actuelePortefeuilleWaardeEuro'];
            $categorieOmschrijving[$regel['beleggingscategorie']]=$regel['beleggingscategorieOmschrijving'];
          }
        }
      }
    }

//    listarray($categorieOmschrijving);
    
    return array('verslagperiodeWaarden'=>$verslagperiodeWaarden,'jaarWaarden'=>$jaarWaarden,'grafiekVerdelingOpDatum'=>$grafiekVerdelingOpDatum,'huidigeJaarGrafiek'=>$huidigeJaarGrafiek,'categorieOmschrijving'=>$categorieOmschrijving);
  }
	
	function addGrafiekWaardeontwikkeling($grafiekVerdelingOpDatum,$kleurSoort='OIB',$omschrijvingen=array())
  {
    $grafiekX=120;
    $this->pdf->setXY(155,25);
    $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
    $this->pdf->MultiCell($grafiekX,4,vertaalTekst('Waardeontwikkeling',$this->pdf->rapport_taal).'',0,'C');
    $this->pdf->setXY(155,90);
    //$this->VBarDiagram2($grafiekX,60,$jaarWaardenGrafiek);
    $this->areaDiagram($grafiekX, 60, $grafiekVerdelingOpDatum,$kleurSoort,$omschrijvingen);
  }
  
  function addGrafiekRendement($huidigeJaarGrafiek)
  {
    $grafiekX=120;
    $this->pdf->setXY(155,115);
    $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
    $this->pdf->MultiCell($grafiekX,4,vertaalTekst('Huidig rendement',$this->pdf->rapport_taal).' (%)',0,'C');
    $this->pdf->setXY(155,180);
    $this->VBarDiagram2($grafiekX,60,$huidigeJaarGrafiek,true);
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
  }
	
	function bepaalPortefeuilleWaarden()
  {
    global $__appvar;
    $DB = new DB();
  
    $query="SELECT
CategorienPerHoofdcategorie.Hoofdcategorie,
CategorienPerHoofdcategorie.Beleggingscategorie,
Beleggingscategorien.Omschrijving
FROM
CategorienPerHoofdcategorie
INNER JOIN Beleggingscategorien ON CategorienPerHoofdcategorie.Hoofdcategorie = Beleggingscategorien.Beleggingscategorie
WHERE
CategorienPerHoofdcategorie.Vermogensbeheerder='".$this->pdf->portefeuilledata['Vermogensbeheerder']."'
ORDER BY Beleggingscategorien.Afdrukvolgorde";
    $DB->SQL($query);
    $DB->Query();
    while($data=$DB->nextRecord())
    {
      $hoofdCategoriePerCategorie[$data['Beleggingscategorie']]=$data;
    }
  


    if(isset($this->pdf->portefeuilles) && count($this->pdf->portefeuilles)>1)
      $portefeuilleSelectie=array($this->portefeuille,$this->pdf->portefeuilles);
    else
      $portefeuilleSelectie=$this->portefeuille;
  
    if($_POST['debug']==1)
    {
      $debug=true;
      $_POST['debug']=false;
    }
    else
    {
      $debug=false;
    }
    $beginDatum=substr($this->pdf->PortefeuilleStartdatum,0,10);
    $index = new indexHerberekening();
  
    if(db2jul($beginDatum)<db2jul('2017-12-31'))
    {
      if(db2jul($this->rapportageDatum) < db2jul('2017-12-31'))
        $eindDatum=$this->rapportageDatum;
      else
        $eindDatum='2017-12-31';
      $indexWaarden = $index->getWaarden($beginDatum,$eindDatum,$portefeuilleSelectie,$this->pdf->portefeuilledata['SpecifiekeIndex'],'jaar',$this->pdf->rapportageValuta);
    }
  
  
    if (db2jul($this->rapportageDatum) > db2jul('2018-01-01'))
    {
      if(db2jul($beginDatum)<db2jul('2018-01-01'))
      {
        $beginDatum = '2018-01-01';
      }
      $indexWaardenMaanden = $index->getWaarden($beginDatum, $this->rapportageDatum, $portefeuilleSelectie, $this->pdf->portefeuilledata['SpecifiekeIndex'], 'maanden', $this->pdf->rapportageValuta);
      foreach($indexWaardenMaanden as $periodeData)
        $indexWaarden[]=$periodeData;
    }
  
    $indexWaardenHuidigeJaar = $index->getWaarden(date('Y-m-d',$this->pdf->rapport_datumvanaf), $this->rapportageDatum, $portefeuilleSelectie, $this->pdf->portefeuilledata['SpecifiekeIndex'], 'maanden', $this->pdf->rapportageValuta);
  
    $jaarWaarden=array();
    $jaarWaardenGrafiek=array();
    $huidigeJaarGrafiek=array();
    $verslagperiodeWaarden=array();
    $huidigeJaarJul=db2jul(substr($this->rapportageDatum,0,4).'-01-01');
    $laatsteDatum='';
    $perfVerslagperiodeBruto=0;
    $eerstePerfDatum='';
  
    $grafiekVerdelingOpDatum=array();
    foreach($indexWaarden as $maandwaarden)
    {
      $jaar=substr($maandwaarden['datum'],0,4);
      $beginDatum=substr($maandwaarden['periode'],0,10);
      if(!isset($jaarWaarden[$jaar]['waardeBegin']))
      {
        $jaarWaarden[$jaar]['waardeBegin'] = $maandwaarden['waardeBegin'];
        $jaarWaarden[$jaar]['beginDatum'] = $beginDatum;
      }
    
      foreach($maandwaarden['extra']['cat'] as $categorie=>$waarde)
      {
        if($categorie=='LIQ')
          $categorie='H-Liq';
        if($categorie=='VAR')
          $categorie='H-Oblig';
      
        $grafiekVerdelingOpDatum[$maandwaarden['datum']][$hoofdCategoriePerCategorie[$categorie]['Hoofdcategorie']]+=$waarde;
      }
    
      if($maandwaarden['database']==0)
      {
        $resultaatBruto=$maandwaarden['resultaatVerslagperiode']-$maandwaarden['kosten'];
        $gemiddeldVermogen=$maandwaarden['resultaatVerslagperiode']/($maandwaarden['performance']*0.01);
        $brutoRendement=$resultaatBruto/$gemiddeldVermogen*100;
        $maandwaarden['performanceNetto']=$maandwaarden['performance'];
        $maandwaarden['performance']=$brutoRendement;
      }
      $jaarWaarden[$jaar]['waardeHuidige']=$maandwaarden['waardeHuidige'];
      $jaarWaarden[$jaar]['resultaatVerslagperiode']+=$maandwaarden['resultaatVerslagperiode'];
      $jaarWaarden[$jaar]['opbrengsten']+=$maandwaarden['opbrengsten'];
      $jaarWaarden[$jaar]['stortingen']+=$maandwaarden['stortingen'];
      $jaarWaarden[$jaar]['onttrekkingen']+=$maandwaarden['onttrekkingen'];
      $jaarWaarden[$jaar]['kosten']+=$maandwaarden['kosten'];
      $jaarWaarden[$jaar]['waardeMutatie']+=$maandwaarden['waardeMutatie'];
      $jaarWaarden[$jaar]['resultaatBruto']+=($maandwaarden['resultaatVerslagperiode']-$maandwaarden['kosten']);
      $jaarWaarden[$jaar]['performance']=((1+$jaarWaarden[$jaar]['performance']/100) * (1+$maandwaarden['performance']/100)-1) * 100;
      $jaarWaarden[$jaar]['benchmark']=((1+$jaarWaarden[$jaar]['benchmark']/100) * (1+$maandwaarden['specifiekeIndexPerformance']/100)-1) * 100;
      if(db2jul($maandwaarden['datum']) >= $huidigeJaarJul)
      {
        if($eerstePerfDatum=='')
          $eerstePerfDatum=$maandwaarden['datum'];
      
        $huidigeJaarGrafiek[$maandwaarden['datum']]['performance']=$maandwaarden['performance'];
        $huidigeJaarGrafiek[$maandwaarden['datum']]['performanceCumu']=((1+$huidigeJaarGrafiek[$laatsteDatum]['performanceCumu']/100) * (1+$maandwaarden['performance']/100)-1) * 100;
      
        $laatsteDatum=$maandwaarden['datum'];
      }
      $jaarWaardenGrafiek[$jaar]['performance']=$jaarWaarden[$jaar]['performance'];
    }
  
    $stdev=getFondsPerformanceGestappeld2($this->pdf->portefeuilledata['SpecifiekeIndex'],$this->portefeuille,date('Y-m-d',$huidigeJaarJul), $this->rapportageDatum,'maanden',false,true,true);
    $laatsteDatum='leeg';
    foreach($stdev->reeksen['benchmark'] as $datum=>$rendementDetails)
    {
      if(db2jul($datum) >= db2jul($eerstePerfDatum))
      {
        $huidigeJaarGrafiek[$datum]['benchmark'] = $rendementDetails['perf'];
        $huidigeJaarGrafiek[$datum]['benchmarkCumu'] = ((1 + $huidigeJaarGrafiek[$laatsteDatum]['benchmarkCumu'] / 100) * (1 + $rendementDetails['perf'] / 100) - 1) * 100;
        $laatsteDatum=$datum;
      }
    }
    if($debug==true)
    {
      listarray($stdev->reeksen['benchmark']);
      listarray($huidigeJaarGrafiek); ob_flush();
      $_POST['debug']=true;
    }
    foreach($indexWaardenHuidigeJaar as $maandwaarden)
    {
      $beginDatum=substr($maandwaarden['periode'],0,10);
      $resultaatBruto=$maandwaarden['resultaatVerslagperiode']-$maandwaarden['kosten'];
      $gemiddeldVermogen=$maandwaarden['resultaatVerslagperiode']/($maandwaarden['performance']*0.01);
      $brutoRendement=$resultaatBruto/$gemiddeldVermogen*100;
      $maandwaarden['performanceNetto']=$maandwaarden['performance'];
      $maandwaarden['performance']=$brutoRendement;
      if(db2jul($beginDatum)>=$this->pdf->rapport_datumvanaf)
      {
        $perfVerslagperiodeBruto=((1+$perfVerslagperiodeBruto/100) * (1+$maandwaarden['performance']/100)-1) * 100;
        $verslagperiodeWaarden['resultaatBruto']+=($maandwaarden['resultaatVerslagperiode']-$maandwaarden['kosten']);
        $verslagperiodeWaarden['kosten']+=$maandwaarden['kosten'];
      }
    }

    // haal totaalwaarde op om % te berekenen
    $query = "SELECT SUM(actuelePortefeuilleWaardeEuro) / ".$this->pdf->ValutaKoersEind." AS totaal ".
      "FROM TijdelijkeRapportage WHERE ".
      " rapportageDatum ='".$this->rapportageDatum."' AND ".
      " portefeuille = '".$this->portefeuille."' "
      .$__appvar['TijdelijkeRapportageMaakUniek'];
    debugSpecial($query,__FILE__,__LINE__);
  
    $DB->SQL($query);
    $DB->Query();
    $totaalWaarde = $DB->nextRecord();
  
    // haal totaalwaarde op om % te berekenen
    $query = "SELECT SUM(actuelePortefeuilleWaardeEuro / ".$this->pdf->ValutaKoersBegin." ) AS totaal ".
      "FROM TijdelijkeRapportage WHERE ".
      " rapportageDatum ='".$this->rapportageDatumVanaf."' AND ".
      " portefeuille = '".$this->portefeuille."' "
      .$__appvar['TijdelijkeRapportageMaakUniek'];
    debugSpecial($query,__FILE__,__LINE__);
  
    $DB->SQL($query);
    $DB->Query();
    $totaalWaardeVanaf = $DB->nextRecord();
  
    $waardeEind				= $totaalWaarde['totaal'];
    $waardeBegin 			 	= $totaalWaardeVanaf['totaal'];
    $stortingen 			 	= getStortingen($this->portefeuille,$this->rapportageDatumVanaf,$this->rapportageDatum,$this->pdf->rapportageValuta);
    $onttrekkingen 		 	= getOnttrekkingen($this->portefeuille,$this->rapportageDatumVanaf,$this->rapportageDatum,$this->pdf->rapportageValuta);
    $rendementProcent  	= performanceMeting($this->portefeuille, $this->rapportageDatumVanaf, $this->rapportageDatum, $this->pdf->portefeuilledata['PerformanceBerekening'],$this->pdf->rapportageValuta);
  
    $verslagperiodeWaarden['beginwaarde']=$waardeBegin;
    $verslagperiodeWaarden['eindwaarde']=$waardeEind;
    $verslagperiodeWaarden['storting']=$stortingen;
    $verslagperiodeWaarden['onttrekking']=$onttrekkingen;
    $verslagperiodeWaarden['procentBruto']=$perfVerslagperiodeBruto;
    $verslagperiodeWaarden['procent']=$rendementProcent;
    
    return array('verslagperiodeWaarden'=>$verslagperiodeWaarden,'jaarWaarden'=>$jaarWaarden,'grafiekVerdelingOpDatum'=>$grafiekVerdelingOpDatum,'huidigeJaarGrafiek'=>$huidigeJaarGrafiek);
  }
	
	function toonTabel($verslagperiodeWaarden,$jaarWaarden)
  {
  
    $this->pdf->SetWidths($this->pdf->widthB);
    $this->pdf->SetAligns($this->pdf->alignB);
    $this->pdf->ln();
    $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
  
  
    $this->pdf->SetFillColor($this->pdf->rapport_kop_bgcolor['r'],$this->pdf->rapport_kop_bgcolor['g'],$this->pdf->rapport_kop_bgcolor['b']);
    $this->pdf->Rect($this->pdf->marge, $this->pdf->getY(), array_sum($this->pdf->widthB), 6 , 'F');
    $this->pdf->SetTextColor($this->pdf->rapport_kop_fontcolor['r'],$this->pdf->rapport_kop_fontcolor['g'],$this->pdf->rapport_kop_fontcolor['b']);
    $this->pdf->ln(1);
    $this->pdf->row(array(vertaalTekst("Rendementsberekening",$this->pdf->rapport_taal),"",vertaalTekst("Waardering in",$this->pdf->rapport_taal)." ".$this->pdf->rapportageValuta));
    $this->pdf->SetTextColor(0);
    $this->pdf->ln(1);
  
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
    $this->pdf->row(array(vertaalTekst("Waarde per",$this->pdf->rapport_taal)." ".date("d.m.Y",$this->pdf->rapport_datumvanaf),'',$this->formatGetal($verslagperiodeWaarden['beginwaarde'],2)));
    $this->pdf->row(array(vertaalTekst("Waarde per",$this->pdf->rapport_taal)." ".date("d.m.Y",db2jul($this->rapportageDatum)),'',$this->formatGetal($verslagperiodeWaarden['eindwaarde'],2)));
    $this->pdf->row(array(vertaalTekst("Waardeverandering",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['eindwaarde']-$verslagperiodeWaarden['beginwaarde'],2),""));
    $this->pdf->ln();
    $this->pdf->row(array(vertaalTekst("Stortingen",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['storting'],2),''));
    $this->pdf->row(array(vertaalTekst("Onttrekkingen",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['onttrekking'],2),''));
    $this->pdf->row(array(vertaalTekst("Ingehouden kosten en belastingen",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['kosten']*-1,2),''));
    $this->pdf->ln();
    $this->pdf->row(array(vertaalTekst("Bruto resultaat voor kosten en belastingen",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['resultaatBruto'],2),''));
    $this->pdf->row(array(vertaalTekst("Bruto rendement voor kosten en belastingen",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['procentBruto'],2)."%",''));
    $this->pdf->ln();
    $this->pdf->row(array(vertaalTekst("Netto rendement na ingehouden kosten en belastingen",$this->pdf->rapport_taal),'',$this->formatGetal($verslagperiodeWaarden['procent'],2)."%"));
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
  
    $this->pdf->ln();
    $this->pdf->SetWidths(array(20,10,20,20,20,20,16));
    $this->pdf->SetAligns(array('L','L','R','R','R','R','R'));
  
    $this->pdf->SetFillColor($this->pdf->rapport_kop_bgcolor['r'],$this->pdf->rapport_kop_bgcolor['g'],$this->pdf->rapport_kop_bgcolor['b']);
    $this->pdf->Rect($this->pdf->marge, $this->pdf->getY(), array_sum($this->pdf->widths), 10, 'F');
    $this->pdf->SetTextColor($this->pdf->rapport_kop_fontcolor['r'],$this->pdf->rapport_kop_fontcolor['g'],$this->pdf->rapport_kop_fontcolor['b']);
    $this->pdf->ln(1);
    $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
    $this->pdf->row(array(vertaalTekst("Jaar",$this->pdf->rapport_taal),vertaalTekst("Val",$this->pdf->rapport_taal),vertaalTekst("Waarde",$this->pdf->rapport_taal),vertaalTekst("Mutaties",$this->pdf->rapport_taal),
                      vertaalTekst("Kosten en belasting",$this->pdf->rapport_taal),vertaalTekst("Bruto resultaat",$this->pdf->rapport_taal),vertaalTekst("Rend.",$this->pdf->rapport_taal)));
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
    $this->pdf->SetTextColor(0);
    $this->pdf->ln(1);
    $n=0;
    $begin='';
    $beginDatum='';
    $totalen=array();
    foreach($jaarWaarden as $jaar=>$jaarData)
    {
      if($n==0)
      {
        $datum = date('d-m-Y', db2jul($jaarData['beginDatum']));
        $beginDatum=$datum;
        if(substr($datum,0,5)=='01-01')
        {
          $datum = substr($datum, -4);
        }
        $begin=$datum;
      }
      else
      {
        $datum = $jaar;
      }
      $this->pdf->row(array($datum, $this->pdf->rapportageValuta, $this->formatGetal($jaarData['waardeHuidige'], 0),
                        $this->formatGetal($jaarData['stortingen']-$jaarData['onttrekkingen'], 0),
                        $this->formatGetal($jaarData['kosten'], 0),
                        $this->formatGetal($jaarData['resultaatBruto'], 0),
                        $this->formatGetal($jaarData['performance'], 2) . "%"));
      $n++;
      $totalen['stortingen']+=$jaarData['stortingen'];
      $totalen['onttrekkingen']+=$jaarData['onttrekkingen'];
      $totalen['kosten']+=$jaarData['kosten'];
      $totalen['opbrengsten']+=$jaarData['opbrengsten'];
      $totalen['resultaatBruto']+=$jaarData['resultaatBruto'];
      $totalen['performance']=((1+$totalen['performance']/100)*(1+$jaarData['performance']/100)-1)*100;
    }
    $this->pdf->SetWidths(array(20+10+20,20,20,20,16));
    $this->pdf->SetAligns(array('L','R','R','R','R','R'));
    $this->pdf->ln(2);
    $this->pdf->row(array(vertaalTekst('Totaal sinds',$this->pdf->rapport_taal).' '.$begin,
                      $this->formatGetal($totalen['stortingen']-$totalen['onttrekkingen'], 0),
                      $this->formatGetal($totalen['kosten'], 0),
                      $this->formatGetal($totalen['resultaatBruto'], 0),
                      $this->formatGetal($totalen['performance'], 2) . "%"));
  
    $periodeDagen=round((db2jul($this->rapportageDatum)-form2jul($beginDatum))/86400);
    if($periodeDagen>366)
    {
      $jaarRendement = (pow(1 + $totalen['performance'] / 100, (365.25 / $periodeDagen)) - 1) * 100;
      $this->pdf->SetWidths(array(20+10+20+20+20+20,16));
      $this->pdf->ln(2);
      $this->pdf->row(array(vertaalTekst('Gemiddeld rendement p.j. sinds',$this->pdf->rapport_taal).' '.$begin,
                        $this->formatGetal($jaarRendement, 2) . "%"));
    
    }
  }
  
  
  
  function areaDiagram($w, $h, $data,$kleurSoort='OIB',$omschrijvingen=array())
  {
    global $__appvar;
    $grafiekPunt = array();
    
    $XPage = $this->pdf->GetX();
    $YPage = $this->pdf->GetY();
    
    $this->pdf->Rect($XPage, $YPage-$h, $w, $h,'D','');
    $colors=array();
    $totaleWaardeOpDatum=array();
    $totaleWaardeOpDatumNegatief=array();
    $aantalWaarden=count($data);
    $j=0;
    foreach ($data as $datum=>$waarden)
    {
      if($aantalWaarden>12)
      {
        if($j%($aantalWaarden/12)==0)
          $legenda[$datum] = date('m-Y', (db2jul($datum)));
        else
          $legenda[$datum] ='';
        $j++;
      }
      else
        $legenda[$datum] = vertaalTekst($__appvar["Maanden"][date("n",db2jul($datum))],$this->pdf->rapport_taal);// date('m-Y',(db2jul($datum)));
      $n=0;
      foreach ($waarden as $categorie=>$waardeEur)
      {
        if($waardeEur>0)
          $totaleWaardeOpDatum[$datum]+=$waardeEur;
        else
          $totaleWaardeOpDatumNegatief[$datum]+=$waardeEur;
        
        $this->categorieVolgorde[$categorie]=$categorie;
        $grafiek[$datum][$categorie]=$waarden[$categorie];
        $grafiekCategorie[$categorie][$datum]=$waarden[$categorie];


        if($waarden[$categorie] < 0)
        {
          unset($grafiek[$datum][$categorie]);
          $grafiekNegatief[$datum][$categorie]=$waarden[$categorie];
        }
        else
          $grafiekNegatief[$datum][$categorie]=0;
        
        if(!isset($colors[$categorie]))
          $colors[$categorie]=array($this->categorieKleuren[$kleurSoort][$categorie]['R']['value'],$this->categorieKleuren[$kleurSoort][$categorie]['G']['value'],$this->categorieKleuren[$kleurSoort][$categorie]['B']['value']);
        $n++;
      }
    }
    
    if(count($omschrijvingen)>0)
    {
      $newVolgorde=array();
      foreach($this->categorieVolgorde as $cat)
        if(!isset($omschrijvingen[$cat]))
          $omschrijvingen[$cat]=$cat;
       foreach($omschrijvingen as $cat=>$omschrijving)
       {
         if(isset($this->categorieVolgorde[$cat]))
           $newVolgorde[$cat]=$cat;
       }
      $this->categorieVolgorde=$newVolgorde;
    }
  
    $maxVal=max($totaleWaardeOpDatum);
    $minVal=min($totaleWaardeOpDatumNegatief);
   
    $numBars=count($data)-1;
    $maxVal=round($maxVal*1.1);
   

    $newMax=ceil($maxVal/(pow(10,strlen($maxVal))))*pow(10,strlen($maxVal));
    if($newMax>4*$maxVal)
      $maxVal=$newMax/4;
    elseif($newMax>2*$maxVal)
      $maxVal=$newMax/2;
    else
      $maxVal=$newMax;

   
    
    if($minVal >= 0)
      $minVal = 0;
 
    
    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);
    $margin = 0;
    $YstartGrafiek = $YPage;
    $hGrafiek = $h;
    $XstartGrafiek = $XPage;
    $bGrafiek = ($w ) ;//- ($w/6); // - legenda
    
    $n=0;
    foreach (($this->categorieVolgorde) as $categorie)//array_reverse
    {
      if(is_array($grafiekCategorie[$categorie]))
      {
        $this->pdf->Rect($XstartGrafiek+$n*20+3 , $YstartGrafiek+12, 2, 2, 'DF',null,$colors[$categorie]);
        $this->pdf->SetXY($XstartGrafiek+$n*20+6 ,$YstartGrafiek+11.5 );
        if(isset($omschrijvingen[$categorie]))
          $omschrijving=$omschrijvingen[$categorie];
        else
          $omschrijving=$categorie;
        $width=$this->pdf->GetStringWidth($omschrijving)+7;
        if($width>20)
          $extraWidth=$width-20;
        else
          $extraWidth=0;
        $this->pdf->MultiCell(20+$extraWidth, 4,$omschrijving,0,'L');
        $XstartGrafiek+=$extraWidth;
       // echo "$omschrijving $width $extraWidth<br>\n ";
        $n++;
      }
    }
    $XstartGrafiek = $XPage;
    
    if($minVal < 0)
    {
      $unit = $hGrafiek / (-1 * $minVal + $maxVal) * -1;
      $nulYpos =  $unit * (-1 * $minVal);
    }
    else
    {
      $unit = $hGrafiek / $maxVal * -1;
      $nulYpos =0;
    }
    
    
    $horDiv = 5;
    $horInterval = $hGrafiek / $horDiv;
    $bereik = $hGrafiek/$unit;
    
    $this->pdf->SetFont($this->pdf->rapport_font, '', 6);
    $this->pdf->SetTextColor(0,0,0);
    
    $stapgrootte = ceil(abs($bereik)/$horDiv);
    $top = $YstartGrafiek-$h;
    $bodem = $YstartGrafiek;
    $absUnit =abs($unit);
    
    $nulpunt = $YstartGrafiek + $nulYpos;
    $n=0;
    
    for($i=$nulpunt; $i<= $bodem; $i+= $absUnit*$stapgrootte)
    {
      $skipNull = true;
      $this->pdf->Line($XstartGrafiek, $i, $XstartGrafiek + $w ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      $this->pdf->SetXY($XstartGrafiek-12, $i-1.5);
      $this->pdf->Cell(10, 3, $this->formatGetal($n*$stapgrootte*-1)."",0,0,'R');
      $n++;
      if($n >20)
        break;
    }
    
    $n=0;
    for($i=$nulpunt; $i >= $top; $i-= $absUnit*$stapgrootte)
    {
      $this->pdf->Line($XstartGrafiek, $i, $XstartGrafiek + $w ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      if($skipNull == true)
        $skipNull = false;
      else
      {
        $this->pdf->SetXY($XstartGrafiek-12, $i-1.5);
        $this->pdf->Cell(10, 3, $this->formatGetal($n*$stapgrootte)."",0,0,'R');
      }
      $n++;
      if($n >20)
        break;
    }
    
    
    
    
    
    $vBar = ($bGrafiek/($numBars));
    
    
    //$XstartGrafiek+=$vBar*0.625;
    
    $this->pdf->SetLineStyle(array('dash' => 0,'color'=>array(0,0,0)));
    $this->pdf->SetLineWidth(0.2);
    
    $this->pdf->SetFillColor($color[0],$color[1],$color[2]);
    $i=0;
    
    $aantalData=count($grafiek)-1;
    $legendaPrinted=array();
    $xcorrectie=0;
    foreach ($grafiek as $datum=>$data)
    {
      //foreach($data as $categorie=>$val)
     // {
      foreach (($this->categorieVolgorde) as $categorie)//array_reverse
      {
        $val=$data[$categorie];
        if($i == 0)
        {
          $polly[$categorie][]=$XstartGrafiek+ ($i ) * $vBar;
          $polly[$categorie][]=$YstartGrafiek;
        }
        
        if(!isset($YstartGrafiekLast[$datum]))
          $YstartGrafiekLast[$datum] = $YstartGrafiek;
        //Bar
        $xval = $XstartGrafiek + ($i ) * $vBar ;
        $yval = $YstartGrafiekLast[$datum] + $nulYpos ;
        $hval = ($val * $unit);
        
        $yval2=$YstartGrafiekLast[$datum] + $nulYpos +($val * $unit);
        $YstartGrafiekLast[$datum] = $YstartGrafiekLast[$datum]+$hval;
        
        $lines[$categorie][]=array($XstartGrafiek + ($i* $vBar), $yval,$XstartGrafiek + (1 + $i ) * $vBar , $yval2);
        $marks[$categorie][]=array($XDiag+($i)*$unit-0.5-$xcorrectie, $yval2-0.5);
        //$this->pdf->Rect($XDiag+($i+1)*$unit-0.5-$xcorrectie, $yval2-0.5, 1, 1 ,'F','',$color);
        
        $returnPolly[$categorie][]=$XstartGrafiek +  $i* $vBar;
        $returnPolly[$categorie][]=$yval;
        $polly[$categorie][]=$XstartGrafiek + ($i) * $vBar;
        $polly[$categorie][]=$yval2;
        
        if($i == $aantalData)
        {
          $polly[$categorie][]=$XstartGrafiek + ($i) * $vBar;
          $polly[$categorie][]=$YstartGrafiek;
        }
        
        $this->pdf->SetTextColor(0,0,0);
        if($legendaPrinted[$datum] != 1)
        {
          $maand = date('n',db2jul($datum));
          $this->pdf->TextWithRotation($xval-2,$YstartGrafiek+7,$legenda[$datum],25);
          $this->pdf->line($xval,$YstartGrafiek, $xval,$YstartGrafiek+1);
        }
        $legendaPrinted[$datum] = 1;
        
        $lastCategorie=$categorie;
      }
      
      $i++;
      $lastDatum=$datum;
    }
    
    foreach(array_reverse($polly) as $categorie=>$pol)
      $this->pdf->Polygon($pol, 'F', null, $colors[$categorie]) ;
    
    $i=0;
    $YstartGrafiekLast=array();
    foreach ($grafiekNegatief as $datum=>$data)
    {
      foreach($data as $categorie=>$val)
      {
        if(!isset($YstartGrafiekLast[$datum]))
          $YstartGrafiekLast[$datum] = $YstartGrafiek;
        //Bar
        $xval = $XstartGrafiek + (1 + $i ) * $vBar - $eBaton / 2;
        $lval = $eBaton;
        $yval = $YstartGrafiekLast[$datum] + $nulYpos ;
        $hval = ($val * $unit);
        
        $this->pdf->Rect($xval, $yval, $lval, $hval, 'DF',null,$colors[$categorie]);
        $YstartGrafiekLast[$datum] = $YstartGrafiekLast[$datum]+$hval;
        $this->pdf->SetTextColor(255,255,255);
        if(abs($hval) > 3)
        {
          $this->pdf->SetXY($xval, $yval+($hval/2)-2);
          $this->pdf->Cell($eBaton, 4, number_format($val,1,',','.')."%",0,0,'C');
        }
        $this->pdf->SetTextColor(0,0,0);
        
        if($grafiekPunt[$categorie][$datum])
        {
          $this->pdf->Rect($xval+.5*$eBaton-.5, $grafiekPunt[$categorie][$datum] * $unit + $YstartGrafiek -.5 , 1, 1, 'DF',null,array(194,179,157));
          if($lastX)
            $this->pdf->line($lastX,$lastY,$xval+.5*$eBaton, $grafiekPunt[$categorie][$datum] * $unit + $YstartGrafiek);
          $lastX = $xval+.5*$eBaton;
          $lastY = $grafiekPunt[$categorie][$datum] * $unit + $YstartGrafiek;
        }
      }
      $i++;
    }
    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);
  }
  
  
  function VBarDiagram2($w, $h, $data,$metLijn=false)
  {
    global $__appvar;

    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);
    
    $XPage = $this->pdf->GetX();
    $YPage = $this->pdf->GetY();
    $margin = 0;
    $YstartGrafiek = $YPage - floor($margin * 1);
    $hGrafiek = ($h - $margin * 1);
    $XstartGrafiek = $XPage + $margin * 1 ;
    $bGrafiek = ($w - $margin * 1);
    
    //$this->pdf->Rect($XstartGrafiek, $YstartGrafiek-$hGrafiek, $w- $margin, $hGrafiek,'D',''); //,array(245,245,245)
    $color=array(155,155,155);
    
    $maxVal=0;
    $minVal=0;
    $maanden=array();
    $aantalStaven=0;
    foreach($data as $maand=>$maandData)
    {
      if($aantalStaven==0)
        $aantalStaven=count($maandData);
      $maanden[$maand]=$maand;
      foreach($maandData as $type=>$waarde)
      {
        if($waarde > $maxVal)
          $maxVal = $waarde;
        if($waarde < $minVal)
          $minVal = $waarde;
      }
    }
    if($metLijn==true)
      $aantalStaven=$aantalStaven/2;
    if($maxVal > 1)
      $maxVal=ceil($maxVal);
    if($minVal < -1)
      $minVal=floor($minVal);
    $minVal = $minVal * 1.1;
    $maxVal = $maxVal * 1.1;
    if ($maxVal <0)
      $maxVal=0;
    
    if($minVal < 0)
    {
      $unit = $hGrafiek / (-1 * $minVal + $maxVal) * -1;
      $nulYpos =  $unit * (-1 * $minVal);
    }
    else
    {
      $unit = $hGrafiek / $maxVal * -1;
      $nulYpos =0;
    }
    
    $horDiv = 10;
    $horInterval = $hGrafiek / $horDiv;
    $bereik = $hGrafiek/$unit;
    
    $this->pdf->SetFont($this->pdf->rapport_font, '', 6);
    $this->pdf->SetTextColor(0,0,0);
    
    $stapgrootte = ceil(abs($bereik)/$horDiv*10)/10;
    $top = $YstartGrafiek-$h;
    $bodem = $YstartGrafiek;
    $absUnit =abs($unit);
    
    $nulpunt = $YstartGrafiek + $nulYpos;
    $n=0;
    
    for($i=$nulpunt; $i< $bodem; $i+= $absUnit*$stapgrootte)
    {
      $skipNull = true;
      $this->pdf->Line($XstartGrafiek, $i, $XstartGrafiek + $bGrafiek ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      $this->pdf->Text($XstartGrafiek-7, $i, -1*$n*$stapgrootte." %");
      $n++;
      if($n >20)
        break;
    }
    
    $n=0;
    for($i=$nulpunt; $i > $top; $i-= $absUnit*$stapgrootte)
    {
      $this->pdf->Line($XstartGrafiek, $i, $XstartGrafiek + $bGrafiek ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      if($skipNull == true)
        $skipNull = false;
      else
        $this->pdf->Text($XstartGrafiek-7, $i, $n*$stapgrootte." %");
      $n++;
      if($n >20)
        break;
    }
    
    $numBars=count($data);
    if($numBars > 0)
      $this->pdf->NbVal=$numBars;
  
  
    $this->pdf->SetFillColor();
    
    $colors=array('performance'=>array($this->pdf->rapport_kop_bgcolor['r'],$this->pdf->rapport_kop_bgcolor['g'],$this->pdf->rapport_kop_bgcolor['b']),
      'benchmark'=>array(50,50,100));//,'totaalEffect'=>array(0, 52, 121)); //
    

    
    $vBar = ($bGrafiek / ($this->pdf->NbVal))/($aantalStaven+1); //4
    $bGrafiek = $vBar * ($this->pdf->NbVal);
    $eBaton = ($vBar * 80 / 100);
    $this->pdf->SetLineStyle(array('dash' => 0,'color'=>array(0,0,0)));
    $this->pdf->SetLineWidth(0.2);
    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);
    $this->pdf->SetFillColor($color[0],$color[1],$color[2]);
    $i=0;
    
    $this->pdf->SetFont($this->pdf->rapport_font, '', 6);
    $lastXY=array();
    foreach($data as $periode=>$maandData)
    {
     
      foreach($maandData as $type=>$val)
      {
        if($metLijn==true)
        {
          //listarray($type);
          if(substr($type,-4)=='Cumu')
          {
            continue;
          }
          
        }
        
        $color=$colors[$type];
        $legenda[$type]=$color;
        //Bar
        $xval = $XstartGrafiek + ($i + 1) * $vBar - $eBaton / 2;
        $lval = $eBaton;
        $yval = $YstartGrafiek + $nulYpos;
        $hval = ($val * $unit);
        $this->pdf->Rect($xval, $yval, $lval, $hval, 'DF',null,$color);
        /*
        $this->pdf->SetTextColor(255,255,255);
        if(abs($hval) > 3 && $eBaton > 4)
        {
          $this->pdf->SetXY($xval, $yval+($hval/2)-2);
          $this->pdf->Cell($eBaton, 4, number_format($val,1,',','.')."%",0,0,'C');
        }
        $this->pdf->SetTextColor(0,0,0);
        */
        $i++;
      }
      $i++;
      if(strlen($periode)==4)
        $xLegenda=$periode;
      else
        $xLegenda=date('M',db2jul($periode));
      
      $this->pdf->Text($XstartGrafiek + ($i-1) * $vBar - $eBaton / 2,$YstartGrafiek +3 ,$xLegenda);

    }
  
    $xPos=$XstartGrafiek;
    foreach($data as $periode=>$maandData)
    {

      foreach($maandData as $type=>$val)
      {
        if($metLijn==true)
        {
          //listarray($type);
          if(substr($type,-4)=='Cumu')
          {
            //echo "$type $periode $val <br>\n";
        
            $color=$colors[substr($type,0,-4)];
            if(!isset($lastXY[$type]))
              $lastXY[$type]=array($XstartGrafiek,$YstartGrafiek + $nulYpos);
        
            $newXY=array($xPos + $vBar ,$YstartGrafiek + $nulYpos+($val * $unit));
  
            if($type=='benchmarkCumu')
              $this->pdf->Line($lastXY[$type][0], $lastXY[$type][1] , $newXY[0],$newXY[1] ,array('dash' => "1,2",'color'=>array(0,0,0)));
            else
              $this->pdf->Line($lastXY[$type][0], $lastXY[$type][1] , $newXY[0],$newXY[1] ,array('dash' => 0,'color'=>array(0,0,0)));
            $this->pdf->setDash(0);
            $this->pdf->setDrawColor(0);
            $this->pdf->Rect($newXY[0]-0.5, $newXY[1]-0.5 , 1, 1, 'DF',null,array(0,0,0));
            
        
            $lastXY[$type]=array( $newXY[0],$newXY[1]);
            $xPos+=$vBar;
          }
      
        }

      }
      $xPos+=$vBar;
    }
    
      $n=0;
    $omschrijvingen=array('performance'=>'Portefeuille','benchmark'=>'Benchmark');
    $this->pdf->setDash(0);
    foreach($legenda as $type=>$kleur)
    {
      if($type=='benchmark')
      {
        $this->pdf->Line($XstartGrafiek+6, $YstartGrafiek+10+($n*4)+1 , $XstartGrafiek+8, $YstartGrafiek+10+($n*4)+1,array('dash' => "1,2",'color'=>array(0,0,0)));
        $this->pdf->setDash(0);
      }
      else
      {
        $this->pdf->Line($XstartGrafiek+6, $YstartGrafiek+10+($n*4)+1 , $XstartGrafiek+8, $YstartGrafiek+10+($n*4)+1,array('dash' => 0,'color'=>array(0,0,0)));
      }
  
      
      $this->pdf->Rect($XstartGrafiek+10, $YstartGrafiek+10+($n*4), 2, 2, 'DF',null,$kleur);
  
      $this->pdf->Text($XstartGrafiek+14, $YstartGrafiek+10+($n*4)+1.5, vertaalTekst($omschrijvingen[$type],$this->pdf->rapport_taal));
  
      $n++;
    }
    
    
    
    // $color=array(155,155,155);
    // $this->pdf->SetFillColor($color[0],$color[1],$color[2]);
  }
}
?>