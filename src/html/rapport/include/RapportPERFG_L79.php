<?php
/*
    AE-ICT source module
    Author  						: $Author: rvv $
 		Laatste aanpassing	: $Date: 2019/10/16 15:23:48 $
 		File Versie					: $Revision: 1.3 $

 		$Log: RapportPERFG_L79.php,v $
 		Revision 1.3  2019/10/16 15:23:48  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2019/10/12 17:11:44  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2019/10/09 15:11:04  rvv
 		*** empty log message ***
 		
 		Revision 1.9  2019/03/23 17:05:54  rvv
 		*** empty log message ***
 		
 		Revision 1.8  2019/02/23 18:32:59  rvv
 		*** empty log message ***
 		
 		Revision 1.7  2019/02/06 16:07:12  rvv
 		*** empty log message ***
 		
 		Revision 1.6  2019/01/20 12:14:00  rvv
 		*** empty log message ***
 		
 		Revision 1.5  2018/12/30 07:39:13  rvv
 		*** empty log message ***
 		
 		Revision 1.4  2018/12/29 13:57:23  rvv
 		*** empty log message ***
 		
 		Revision 1.3  2018/12/15 17:49:14  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2018/11/28 17:08:43  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2018/11/24 19:10:45  rvv
 		*** empty log message ***
 		
 		Revision 1.14  2018/07/28 14:45:48  rvv
 		*** empty log message ***
 		
 		Revision 1.13  2018/07/25 15:37:42  rvv
 		*** empty log message ***
 		
 		Revision 1.12  2018/07/21 15:54:40  rvv
 		*** empty log message ***
 		
 		Revision 1.11  2018/07/07 17:35:19  rvv
 		*** empty log message ***
 		
 		Revision 1.10  2018/07/04 08:25:01  rvv
 		*** empty log message ***
 		
 		Revision 1.9  2018/06/30 17:43:55  rvv
 		*** empty log message ***
 		
 		Revision 1.8  2018/06/16 17:42:56  rvv
 		*** empty log message ***
 		
 		Revision 1.7  2018/06/10 11:45:56  rvv
 		*** empty log message ***
 		
 		Revision 1.6  2018/06/09 15:58:54  rvv
 		*** empty log message ***
 		
 		Revision 1.5  2018/05/30 16:10:58  rvv
 		*** empty log message ***
 		
 		Revision 1.4  2018/05/19 16:24:53  rvv
 		*** empty log message ***
 		
 		Revision 1.3  2018/04/07 15:21:44  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2018/03/31 18:06:01  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2018/03/14 17:17:41  rvv
 		*** empty log message ***
 		
 		Revision 1.28  2017/11/08 17:12:56  rvv
 		*** empty log message ***
 		
 		Revision 1.27  2017/10/08 14:09:23  rvv
 		*** empty log message ***
 		
 		Revision 1.26  2017/09/06 16:31:45  rvv
 		*** empty log message ***
 		
 		Revision 1.25  2017/07/09 11:57:36  rvv
 		*** empty log message ***
 		
 		Revision 1.24  2017/07/06 11:39:20  rvv
 		*** empty log message ***
 		
 		Revision 1.23  2017/07/01 11:16:18  rvv
 		*** empty log message ***
 		
 		Revision 1.22  2017/06/18 09:18:24  rvv
 		*** empty log message ***
 		
 		Revision 1.21  2017/05/25 14:35:58  rvv
 		*** empty log message ***
 		
 		Revision 1.20  2017/04/29 17:26:01  rvv
 		*** empty log message ***
 		
 		Revision 1.19  2017/03/31 15:39:22  rvv
 		*** empty log message ***
 		
 		Revision 1.18  2017/03/29 15:57:04  rvv
 		*** empty log message ***
 		
 		Revision 1.17  2017/03/23 11:44:51  rvv
 		*** empty log message ***
 		
 		Revision 1.16  2017/03/22 16:53:22  rvv
 		*** empty log message ***
 		
 		Revision 1.15  2017/03/18 20:30:12  rvv
 		*** empty log message ***
 		
 		Revision 1.14  2017/03/11 20:27:43  rvv
 		*** empty log message ***
 		
 		Revision 1.13  2017/02/25 18:02:29  rvv
 		*** empty log message ***
 		
 		Revision 1.12  2017/01/04 16:22:50  rvv
 		*** empty log message ***
 		
 		Revision 1.11  2016/12/18 09:08:13  rvv
 		*** empty log message ***
 		
 		Revision 1.10  2016/12/17 16:33:26  rvv
 		*** empty log message ***
 		
 		Revision 1.9  2016/10/02 12:38:58  rvv
 		*** empty log message ***
 		
 		Revision 1.8  2016/09/18 08:49:02  rvv
 		*** empty log message ***
 		
 		Revision 1.7  2016/06/19 16:10:48  rvv
 		*** empty log message ***
 		
 		Revision 1.6  2016/06/19 15:22:08  rvv
 		*** empty log message ***
 		
 		Revision 1.5  2016/06/12 10:27:20  rvv
 		*** empty log message ***
 		
 		Revision 1.4  2016/05/29 13:26:30  rvv
 		*** empty log message ***
 		
 		Revision 1.3  2016/05/25 14:15:31  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2016/05/08 19:24:24  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2016/05/04 16:08:25  rvv
 		*** empty log message ***
 		
 		Revision 1.21  2015/03/14 17:01:49  rvv
 		*** empty log message ***
 		
 		Revision 1.20  2015/03/04 16:30:29  rvv
 		*** empty log message ***
 		
 		Revision 1.19  2015/03/01 14:08:16  rvv
 		*** empty log message ***
 		
 		Revision 1.18  2014/11/05 16:52:22  rvv
 		*** empty log message ***
 		
 	

*/

include_once("rapportRekenClass.php");
include_once($__appvar["basedir"]."/html/rapport/rapportVertaal.php");

include_once($__appvar["basedir"]."/html/rapport/rapportSDberekening.php");

//ini_set('max_execution_time',60);
class RapportPERFG_L79
{
	function RapportPERFG_L79($pdf, $portefeuille, $rapportageDatumVanaf, $rapportageDatum)
	{
		$this->pdf = &$pdf;
		$this->pdf->rapport_type = "PERFG";
		$this->pdf->rapport_datum = db2jul($rapportageDatum);
		$this->pdf->rapport_datumvanaf = db2jul($rapportageDatumVanaf);
		$this->pdf->rapport_titel = "";
		$this->portefeuille = $portefeuille;
		$this->rapportageDatumVanaf = $rapportageDatumVanaf;
		$this->rapportageDatum = $rapportageDatum;
    $this->pdf->excelData[]=array();
    $this->standaarddeviatieMarge=array();
    
    
    $query = "SELECT Portefeuilles.startDatum, Clienten.Naam, Clienten.Naam1, Portefeuilles.Depotbank, Portefeuilles.AEXVergelijking, Portefeuilles.SpecifiekeIndex, Portefeuilles.Vermogensbeheerder, Portefeuilles.ClientVermogensbeheerder, Portefeuilles.Risicoklasse, Portefeuilles.Client FROM Portefeuilles, Clienten WHERE Portefeuille = '".$this->portefeuille."' AND Portefeuilles.Client = Clienten.Client ";
    $DB = new DB();
    $DB->SQL($query);
    $DB->Query();
    $portefeuilledata = $DB->nextRecord();
    $portefeuilleStartJul=db2jul($portefeuilledata['startDatum']) ;
    $this->portefeuilleStart=substr($portefeuilledata['startDatum'],0,10);
    if($portefeuilleStartJul < db2jul(date("Y-01-01",$this->pdf->rapport_datumvanaf)))
      $rapportageStartJaar= date("Y-01-01",$this->pdf->rapport_datumvanaf);
    else
      $rapportageStartJaar=date('Y-m-d',($portefeuilleStartJul));
    $this->tweedePerformanceStart=$rapportageStartJaar;
    
    $this->pdf->rowHeightBackup=$this->pdf->rowHeight;
    $this->pdf->rowHeight=6;
    $this->fontsize=12;
    
  }

	function formatGetal($waarde, $dec)
	{
		return number_format($waarde,$dec,",",".");
	}

	function formatGetalKoers($waarde, $dec , $start = false)
	{
	  if ($start == false)
	    $waarde = $waarde / $this->pdf->ValutaKoersEind;
	  else
	    $waarde = $waarde / $this->pdf->ValutaKoersStart;

	  return number_format($waarde,$dec,",",".");
  }



	function writeRapport()
	{

		global $__appvar;
		$this->pdf->SetLineWidth($this->pdf->lineWidth);

		$DB = new DB();

		// voor data
		$this->pdf->widthA = array(5,80,30,5,30,5,30,120);
		$this->pdf->alignA = array('L','L','R','L','R');

		// voor kopjes
		$this->pdf->widthB = array(0,85,30,5,30,5,30,120);
		$this->pdf->alignB = array('L','L','R','L','R');
  

		$this->pdf->AddPage();
    $this->pdf->templateVars[$this->pdf->rapport_type.'Paginas']=$this->pdf->page;
    $this->pdf->templateVarsOmschrijving[$this->pdf->rapport_type.'Paginas']=$this->pdf->rapport_titel;
    
    $index=new indexHerberekening();
    $kwartaalWaarden=$index->getWaarden( $this->portefeuilleStart,$this->rapportageDatum,$this->portefeuille,'','jaar'); //$this->rapportageDatumVanaf
    $lijnData=array('titel'=>'Ontwikkeling Eigen Vermogen');
    foreach($kwartaalWaarden as $data)
    {
      $lijnData['datum'][]=$data['datum'];
      $lijnData['portefeuille'][]=$data['waardeHuidige'];
    }

    
    //$this->VBarDiagram(20,82,123-40,50,$barData,'Ontwikkeling vermogen sinds start');
    $this->pdf->setXY(45,50);
    $this->LineDiagram(200,100, $lijnData);

  }
  
  
  function LineDiagram($w, $h, $data, $color=null, $maxVal=0, $minVal=0, $horDiv=4, $verDiv=4, $afmMinMax=false,$eerstePunt=false)
  {
    global $__appvar;

    $legendDatum= $data['datum'];
    $legendaItems= $data['legenda'];
    $titel=$data['titel'];
    $data1 = $data['specifiekeIndex'];
    $data2 = $data['extra'];
    $data = $data['portefeuille'];


    if(count($data2)>0)
      $bereikdata = array_merge(array_values($data),array_values($data1),array_values($data2));
    elseif(count($data1)>0)
      $bereikdata = array_merge(array_values($data),array_values($data1));
    else
      $bereikdata =  array_values($data);
    $this->pdf->SetTextColor(89,89,89);
    $this->pdf->SetDrawColor(89,89,89);

    if($afmMinMax==true)
    {
      $bereikdata[]=$this->standaarddeviatieMarge['Minimum'];
      $bereikdata[]=$this->standaarddeviatieMarge['Maximum'];
    }
    $XPage = $this->pdf->GetX();
    $YPage = $this->pdf->GetY();
    $margin = 0;
    $YDiag = $YPage + $margin;
    $hDiag = floor($h - $margin * 1);
    $XDiag = $XPage + $margin * 1 ;
    $lDiag = floor($w - $margin * 1 );
    
    $this->pdf->SetFont($this->pdf->rapport_font,'b',$this->pdf->rapport_fontsize);
    $this->pdf->setXY($XPage, $YPage-4);
    $this->pdf->Cell($w,0, vertaalTekst($titel,$this->pdf->rapport_taal),0,0,'L');
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
    $this->pdf->SetLineStyle(array('width' => 0.3, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => array(89,89,89)));

    //$this->pdf->Rect($XDiag, $YDiag, $w-$margin, $h,'D');//'FD','',array(245,245,245));
    $this->pdf->line($XDiag, $YDiag+$h, $XDiag+$w-$margin, $YDiag+$h);
    $this->pdf->line($XDiag, $YDiag, $XDiag, $YDiag+$h);
    if(is_array($color[0]))
    {
      $color2= $color[2];
      $color1= $color[1];
      $color = $color[0];
    }
  
  

    
    
    if($color == null)
      $color=array(49,133,156);
    $this->pdf->SetLineWidth(0.2);

    $this->pdf->SetFillColor($color[0],$color[1],$color[2]);

    if ($maxVal == 0)
    {
      $maxVal = ceil(max($bereikdata));
    }
    if ($minVal == 0)
    {
      $minVal = floor(min($bereikdata));
    }

    $minVal = floor(($minVal-1) * 1.1);
    if($minVal > 0)
      $minVal=0;
    $maxVal = ceil(($maxVal+1) * 1.1);
    $legendYstep = ($maxVal - $minVal) / $horDiv;
    $verInterval = ($lDiag / $verDiv);
    $horInterval = ($hDiag / $horDiv);
    $waardeCorrectie = $hDiag / ($maxVal - $minVal);
    $unit = $lDiag / count($data);

    for ($i = 0; $i <= $verDiv; $i++) //x-as verdeling
      $xpos = $XDiag + $verInterval * $i;

    $this->pdf->SetFont($this->pdf->rapport_font, '', 8);


    $stapgrootte = ceil(abs($maxVal - $minVal)/$horDiv);
    $unith = $hDiag / (-1 * $minVal + $maxVal);

    $top = $YPage;
    $bodem = $YDiag+$hDiag;
    $absUnit =abs($unith);

    $nulpunt = $YDiag + (($maxVal) * $waardeCorrectie);
    $n=0;
    $yAs='';
  
  //  $this->pdf->Line($XDiag, $nulpunt, $XPage+$w ,$nulpunt,array('dash' => 2,'color'=>array(128,128,128)));
    
    for($i=$nulpunt; $i<= $bodem; $i+= $absUnit*$stapgrootte)
    {
      $skipNull = true;
     // $this->pdf->Line($XDiag, $i, $XPage+$w ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      //$this->pdf->Text($XDiag-7, $i, 0-($n*$stapgrootte) .$yAs);
      $this->pdf->Line($XDiag, $i, $XDiag-1 ,$i,array('color'=>array(0,0,0)));
      $this->pdf->setXY($XDiag-11, $i-2);
      $this->pdf->cell(10,4,$this->formatGetal(0-($n*$stapgrootte)/1000000,1) .$yAs,0,1,'R');
      $n++;
      if($n >20)
       break;
    }

    $n=0;

    
    for($i=$nulpunt; $i >= $top-1; $i-= $absUnit*$stapgrootte)
    {
     // $this->pdf->Line($XDiag, $i, $XPage+$w ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      if($skipNull == true)
        $skipNull = false;
      else
      {
        $this->pdf->setXY($XDiag-11, $i-2);
        $this->pdf->cell(10,4,$this->formatGetal(($n*$stapgrootte)/1000000,1) . $yAs,0,1,'R');
        $this->pdf->Line($XDiag, $i, $XDiag-1 ,$i,array('color'=>array(0,0,0)));

       // $this->pdf->Text($XDiag - 7, $i, ($n * $stapgrootte) + 0 . $yAs);
      }
      $n++;
      if($n >20)
         break;
    }
  
    $this->pdf->SetFont($this->pdf->rapport_font, '', 8);
    $this->pdf->TextWithRotation($XDiag-8,$YPage+$hDiag/2,'(x 1 miljoen)',90);
  
    if($afmMinMax==true)
    {
      $lineStyle = array('width' => 0.5, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => array(50,50,50));
      $yval = $YDiag + (($maxVal-$this->standaarddeviatieMarge['Minimum']) * $waardeCorrectie) ;
      $this->pdf->line($XDiag, $yval, $XPage+$w, $yval,$lineStyle );
      $this->pdf->Text($XDiag+$w, $yval,"Min.");
      
       $yval = $YDiag + (($maxVal-$this->standaarddeviatieMarge['Maximum']) * $waardeCorrectie) ;
      $this->pdf->line($XDiag, $yval, $XPage+$w, $yval,$lineStyle );
      $this->pdf->Text($XDiag+$w, $yval,"Max.");     
    }
    
    $yval = $YDiag + (($maxVal) * $waardeCorrectie) ;
    $lineStyle = array('width' => 0.5, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => $color);
    $jaren=ceil(count($data)/12);
    //for ($i=0; $i<count($data); $i++)
    $i=0;
    $start=false;
    $this->pdf->SetDrawColor($color[0],$color[1],$color[2]);
    foreach($data as $datum=>$waarde)
    {
      if($i%$jaren==0)
      {
        $this->pdf->SetFont($this->pdf->rapport_font, '', 6);
       // $this->pdf->TextWithRotation($XDiag + ($i) * $unit - 5 + $unit, $YDiag + $hDiag + 8, $legendDatum[$datum], 25);
        //$this->pdf->TextWithRotation($XDiag + ($i) * $unit - 5 + $unit, $YDiag + $hDiag + 8,'Q'.ceil(substr($legendDatum[$datum],5,2)/3).'-'.substr($legendDatum[$datum],0,4),30);
        $this->pdf->TextWithRotation($XDiag + ($i) * $unit - 5 + $unit, $YDiag + $hDiag + 8,substr($legendDatum[$datum],0,4),30);
        
        $this->pdf->SetFont($this->pdf->rapport_font, '', 8);
      }
      $yval2 = $YDiag + (($maxVal-$waarde) * $waardeCorrectie) ;
      
      if ($i>0 && $start==true || $eerstePunt==true)
      {
        $this->pdf->line($XDiag+$i*$unit, $yval, $XDiag+($i+1)*$unit, $yval2,$lineStyle );
  
        
  
        
      }
      $this->pdf->Rect($XDiag+($i+1)*$unit-.5, $yval2-.5, 1, 1, 'DF',null,array($color[0],$color[1],$color[2]));
     // $this->pdf->TextWithRotation($XDiag+($i+1)*$unit, $yval2, $this->formatGetal($waarde/1000000,1), 0);
      
      if($waarde<>0)
        $start=true;

      $yval = $yval2;
      $i++;
    }
  
    $i=0;
    foreach($data as $datum=>$waarde)
    {
      $yval2 = $YDiag + (($maxVal-$waarde) * $waardeCorrectie) ;
      $this->pdf->TextWithRotation($XDiag+($i+1)*$unit-2, $yval2-2, $this->formatGetal($waarde/1000000,1), 0);
      $i++;
    }
    

    $this->pdf->SetLineStyle(array('color'=>array(0,0,0),'width' => 0.2,'cap' => 'butt'));
    $this->pdf->SetDrawColor(0,0,0);
    $this->pdf->SetFillColor(0,0,0);
  }
 

}
?>