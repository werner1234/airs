<?php
/*
    AE-ICT source module
    Author  						: $Author: rvv $
 		Laatste aanpassing	: $Date: 2020/01/22 16:07:06 $
 		File Versie					: $Revision: 1.10 $

 		$Log: RapportATT_L79.php,v $
 		Revision 1.10  2020/01/22 16:07:06  rvv
 		*** empty log message ***
 		
 		Revision 1.9  2019/03/23 17:05:54  rvv
 		*** empty log message ***
 		
 		Revision 1.8  2019/02/23 18:32:59  rvv
 		*** empty log message ***
 		
 		Revision 1.7  2019/02/06 16:07:12  rvv
 		*** empty log message ***
 		
 		Revision 1.6  2019/01/20 12:14:00  rvv
 		*** empty log message ***
 		
 		Revision 1.5  2018/12/30 07:39:13  rvv
 		*** empty log message ***
 		
 		Revision 1.4  2018/12/29 13:57:23  rvv
 		*** empty log message ***
 		
 		Revision 1.3  2018/12/15 17:49:14  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2018/11/28 17:08:43  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2018/11/24 19:10:45  rvv
 		*** empty log message ***
 		
 		Revision 1.14  2018/07/28 14:45:48  rvv
 		*** empty log message ***
 		
 		Revision 1.13  2018/07/25 15:37:42  rvv
 		*** empty log message ***
 		
 		Revision 1.12  2018/07/21 15:54:40  rvv
 		*** empty log message ***
 		
 		Revision 1.11  2018/07/07 17:35:19  rvv
 		*** empty log message ***
 		
 		Revision 1.10  2018/07/04 08:25:01  rvv
 		*** empty log message ***
 		
 		Revision 1.9  2018/06/30 17:43:55  rvv
 		*** empty log message ***
 		
 		Revision 1.8  2018/06/16 17:42:56  rvv
 		*** empty log message ***
 		
 		Revision 1.7  2018/06/10 11:45:56  rvv
 		*** empty log message ***
 		
 		Revision 1.6  2018/06/09 15:58:54  rvv
 		*** empty log message ***
 		
 		Revision 1.5  2018/05/30 16:10:58  rvv
 		*** empty log message ***
 		
 		Revision 1.4  2018/05/19 16:24:53  rvv
 		*** empty log message ***
 		
 		Revision 1.3  2018/04/07 15:21:44  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2018/03/31 18:06:01  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2018/03/14 17:17:41  rvv
 		*** empty log message ***
 		
 		Revision 1.28  2017/11/08 17:12:56  rvv
 		*** empty log message ***
 		
 		Revision 1.27  2017/10/08 14:09:23  rvv
 		*** empty log message ***
 		
 		Revision 1.26  2017/09/06 16:31:45  rvv
 		*** empty log message ***
 		
 		Revision 1.25  2017/07/09 11:57:36  rvv
 		*** empty log message ***
 		
 		Revision 1.24  2017/07/06 11:39:20  rvv
 		*** empty log message ***
 		
 		Revision 1.23  2017/07/01 11:16:18  rvv
 		*** empty log message ***
 		
 		Revision 1.22  2017/06/18 09:18:24  rvv
 		*** empty log message ***
 		
 		Revision 1.21  2017/05/25 14:35:58  rvv
 		*** empty log message ***
 		
 		Revision 1.20  2017/04/29 17:26:01  rvv
 		*** empty log message ***
 		
 		Revision 1.19  2017/03/31 15:39:22  rvv
 		*** empty log message ***
 		
 		Revision 1.18  2017/03/29 15:57:04  rvv
 		*** empty log message ***
 		
 		Revision 1.17  2017/03/23 11:44:51  rvv
 		*** empty log message ***
 		
 		Revision 1.16  2017/03/22 16:53:22  rvv
 		*** empty log message ***
 		
 		Revision 1.15  2017/03/18 20:30:12  rvv
 		*** empty log message ***
 		
 		Revision 1.14  2017/03/11 20:27:43  rvv
 		*** empty log message ***
 		
 		Revision 1.13  2017/02/25 18:02:29  rvv
 		*** empty log message ***
 		
 		Revision 1.12  2017/01/04 16:22:50  rvv
 		*** empty log message ***
 		
 		Revision 1.11  2016/12/18 09:08:13  rvv
 		*** empty log message ***
 		
 		Revision 1.10  2016/12/17 16:33:26  rvv
 		*** empty log message ***
 		
 		Revision 1.9  2016/10/02 12:38:58  rvv
 		*** empty log message ***
 		
 		Revision 1.8  2016/09/18 08:49:02  rvv
 		*** empty log message ***
 		
 		Revision 1.7  2016/06/19 16:10:48  rvv
 		*** empty log message ***
 		
 		Revision 1.6  2016/06/19 15:22:08  rvv
 		*** empty log message ***
 		
 		Revision 1.5  2016/06/12 10:27:20  rvv
 		*** empty log message ***
 		
 		Revision 1.4  2016/05/29 13:26:30  rvv
 		*** empty log message ***
 		
 		Revision 1.3  2016/05/25 14:15:31  rvv
 		*** empty log message ***
 		
 		Revision 1.2  2016/05/08 19:24:24  rvv
 		*** empty log message ***
 		
 		Revision 1.1  2016/05/04 16:08:25  rvv
 		*** empty log message ***
 		
 		Revision 1.21  2015/03/14 17:01:49  rvv
 		*** empty log message ***
 		
 		Revision 1.20  2015/03/04 16:30:29  rvv
 		*** empty log message ***
 		
 		Revision 1.19  2015/03/01 14:08:16  rvv
 		*** empty log message ***
 		
 		Revision 1.18  2014/11/05 16:52:22  rvv
 		*** empty log message ***
 		
 	

*/

include_once("rapportRekenClass.php");
include_once($__appvar["basedir"]."/html/rapport/rapportVertaal.php");

include_once($__appvar["basedir"]."/html/rapport/rapportSDberekening.php");

//ini_set('max_execution_time',60);
class RapportATT_L79
{
	function RapportATT_L79($pdf, $portefeuille, $rapportageDatumVanaf, $rapportageDatum)
	{
		$this->pdf = &$pdf;
		$this->pdf->rapport_type = "ATT";
		$this->pdf->rapport_datum = db2jul($rapportageDatum);
		$this->pdf->rapport_datumvanaf = db2jul($rapportageDatumVanaf);
		$this->pdf->rapport_titel = "";
		$this->portefeuille = $portefeuille;
		$this->rapportageDatumVanaf = $rapportageDatumVanaf;
		$this->rapportageDatum = $rapportageDatum;
    $this->pdf->excelData[]=array();
    $this->standaarddeviatieMarge=array();
    
    
    $query = "SELECT Portefeuilles.startDatum, Clienten.Naam, Clienten.Naam1, Portefeuilles.Depotbank, Portefeuilles.AEXVergelijking, Portefeuilles.SpecifiekeIndex, Portefeuilles.Vermogensbeheerder, Portefeuilles.ClientVermogensbeheerder, Portefeuilles.Risicoklasse, Portefeuilles.Client FROM Portefeuilles, Clienten WHERE Portefeuille = '".$this->portefeuille."' AND Portefeuilles.Client = Clienten.Client ";
    $DB = new DB();
    $DB->SQL($query);
    $DB->Query();
    $portefeuilledata = $DB->nextRecord();
    $portefeuilleStartJul=db2jul($portefeuilledata['startDatum']) ;
    $this->portefeuilleStart=substr($portefeuilledata['startDatum'],0,10);
    if($portefeuilleStartJul < db2jul(date("Y-01-01",$this->pdf->rapport_datumvanaf)))
      $rapportageStartJaar= date("Y-01-01",$this->pdf->rapport_datumvanaf);
    else
      $rapportageStartJaar=date('Y-m-d',($portefeuilleStartJul));
    $this->tweedePerformanceStart=$rapportageStartJaar;
    
    $this->pdf->rowHeightBackup=$this->pdf->rowHeight;
    $this->pdf->rowHeight=6;
    $this->fontsize=12;
    
  }

	function formatGetal($waarde, $dec)
	{
		return number_format($waarde,$dec,",",".");
	}

	function formatGetalKoers($waarde, $dec , $start = false)
	{
	  if ($start == false)
	    $waarde = $waarde / $this->pdf->ValutaKoersEind;
	  else
	    $waarde = $waarde / $this->pdf->ValutaKoersStart;

	  return number_format($waarde,$dec,",",".");
  }



	function writeRapport()
	{

		global $__appvar;
		$this->pdf->SetLineWidth($this->pdf->lineWidth);

		$DB = new DB();

		// voor data
		$this->pdf->widthA = array(5,80,30,5,30,5,30,120);
		$this->pdf->alignA = array('L','L','R','L','R');

		// voor kopjes
		$this->pdf->widthB = array(0,85,30,5,30,5,30,120);
		$this->pdf->alignB = array('L','L','R','L','R');
    $this->getKleuren();

		$this->pdf->AddPage();
    $this->pdf->templateVars[$this->pdf->rapport_type.'Paginas']=$this->pdf->page;
    $this->pdf->templateVarsOmschrijving[$this->pdf->rapport_type.'Paginas']=$this->pdf->rapport_titel;
    
    $index=new indexHerberekening();
    $kwartaalWaarden=$index->getWaarden( $this->portefeuilleStart,$this->rapportageDatum,$this->portefeuille,'','kwartaal'); //$this->rapportageDatumVanaf
    $barData=array();
    foreach($kwartaalWaarden as $data)
    {
      $this->jaarWaarden['Totaal'][$data['datum']]['waarde']+=$data['waardeHuidige'];
      foreach($data['extra']['cat'] as $categorie=>$waardeEur)
        $barData[$data['datum']][$categorie] += ($waardeEur / $data['waardeHuidige'] * 100);
    }

    $DB = new DB();
    $query="SELECT
Beleggingscategorien.Afdrukvolgorde,
Beleggingscategorien.Beleggingscategorie,
Beleggingscategorien.Omschrijving
FROM Beleggingscategorien
JOIN KeuzePerVermogensbeheerder ON KeuzePerVermogensbeheerder.waarde = Beleggingscategorien.Beleggingscategorie
WHERE
KeuzePerVermogensbeheerder.Vermogensbeheerder='".$this->pdf->portefeuilledata['Vermogensbeheerder']."' AND
KeuzePerVermogensbeheerder.categorie='Beleggingscategorien'
ORDER BY KeuzePerVermogensbeheerder.Afdrukvolgorde ";

    $DB->SQL($query);
    $DB->query();
    while($data=$DB->nextRecord())
    {
      $this->categorieVolgorde[]=$data['Beleggingscategorie'];
      $this->categorieOmschrijving[$data['Beleggingscategorie']]=$data['Omschrijving'];
    }
   // listarray($this->categorieVolgorde);exit;
    //listarray($barData);exit;
    $this->VBarDiagram(20,82,123-40,50,$barData,'Ontwikkeling vermogen sinds start');
   
    $query="SELECT SpecifiekeIndex,Omschrijving FROM Portefeuilles JOIN Fondsen ON Portefeuilles.SpecifiekeIndex=Fondsen.Fonds 
            WHERE Portefeuilles.Portefeuille='".$this->portefeuille."'";
    $DB->SQL($query);
    $this->index=$DB->lookupRecord();
    
    $benchmarkFonds=$this->index['SpecifiekeIndex'];
    $stdev=new rapportSDberekening($this->portefeuille,$this->rapportageDatum,0);
  
    $stdev->addReeks('totaal');

  //  listarray($stdev);exit;
    if($benchmarkFonds<>'')
      $stdev->addReeks('benchmarkTot',$benchmarkFonds,true);
    $stdev->berekenWaarden();

   
    
    $this->addPerfGrafiek($stdev);
    
    $this->pdf->setXY(120,31);

    $this->addPerf();
    $this->pdf->rowHeight=$this->pdf->rowHeightBackup;
    $this->pdf->setTextColor(0);

	}
  
  function addRegel($type,$data)
  {
    
    if($type=='kop')
    {
      $this->pdf->setFillColor($this->pdf->rapport_kop_bgcolor['r'],$this->pdf->rapport_kop_bgcolor['g'],$this->pdf->rapport_kop_bgcolor['b']);
      $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
      $this->pdf->setTextColor(255);
    }
    elseif($type=='kopBlank')
    {
      $this->pdf->setFillColor(255);
      $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
      $this->pdf->setTextColor(0);
    }
    elseif($type=='data')
    {
      $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
      $this->pdf->setFillColor(255);
      $this->pdf->setTextColor(75);
    }
    elseif($type=='sub')
    {
      $this->pdf->SetFont($this->pdf->rapport_font,'B',$this->pdf->rapport_fontsize);
      $this->pdf->setFillColor(226,238,241);
      $this->pdf->setTextColor(75);
    }
    $this->pdf->rect($this->pdf->marge+$this->pdf->widthA[0],$this->pdf->getY(),297-$this->pdf->marge*2-$this->pdf->widthA[0],$this->pdf->rowHeight,'F');
    $this->pdf->row($data);
    //listarray($this->pdf->widthA);exit;
  }
  
  
  function addPerf()
  {
    global $__appvar;
    $this->pdf->widthA = array(150,80,30,30,120);
    $this->pdf->alignA = array('L','L','R','R','R');
  
    $this->pdf->SetWidths($this->pdf->widthA);
    $this->pdf->SetAligns($this->pdf->alignA);
    $this->pdf->setX($this->pdf->marge);
    

    // ***************************** ophalen data voor afdruk ************************ //
  
    $julDatum = db2jul($this->rapportageDatum);
    $kwartaal=ceil(date('m',$julDatum)/3);
    $rapJaar=date('Y',$julDatum);
    $start=date('Y-m-d', mktime(0,0,0,($kwartaal*3)-2,0,$rapJaar));
    $portefeuilleStart=substr($this->portefeuilleStart,0,4);
  
    $perioden=array(array($start,$this->rapportageDatum),array($this->tweedePerformanceStart,$this->rapportageDatum),array($this->portefeuilleStart,$this->rapportageDatum));
  
    //listarray($perioden);
    $rendementen=array();
    foreach($perioden as $periodeIndex=>$periode)
    {
      $rendementProcent  	= performanceMeting($this->portefeuille, $periode[0], $periode[1], $this->pdf->portefeuilledata['PerformanceBerekening'],$this->pdf->rapportageValuta,$periode[0]);
      $rendementen[]=$rendementProcent;
    }
  

    $kostenPerGrootboek = array();
    $opbrengstenPerGrootboek=array();
    $totaalOpbrengstGrootboek=array();
    
  //  exit;
    
    $totaalKosten=array();
    $totaalOpbrengst=array();
    $perioden=array(array($this->tweedePerformanceStart,$this->rapportageDatum));//,array($this->tweedePerformanceStart,$this->rapportageDatum));//,array($this->portefeuilleStart,$this->rapportageDatum));

    foreach($perioden as $index=>$periode)
    {
      $totaalA=array();
      $totaalB=array();
      $vanaf=substr($periode[0],0,10);
      $tot=$periode[1];
      $DB = new DB();
      
      if(substr($vanaf,5,5)=='01-01')
        $beginJaar=true;
      else
        $beginJaar=false;
      

      $vanRapKoers=getValutaKoers($this->pdf->rapportageValuta,$vanaf);
      $fondsen=berekenPortefeuilleWaarde($this->portefeuille,$vanaf,$beginJaar,$this->pdf->rapportageValuta,$vanaf);
      $totaalWaardeVanaf['totaal']=0;
      foreach($fondsen as $id=>$regel)
      {//echo "$vanaf ".$regel['actuelePortefeuilleWaardeEuro']."<br>\n";
        $totaalWaardeVanaf['totaal']+=($regel['actuelePortefeuilleWaardeEuro']/$vanRapKoers);
        if($regel['type']=='rente')
        {
          $totaalB['totaal']+=($regel['actuelePortefeuilleWaardeEuro']/$vanRapKoers);
        }
      }
      
      $totaalWaarde['totaal']=0;
      $totRapKoers=getValutaKoers($this->pdf->rapportageValuta,$tot);
      $fondsen=berekenPortefeuilleWaarde($this->portefeuille,$tot,false,$this->pdf->rapportageValuta,$vanaf);
      $totaal=array();
      foreach($fondsen as $id=>$regel)
      {
        $totaalWaarde['totaal']+=($regel['actuelePortefeuilleWaardeEuro']/$totRapKoers);
        if($regel['type']=='rente')
        {
          $totaalA['totaal']+=($regel['actuelePortefeuilleWaardeEuro']/$totRapKoers);
        }
        if($regel['type']=='fondsen')
        {
          if($regel['valuta']==$this->pdf->rapportageValuta)
          {
            $totaal['totaalB'] += $regel['actuelePortefeuilleWaardeInValuta'];
            $totaal['totaalA'] += $regel['beginPortefeuilleWaardeInValuta'];
          }
          else
          {
            $totaal['totaalB'] += ($regel['actuelePortefeuilleWaardeEuro'] / $totRapKoers);
            $totaal['totaalA'] += ($regel['beginPortefeuilleWaardeEuro'] / $vanRapKoers);
          }
        }
      }
      
      $waardeEind[$index] = $totaalWaarde['totaal'];
      $waardeBegin[$index] = $totaalWaardeVanaf['totaal'];
      $waardeMutatie[$index] = $waardeEind[$index] - $waardeBegin[$index];
      $stortingen[$index] = getStortingen($this->portefeuille, $vanaf, $tot, $this->pdf->rapportageValuta);
      $onttrekkingen[$index] = getOnttrekkingen($this->portefeuille, $vanaf, $tot, $this->pdf->rapportageValuta)*-1;
      $resultaatVerslagperiode[$index] = $waardeMutatie[$index] - $stortingen[$index] - $onttrekkingen[$index];
      $ongerealiseerdeKoersResultaat[$index] = $totaal['totaalB'] - $totaal['totaalA'];
      $totaalOpbrengst[$index] += $ongerealiseerdeKoersResultaat[$index];
      $gerealiseerdeKoersResultaat[$index] = gerealiseerdKoersresultaat($this->portefeuille, $vanaf, $tot, $this->pdf->rapportageValuta);
      $totaalOpbrengst[$index] += $gerealiseerdeKoersResultaat[$index];
      $opgelopenRente[$index] = ($totaalA['totaal'] - $totaalB['totaal']) / $this->pdf->ValutaKoersEind;
      $totaalOpbrengst[$index] += $opgelopenRente[$index];
  
      if ($this->pdf->rapportageValuta != "EUR" || $this->pdf->rapportageValuta != '')
        $koersQuery =	" / (SELECT Koers FROM Valutakoersen WHERE Valuta='".$this->pdf->rapportageValuta."' AND Datum <= Rekeningmutaties.Boekdatum ORDER BY Datum DESC LIMIT 1 ) ";
      else
        $koersQuery = "";
      
      $query = "SELECT DISTINCT(Grootboekrekeningen.Grootboekrekening) as Grootboekrekening , Grootboekrekeningen.Omschrijving FROM Grootboekrekeningen WHERE Grootboekrekeningen.Opbrengst = '1' ORDER BY Grootboekrekeningen.Afdrukvolgorde";
      $DB->SQL($query);
      $DB->Query();
      while ($gb = $DB->nextRecord())
      {
        $query = "SELECT  " .
          "SUM(Rekeningmutaties.Credit * Rekeningmutaties.Valutakoers $koersQuery) AS totaalcredit, " .
          "SUM(Rekeningmutaties.Debet * Rekeningmutaties.Valutakoers $koersQuery) AS totaaldebet " .
          "FROM Rekeningmutaties, Rekeningen, Portefeuilles " .
          "WHERE " .
          "Rekeningmutaties.Rekening = Rekeningen.Rekening AND " .
          "Rekeningen.Portefeuille = '" . $this->portefeuille . "' AND " .
          "Rekeningen.Portefeuille = Portefeuilles.Portefeuille AND " .
          "Rekeningmutaties.Verwerkt = '1' AND " .
          "Rekeningmutaties.Boekdatum > '" . $vanaf . "' AND " .
          "Rekeningmutaties.Boekdatum <= '" . $tot . "' AND " .
          "Rekeningmutaties.Grootboekrekening = '" . $gb['Grootboekrekening'] . "' ";
        $DB2 = new DB();
        $DB2->SQL($query);
        $DB2->Query();

        while ($opbrengst = $DB2->nextRecord())
        {

          $opbrengstWaarde=($opbrengst['totaalcredit'] - $opbrengst['totaaldebet']);
          if($opbrengstWaarde <> 0 )
          {
            $opbrengstenPerGrootboek[$gb['Omschrijving']][$index] += $opbrengstWaarde;
            $totaalOpbrengst[$index] += $opbrengstWaarde;
            $totaalOpbrengstGrootboek[$index] += $opbrengstWaarde;
          }
        }
      }

      
      $query = "SELECT DISTINCT(Grootboekrekeningen.Grootboekrekening), Grootboekrekeningen.Omschrijving FROM Grootboekrekeningen WHERE Grootboekrekeningen.Kosten = '1' ORDER BY Grootboekrekeningen.Afdrukvolgorde";
      $DB = new DB();
      $DB->SQL($query);
      $DB->Query();
      
      while ($gb = $DB->nextRecord())
      {
        $query = "SELECT  " .
          "SUM(Rekeningmutaties.Credit * Rekeningmutaties.Valutakoers $koersQuery) AS totaalcredit, " .
          "SUM(Rekeningmutaties.Debet * Rekeningmutaties.Valutakoers $koersQuery) AS totaaldebet " .
          "FROM Rekeningmutaties, Rekeningen, Portefeuilles " .
          "WHERE " .
          "Rekeningmutaties.Rekening = Rekeningen.Rekening AND " .
          "Rekeningen.Portefeuille = '" . $this->portefeuille . "' AND " .
          "Rekeningen.Portefeuille = Portefeuilles.Portefeuille AND " .
          "Rekeningmutaties.Verwerkt = '1' AND " .
          "Rekeningmutaties.Boekdatum > '" . $vanaf . "' AND " .
          "Rekeningmutaties.Boekdatum <= '" . $tot . "' AND " .
          "Rekeningmutaties.Grootboekrekening = '" . $gb['Grootboekrekening'] . "' ";
        $DB2 = new DB();
        $DB2->SQL($query);
        $DB2->Query();
        $grootboekLookup=array();
        while ($kosten = $DB2->nextRecord())
        {
          $kostenWaarde=($kosten['totaalcredit'] - $kosten['totaaldebet']);
          if($kostenWaarde <> 0)
          {

              $kostenPerGrootboek[$gb['Omschrijving']][$index] = $kostenWaarde;
              $grootboekLookup[$gb['Grootboekrekening']] = $gb['Omschrijving'];
              $totaalKosten[$index] += $kostenWaarde;
        
            
          }
        }
        
      }
      //$kostenProcent = ($totaalKosten / $waardeEind) * 100;
      // het overgebleven is de koers resultaat op valutas (om de getalletjes te laten kloppen).
      $koersResulaatValutas[$index] = $resultaatVerslagperiode[$index] - ($totaalOpbrengst[$index] + $totaalKosten[$index]);
      $totaalOpbrengst[$index] += $koersResulaatValutas[$index];
      // ***************************** einde ophalen data voor afdruk ************************ //
    }

    $gemiddelde[0]=$resultaatVerslagperiode[0]/($rendementen[1]/100);
 // echo $gemiddelde[0]."=".$resultaatVerslagperiode[0]."/(".$rendementen[1]."/100);<br>\n";
    
    $extraMarge=10;
    $this->addRegel('kopBlank',array('','Portefeuillerendement'));
    $this->pdf->SetWidths(array(140+$extraMarge,46-($extraMarge/3),47-($extraMarge/3),47-($extraMarge/3)));
    $this->pdf->SetAligns(array('L','R','R','R'));
    $this->addRegel('kop',array('','Q'.$kwartaal.' '.$rapJaar,$rapJaar.' t/m '.strtolower(date('M',$julDatum)).'','Sinds start'));//('.$portefeuilleStart.'-'.$rapJaar.')
    $this->pdf->CellBorders=array('','U','U','U');
    $this->addRegel('data',array('',$this->formatGetal($rendementen[0],1).' %',$this->formatGetal($rendementen[1],1).' %',$this->formatGetal($rendementen[2],1).' %'));
    $this->pdf->CellBorders=array();
    $this->pdf->ln();
    $this->pdf->SetWidths(array(140+$extraMarge,46+47+47-$extraMarge));
    $this->pdf->SetAligns(array('L','L','R','R'));
    $this->addRegel('kopBlank',array('','Rendement uitgesplitst '.strtolower(date('Y',db2jul($perioden[0][0]))) .' t/m '.strtolower(date('M',$julDatum)).''));
    $this->pdf->SetWidths(array(140+$extraMarge,56-($extraMarge/3),37-($extraMarge/3),47-($extraMarge/3)));
 //   $this->pdf->SetAligns(array('L','L','C','C'));
    $this->addRegel('kop',array('','','In euro','% van totaal vermogen'));
  
    $this->addRegel('data',array('','Koersresultaten',$this->formatGetal($ongerealiseerdeKoersResultaat[0]+$gerealiseerdeKoersResultaat[0],0).'',
                                                            $this->formatGetal(($ongerealiseerdeKoersResultaat[0]+$gerealiseerdeKoersResultaat[0])/$gemiddelde[0]*100,2).''));
   // $this->addRegel('data',array('','Opbrengsten',$this->formatGetal($totaalOpbrengstGrootboek[0],2).'',$this->formatGetal(($totaalOpbrengstGrootboek[0])/$waardeEind[0]*100,2).''));
  
    foreach($opbrengstenPerGrootboek as $key=>$values)
      $this->addRegel('data',array("",vertaalTekst($key,$this->pdf->rapport_taal),$this->formatGetal($values[0],0),$this->formatGetal($values[0]/$gemiddelde[0]*100,2)));
  
    //listarray($resultaatVerslagperiode);exit;
    $this->addRegel('data',array('','Kosten',$this->formatGetal($totaalKosten[0],0).'',$this->formatGetal(($totaalKosten[0])/$gemiddelde[0]*100,2).''));
    $this->addRegel('sub',array('','Rendement',$this->formatGetal($resultaatVerslagperiode[0],0).'',$this->formatGetal($rendementen[1],2).''));
  
    $this->pdf->ln();
    $this->pdf->SetWidths(array(140+$extraMarge,46+47+47-$extraMarge));
    $this->pdf->SetAligns(array('L','L','R','R'));
    $this->addRegel('kopBlank',array('','Toelichting kosten '.strtolower(date('Y',db2jul($perioden[0][0]))) .' t/m '.strtolower(date('M',$julDatum))));
    $this->pdf->SetWidths(array(140+$extraMarge,56-($extraMarge/3),37-($extraMarge/3),47-($extraMarge/3)));
    //$this->pdf->SetAligns(array('L','L','C','C'));
    $this->addRegel('kop',array('','','In euro','% van totaal vermogen'));
    foreach($kostenPerGrootboek as $key=>$values)
      $this->addRegel('data',array("",vertaalTekst($key,$this->pdf->rapport_taal),$this->formatGetal($values[0],0),$this->formatGetal($values[0]/$gemiddelde[0]*100,2)));
    $this->addRegel('sub',array('','Totaal kosten',$this->formatGetal($totaalKosten[0],0).'',$this->formatGetal(($totaalKosten[0])/$gemiddelde[0]*100,2).''));
 // listarray($gemiddelde);exit;
    /*
    if(substr($this->rapportageDatum,5,5)=='12-31')
    {
      $this->pdf->ln();
      $this->pdf->SetWidths(array(140 + $extraMarge, 46 + 47 + 47 - $extraMarge));
    //  $this->pdf->SetAligns(array('L', 'L', 'C', 'C'));
      $this->addRegel('kopBlank', array('', 'Beheervergoeding Janivo  ' . strtolower(date('j M', db2jul($this->tweedePerformanceStart))) . ' – ' . strtolower(date('j M Y', $julDatum))));
      $this->pdf->SetWidths(array(140 + $extraMarge, 56 - ($extraMarge / 3), 37 - ($extraMarge / 3), 47 - ($extraMarge / 3)));
    //  $this->pdf->SetAligns(array('L', 'L', 'C', 'C'));
      $this->addRegel('kop', array('', '', 'In euro', '% van totaal vermogen'));
      $this->pdf->CellBorders = array('', 'U', 'U', 'U');
      $this->addRegel('data', array("", vertaalTekst('Beheervergoeding Janivo', $this->pdf->rapport_taal), $this->formatGetal($kostenPerGrootboek['BEW'][0], 0), $this->formatGetal($kostenPerGrootboek['BEW'][0] / $waardeEind[0] * 100, 2)));
    }
    */
    unset($this->pdf->CellBorders);
    /*
    $this->pdf->CellBorders=array();
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
    //$this->pdf->row(array("",vertaalTekst("Beginwaarde totaal vermogen",$this->pdf->rapport_taal),                  $this->formatGetal($waardeBegin[0],2,true),             $this->formatGetal($waardeBegin[1],2,true)));
    $this->pdf->row(array("",vertaalTekst("Totaal stortingen gedurende verslagperiode",$this->pdf->rapport_taal),   $this->formatGetal($stortingen[0],2),                   $this->formatGetal($stortingen[1],2)));
    $this->pdf->row(array("",vertaalTekst("Totaal onttrekkingen gedurende verslagperiode",$this->pdf->rapport_taal),$this->formatGetal($onttrekkingen[0],2),                $this->formatGetal($onttrekkingen[1],2)));
    $this->pdf->row(array("",vertaalTekst("Koersresultaten valuta's",$this->pdf->rapport_taal),                     $this->formatGetal($koersResulaatValutas[0],2),         $this->formatGetal($koersResulaatValutas[1],2)));
    $this->pdf->row(array("",vertaalTekst("Resultaat opgelopen rente",$this->pdf->rapport_taal),                    $this->formatGetal($opgelopenRente[0],2),               $this->formatGetal($opgelopenRente[1],2)));
    foreach($opbrengstenPerGrootboek as $key=>$values)
      $this->pdf->row(array("",vertaalTekst($key,$this->pdf->rapport_taal),                                         $this->formatGetal($values[0],2),                       $this->formatGetal($values[1],2)));
    $this->pdf->row(array("",vertaalTekst("Diverse kosten",$this->pdf->rapport_taal),                                         $this->formatGetal($totaalKosten[0],2),                    $this->formatGetal($totaalKosten[1],2)));
    $this->pdf->CellBorders=array('','T','T','T');
    //$this->pdf->row(array("",vertaalTekst("Eindwaarde totaalvermogen",$this->pdf->rapport_taal),                    $this->formatGetal($waardeEind[0],2),                   $this->formatGetal($waardeEind[1],2)));
    $this->pdf->CellBorders=array();
    $this->pdf->ln();
    //	$this->pdf->row(array("",vertaalTekst("Resultaat over verslagperiode",$this->pdf->rapport_taal),                $this->formatGetal($resultaatVerslagperiode[0],2),      $this->formatGetal($resultaatVerslagperiode[1],2)));
    */
  }
  
  
  
  function VBarDiagram($x,$y,$w, $h, $data,$title='')
  {
    global $__appvar;
    //  $this->pdf->SetXY($x,$y)		;//112
    $legendaWidth = 0;
    
   // $this->pdf->Rect($x-12,$y-$h-5,$w+17, $h+30);
    
    $this->pdf->setXY($x,$y-$h);
    $this->pdf->SetFont($this->pdf->rapport_font, 'B', $this->pdf->rapport_fontsize);
    $this->pdf->Multicell($w,4,$title,'','L');
    $this->pdf->setXY($x,$y+8);
    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);

    $grafiekPunt = array();
    $verwijder=array();
    $this->pdf->SetLineStyle(array('color'=>array(0,0,0),'dash' => 0,'width'=>0.01));

    
   // listarray($this->categorieVolgorde);exit;
    $aanwezigeCategorieen=array();
    foreach ($data as $datum=>$waarden)
    {
      foreach ($waarden as $categorie => $waarde)
      {
        $aanwezigeCategorieen[$categorie]=$categorie;
      }
    }
    $beginWaarden=array();
    foreach($this->categorieVolgorde as $categorie)
      if(in_array($categorie,$aanwezigeCategorieen))
        $beginWaarden[$categorie]=0;
      

    foreach ($data as $datum=>$waarden)
    {
      if(!isset($grafiek[$datum]))
        $grafiek[$datum]=$beginWaarden;
      
      $legenda[$datum] = $datum;
      $n=0;
      foreach ($waarden as $categorie=>$waarde)
      {
        if($categorie=='LIQ')
          $categorie='Liquiditeiten';
        $grafiek[$datum][$categorie]+=$waarde;
        $grafiekCategorie[$categorie][$datum]+=$waarde;
        $categorien[$categorie] = $n;
        $categorieId[$n]=$categorie ;
        
        if($waarde < 0)
        {
          $verwijder[$datum]=$datum;
          $grafiek[$datum][$categorie]=0;
          $grafiekCategorie[$categorie][$datum]=0;
        }
        
        
        if(!isset($colors[$categorie]))
        {
          if($this->kleuren['OIB'][$categorie])
            $colors[$categorie]=array($this->kleuren['OIB'][$categorie]['R']['value'],$this->kleuren['OIB'][$categorie]['G']['value'],$this->kleuren['OIB'][$categorie]['B']['value']);
          else
            $colors[$categorie]=array(rand(20,80),rand(20,80),rand(20,250));//array($this->categorieKleuren[$categorie]['R']['value'],$this->categorieKleuren[$categorie]['G']['value'],$this->categorieKleuren[$categorie]['B']['value']);
        }
        $n++;
      }
    }

    foreach ($verwijder as $datum)
    {
      foreach ($data[$datum] as $categorie=>$waarde)
      {
        if($categorie=='LIQ')
          $categorie='Liquiditeiten';
        $grafiek[$datum][$categorie]=0;
        $grafiekCategorie[$categorie][$datum]=0;
      }
    }
 
    $numBars = count($grafiek);
    // $numBars=12;
    
    if($color == null)
    {
      $color=array(155,155,155);
    }
    
    $maxVal=100;
    foreach ($this->jaarWaarden['Totaal'] as $jaar=>$waarden)
      $maxVal=max($maxVal,$waarden['waarde']);
    
    $maxVal=round(ceil($maxVal/5000000))*5000000;
    
    $minVal = 0;
    
    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);
    $XPage = $this->pdf->GetX();
    $YPage = $this->pdf->GetY();
    $margin = 2;
    $YstartGrafiek = $YPage - floor($margin * 1);
    $hGrafiek = ($h - $margin * 1);
    $XstartGrafiek = $XPage + $margin * 1 ;
    $bGrafiek = ($w - $margin * 1) - $legendaWidth; // - legenda
  
  
    $this->pdf->line($XstartGrafiek, $YstartGrafiek, $XstartGrafiek+$bGrafiek, $YstartGrafiek);
    $this->pdf->line($XstartGrafiek, $YstartGrafiek, $XstartGrafiek, $YstartGrafiek-$hGrafiek);
  
    
    $n=0;
    foreach (($this->categorieVolgorde) as $categorie)
    {
      if(is_array($grafiekCategorie[$categorie]))
      {
        $this->pdf->Rect($XstartGrafiek+$bGrafiek+3 , $YstartGrafiek-$hGrafiek+$n*10+2, 2, 2, 'DF',null,$colors[$categorie]);
        $this->pdf->SetXY($XstartGrafiek+$bGrafiek+6 ,$YstartGrafiek-$hGrafiek+$n*10+1.5 );
        $this->pdf->Cell(20, 3,$this->categorieOmschrijving[$categorie],0,0,'L');
        $n++;
      }
    }
    
    $unit = $hGrafiek / $maxVal * -1;
    $nulYpos =0;
    
    $horDiv = 5;
    $horInterval = $hGrafiek / $horDiv;
    $bereik = $hGrafiek/$unit;
    
 
    $this->pdf->SetTextColor(0,0,0);
    
    $stapgrootte = (abs($bereik)/$horDiv);
    $top = $YstartGrafiek-$h;
    $bodem = $YstartGrafiek;
    $absUnit =abs($unit);
    
    $nulpunt = $YstartGrafiek + $nulYpos;
    
    $n=0;
    $this->pdf->SetFont($this->pdf->rapport_font, '', 8);
    $this->pdf->TextWithRotation($XstartGrafiek-8,$YPage-$hGrafiek/2,'(x 1 miljoen)',90);
    for($i=$nulpunt; $i > $top; $i-= $absUnit*$stapgrootte)
    {
      //$this->pdf->Line($XstartGrafiek, $i, $XstartGrafiek+$bGrafiek ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      $this->pdf->Line($XstartGrafiek, $i, $XstartGrafiek-1 ,$i,array('color'=>array(0,0,0)));
      $this->pdf->SetXY($XstartGrafiek-12, $i-1.5);
      $this->pdf->Cell(10, 3, $this->formatGetal($n*$stapgrootte/1000000,0)."",0,0,'R');
      $n++;
    }
    $this->pdf->SetFont($this->pdf->rapport_font, '', 6);
    if($numBars > 0)
      $this->pdf->NbVal=$numBars;
    
    $vBar = ($bGrafiek / ($this->pdf->NbVal + 1));
    $bGrafiek = $vBar * ($this->pdf->NbVal + 1);
    $eBaton = ($vBar * 50 / 100);
    
    
    $this->pdf->SetLineStyle(array('dash' => 0,'color'=>array(0,0,0)));
    $this->pdf->SetLineWidth(0.2);
    
    $this->pdf->SetFillColor($color[0],$color[1],$color[2]);
    $i=0;
 
    foreach ($grafiek as $datum=>$data)
    {
      $data=array_reverse($data,true);
      foreach($data as $categorie=>$val)
      {
        if(!isset($YstartGrafiekLast[$datum]))
          $YstartGrafiekLast[$datum] = $YstartGrafiek;
        //Bar
        $xval = $XstartGrafiek + (1 + $i ) * $vBar - $eBaton / 2;
        $lval = $eBaton;
        $yval = $YstartGrafiekLast[$datum] + $nulYpos ;
        $hval = ($val * $unit * $this->jaarWaarden['Totaal'][$datum]['waarde']/100);
        //echo  "$datum  ($val * $unit * ".$this->jaarWaarden['Totaal'][$datum]['waarde']."/100); <br>\n";
        $this->pdf->Rect($xval, $yval, $lval, $hval, 'DF',null,$colors[$categorie]);
        $YstartGrafiekLast[$datum] = $YstartGrafiekLast[$datum]+$hval;
        /*
        $this->pdf->SetTextColor(255,255,255);
        if(abs($hval) > 3)
        {
          $this->pdf->SetXY($xval, $yval+($hval/2)-2);
          $this->pdf->Cell($eBaton, 4, number_format($val,0,',','.')."%",0,0,'C');
        }
        $this->pdf->SetTextColor(0,0,0);
        */
        if($legendaPrinted[$datum] != 1)
          $this->pdf->TextWithRotation($xval-1,$YstartGrafiek+7,'Q'.ceil(substr($legenda[$datum],5,2)/3).'-'.substr($legenda[$datum],0,4),30);
        
        if($grafiekPunt[$categorie][$datum])
        {
          $this->pdf->Rect($xval+.5*$eBaton-.5, $grafiekPunt[$categorie][$datum] * $unit + $YstartGrafiek -.5 , 1, 1, 'DF',null,array(128,128,128));
          if($lastX)
            $this->pdf->line($lastX,$lastY,$xval+.5*$eBaton, $grafiekPunt[$categorie][$datum] * $unit + $YstartGrafiek);
          $lastX = $xval+.5*$eBaton;
          $lastY = $grafiekPunt[$categorie][$datum] * $unit + $YstartGrafiek;
        }
        $legendaPrinted[$datum] = 1;
      }
      $i++;
    }
    /*
    $xval=$x+10;
    $yval=$y+15;
    $colors=array_reverse($colors,true);
    foreach ($colors as $cat=>$color)
    {
      $this->pdf->Rect($xval, $yval, 5, 5, 'DF',null,$colors[$cat]);
      $this->pdf->TextWithRotation($xval+7,$yval+2.5,$cat,0);
      $xval=$xval+22;
    }
    */
    $this->pdf->SetFont($this->pdf->rapport_font, '', $this->pdf->rapport_fontsize);
  }
  
  function getKleuren()
  {
    $db=new DB();
    $query="SELECT grafiek_kleur FROM Vermogensbeheerders WHERE vermogensbeheerder='".$this->pdf->portefeuilledata['Vermogensbeheerder']."'";
    $db->SQL($query);
    $data=$db->lookupRecord();
    $this->kleuren=unserialize($data['grafiek_kleur']);
    if($this->kleuren['OIS']['Liquiditeiten']['G']['value']==0)
      $this->kleuren['OIS']['Liquiditeiten']=$this->kleuren['OIB']['Liquiditeiten'];
    foreach($this->kleuren as $groep=>$kleuren)
    {
      foreach($kleuren as $cat=>$kleurdata)
        $this->kleuren['alle'][$cat]=$kleurdata;
    }

  }



function addPerfGrafiek($stdev)
{
    $portIndex=1;
    $indexIndex=1;
    $maanden = array("", "Jan", "Feb", "Mrt", "Apr", "Mei", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec");

    foreach($stdev->reeksen['totaal'] as $datum=>$perfData)
    {
      $benchmarkData=$stdev->reeksen['benchmarkTot'][$datum];
      $juldate=db2jul($datum);
      $portIndex=(1+$perfData['perf']/100)*$portIndex;
      $indexIndex=(1+$benchmarkData['perf']/100)*$indexIndex;
      $perfGrafiek['portefeuille'][]=($portIndex-1)*100;
      if($this->index['SpecifiekeIndex']<>'')
        $perfGrafiek['specifiekeIndex'][]=($indexIndex-1)*100;
      $perfGrafiek['datum'][]= $maanden[date("n",$juldate)].' '.date("y",$juldate);
    }

if($this->index['SpecifiekeIndex']=='')
  $perfGrafiek['legenda']=array('Portefeuille');
  else
    $perfGrafiek['legenda']=array('Portefeuille','Benchmark');


    $this->pdf->setXY(20,120);
     $indexKleur=array(176,160,122);
    $perfGrafiek['titel']='Ontwikkeling portefeuillerendement sinds start (Cumulatief)';
    $this->LineDiagram(120, 55, $perfGrafiek,array(array(49,135,156),$indexKleur),0,0,6,5,false,true);//50


}  


  function LineDiagram($w, $h, $data, $color=null, $maxVal=0, $minVal=0, $horDiv=4, $verDiv=4, $afmMinMax=false,$eerstePunt=false)
  {
    global $__appvar;

    $legendDatum= $data['datum'];
    $legendaItems= $data['legenda'];
    $titel=$data['titel'];
    $data1 = $data['specifiekeIndex'];
    $data2 = $data['extra'];
    $data = $data['portefeuille'];


    if(count($data2)>0)
      $bereikdata = array_merge(array_values($data),array_values($data1),array_values($data2));
    elseif(count($data1)>0)
      $bereikdata = array_merge(array_values($data),array_values($data1));
    else
      $bereikdata =  array_values($data);


    if($afmMinMax==true)
    {
      $bereikdata[]=$this->standaarddeviatieMarge['Minimum'];
      $bereikdata[]=$this->standaarddeviatieMarge['Maximum'];
    }
    $XPage = $this->pdf->GetX();
    $YPage = $this->pdf->GetY();
    $margin = 2;
    $YDiag = $YPage + $margin;
    $hDiag = floor($h - $margin * 1);
    $XDiag = $XPage + $margin * 1 ;
    $lDiag = floor($w - $margin * 1 );
    
    $this->pdf->SetFont($this->pdf->rapport_font,'b',$this->pdf->rapport_fontsize);
    $this->pdf->setXY($XPage, $YPage-4);
    $this->pdf->Cell($w,0, vertaalTekst($titel,$this->pdf->rapport_taal),0,0,'L');
    $this->pdf->SetFont($this->pdf->rapport_font,'',$this->pdf->rapport_fontsize);
    $this->pdf->SetLineStyle(array('width' => 0.3, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => array(0,0,0)));

    //$this->pdf->Rect($XDiag, $YDiag, $w-$margin, $h,'D');//'FD','',array(245,245,245));
    $this->pdf->line($XDiag, $YDiag+$h, $XDiag+$w-$margin, $YDiag+$h);
    $this->pdf->line($XDiag, $YDiag, $XDiag, $YDiag+$h);
    if(is_array($color[0]))
    {
      $color2= $color[2];
      $color1= $color[1];
      $color = $color[0];
    }

    if($color == null)
      $color=array(155,155,155);
    $this->pdf->SetLineWidth(0.2);

    
    $this->pdf->SetFillColor($color[0],$color[1],$color[2]);

    if ($maxVal == 0)
    {
      $maxVal = ceil(max($bereikdata));
    }
    if ($minVal == 0)
    {
      $minVal = floor(min($bereikdata));
    }

    $minVal = floor(($minVal-1) * 1.1);
    if($minVal > 0)
      $minVal=0;
    $maxVal = ceil(($maxVal+1) * 1.1);
    $legendYstep = ($maxVal - $minVal) / $horDiv;
    $verInterval = ($lDiag / $verDiv);
    $horInterval = ($hDiag / $horDiv);
    $waardeCorrectie = $hDiag / ($maxVal - $minVal);
    $unit = $lDiag / count($data);

    for ($i = 0; $i <= $verDiv; $i++) //x-as verdeling
      $xpos = $XDiag + $verInterval * $i;

    $this->pdf->SetFont($this->pdf->rapport_font, '', 8);
    $this->pdf->SetTextColor(0,0,0);
    $this->pdf->SetDrawColor(0,0,0);

    $stapgrootte = ceil(abs($maxVal - $minVal)/$horDiv);
    $unith = $hDiag / (-1 * $minVal + $maxVal);

    $top = $YPage;
    $bodem = $YDiag+$hDiag;
    $absUnit =abs($unith);

    $nulpunt = $YDiag + (($maxVal) * $waardeCorrectie);
    $n=0;
    if($titel=='Sharpe-ratio')
      $yAs='';
    else
      $yAs=' %';
  
    $this->pdf->Line($XDiag, $nulpunt, $XPage+$w ,$nulpunt,array('dash' => 2,'color'=>array(128,128,128)));
    
    for($i=$nulpunt; $i<= $bodem; $i+= $absUnit*$stapgrootte)
    {
      $skipNull = true;
     // $this->pdf->Line($XDiag, $i, $XPage+$w ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      //$this->pdf->Text($XDiag-7, $i, 0-($n*$stapgrootte) .$yAs);
      $this->pdf->Line($XDiag, $i, $XDiag-1 ,$i,array('color'=>array(0,0,0)));
      $this->pdf->setXY($XDiag-11, $i-2);
      $this->pdf->cell(10,4,0-($n*$stapgrootte) .$yAs,0,1,'R');
      $n++;
      if($n >20)
       break;
    }

    $n=0;

    
    for($i=$nulpunt; $i >= $top; $i-= $absUnit*$stapgrootte)
    {
     // $this->pdf->Line($XDiag, $i, $XPage+$w ,$i,array('dash' => 1,'color'=>array(0,0,0)));
      if($skipNull == true)
        $skipNull = false;
      else
      {
        $this->pdf->setXY($XDiag-11, $i-2);
        $this->pdf->cell(10,4,(($n*$stapgrootte) + 0) . $yAs,0,1,'R');
        $this->pdf->Line($XDiag, $i, $XDiag-1 ,$i,array('color'=>array(0,0,0)));

       // $this->pdf->Text($XDiag - 7, $i, ($n * $stapgrootte) + 0 . $yAs);
      }
      $n++;
      if($n >20)
         break;
    }
  
    if($afmMinMax==true)
    {
      $lineStyle = array('width' => 0.5, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => array(50,50,50));
      $yval = $YDiag + (($maxVal-$this->standaarddeviatieMarge['Minimum']) * $waardeCorrectie) ;
      $this->pdf->line($XDiag, $yval, $XPage+$w, $yval,$lineStyle );
      $this->pdf->Text($XDiag+$w, $yval,"Min.");
      
       $yval = $YDiag + (($maxVal-$this->standaarddeviatieMarge['Maximum']) * $waardeCorrectie) ;
      $this->pdf->line($XDiag, $yval, $XPage+$w, $yval,$lineStyle );
      $this->pdf->Text($XDiag+$w, $yval,"Max.");     
    }
    
    $yval = $YDiag + (($maxVal) * $waardeCorrectie) ;
    $lineStyle = array('width' => 0.5, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => $color);
    $jaren=ceil(count($data)/12);
    //for ($i=0; $i<count($data); $i++)
    $i=0;
    $start=false;
    foreach($data as $datum=>$waarde)
    {
      if($i%$jaren==0)
      {
        $this->pdf->SetFont($this->pdf->rapport_font, '', 6);
        $this->pdf->TextWithRotation($XDiag + ($i) * $unit - 5 + $unit, $YDiag + $hDiag + 8, $legendDatum[$datum], 25);
        $this->pdf->SetFont($this->pdf->rapport_font, '', 8);
      }
      $yval2 = $YDiag + (($maxVal-$waarde) * $waardeCorrectie) ;
      
      if ($i>0 && $start==true || $eerstePunt==true)
      {
        $this->pdf->line($XDiag+$i*$unit, $yval, $XDiag+($i+1)*$unit, $yval2,$lineStyle );
      }
      if($waarde<>0)
        $start=true;

      $yval = $yval2;
      $i++;
    }
    
    if(is_array($data1))
    {
      $yval=$YDiag + (($maxVal) * $waardeCorrectie) ;
      $lineStyle = array('width' => 0.5, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => $color1);

     // for ($i=0; $i<count($data1); $i++)
      $i=0;
      $start=false;
      foreach($data1 as $datum=>$waarde)
      {
        $yval2 = $YDiag + (($maxVal-$waarde) * $waardeCorrectie) ;
        
        if ($i>0 && $start==true || $eerstePunt==true)
        {
          $this->pdf->line($XDiag+$i*$unit, $yval, $XDiag+($i+1)*$unit, $yval2,$lineStyle );
        }
        if($waarde<>0)
          $start=true;
        $yval = $yval2;
        $i++;
      }
    }

    if(is_array($data2))
    {
      $yval=$YDiag + (($maxVal) * $waardeCorrectie) ;
      $lineStyle = array('width' => 0.5, 'cap' => 'round', 'join' => 'miter', 'dash' => 0, 'color' => $color2);

      //for ($i=0; $i<count($data2); $i++)
      $i=0;
      $start=false;
      foreach($data2 as $datum=>$waarde)
      {
        $yval2 = $YDiag + (($maxVal-$waarde) * $waardeCorrectie) ;

        if ($i>0 && $start==true || $eerstePunt==true)
        {
          $this->pdf->line($XDiag+$i*$unit, $yval, $XDiag+($i+1)*$unit, $yval2,$lineStyle );
        }
        if($waarde<>0)
          $start=true;
        $yval = $yval2;
        $i++;
      }
    }

    $this->pdf->SetLineStyle(array('color'=>array(0,0,0),'width' => 0.2,'cap' => 'butt'));
    $step=5;
    /*
    foreach ($legendaItems as $index=>$item)
    {
      if($index==0)
        $kleur=$color;
      elseif($index==1)
        $kleur=$color1;
      else
        $kleur=$color2;

    $this->pdf->SetDrawColor($kleur[0],$kleur[1],$kleur[2]);
    $this->pdf->Rect($XPage+$step, $YPage+$h+10, 3, 3, 'DF','',$kleur);
    $this->pdf->SetXY($XPage+3+$step,$YPage+$h+10);
    $this->pdf->Cell(0,3,vertaalTekst($item,$this->pdf->rapport_taal));
    $step+=($w/3);
    }
    */
    $this->pdf->SetDrawColor(0,0,0);
    $this->pdf->SetFillColor(0,0,0);
  }
 

}
?>