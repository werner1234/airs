<?php

$kop='iVBORw0KGgoAAAANSUhEUgAAARwAAAEcCAMAAAAiKvvSAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJBNkQ4REUxRjU5MjExRThCNjk5ODNGNTk5MDE1NjBFIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJBNkQ4REUyRjU5MjExRThCNjk5ODNGNTk5MDE1NjBFIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkE2RDhEREZGNTkyMTFFOEI2OTk4M0Y1OTkwMTU2MEUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkE2RDhERTBGNTkyMTFFOEI2OTk4M0Y1OTkwMTU2MEUiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6VosubAAAAM1BMVEWBlqNC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';

$db=new DB();
$query="SELECT * FROM CRM_naw WHERE  CRM_naw.id = '" . $data['deb_id'] . "' ";

$db->SQL($query);
$crmData=$db->lookupRecord();

$mageBackup=$pdf->marge;
$rowHeightBackup=$pdf->rowHeight;
$pdf->marge = 30;
$pdf->rowHeight=4;
$pdf->SetLeftMargin($pdf->marge);
$pdf->SetRightMargin($pdf->marge);
$pdf->SetTopMargin($pdf->marge);

// Moet weg bij in gebruikname HelveticaNeue
if (file_exists(FPDF_FONTPATH . 'calibri.php'))
{
  if (!isset($pdf->fonts['calibri']))
  {
    $pdf->AddFont('calibri', '', 'calibri.php');
    $pdf->AddFont('calibri', 'B', 'calibrib.php');
    $pdf->AddFont('calibri', 'I', 'calibrii.php');
    $pdf->AddFont('calibri', 'BI', 'calibribi.php');
  }
  
}

$font='Calibri';
//$font='HelveticaNeue';

$pdf->SetFont($font,"",11);

$pdf->rapport_type = "FACTUUR";
$pdf->AddPage('P');
$pdf->SetY($pdf->getY() +30);

$width=80;
$pdf->image($pdf->rapport_logo,210/2-$width/2,15,$width);


$pdf->SetWidths(array(80,90));
$pdf->SetAligns(array("L","L"));
$kwartaal = intval(ceil(date("n",db2jul($crmData['datumTot']))/3));

$kwartalen[1] = 'eerste';
$kwartalen[2] = 'tweede';
$kwartalen[3] = 'derde';
$kwartalen[4] = 'vierde';


$pdf->SetWidths(array(160));
$pdf->SetAligns(array("L","L"));
$pdf->row(array($crmData['naam']));
if ($crmData['naam1'] !='')
  $pdf->row(array($crmData['naam1']));
if ($crmData['PaAanhef'] !='')
  $pdf->row(array($crmData['PaAanhef']));
$pdf->row(array($crmData['verzendAdres']));
$plaats='';
if($crmData['verzendPc'] != '')
  $plaats .= $crmData['verzendPc']." ";
$plaats .= $crmData['verzendPlaats'];
$pdf->row(array($plaats));
if(strtolower($crmData['verzendLand']) <> 'nederland')
  $pdf->row(array($crmData['verzendLand']));

$pdf->rowHeight=5;
$pdf->SetY($pdf->getY() +20);

$pdf->ln();

  $factuurnummer =   $data['factuurnr'];

//$pdf->SetFont($font,"",11);
$pdf->SetWidths(array(40,100));
$pdf->SetAligns(array("L","L"));
$tussenruimte =0;
$pdf->setY(95);
$pdf->SetFont($font,"B",11);
$pdf->row(array("Factuur"));
$pdf->SetFont($font,"",11);

$pdf->row(array($data['factuuronderwerp']));
$pdf->ln();
$pdf->row(array("Factuurdatum",": ".date("j")." ".$__appvar["Maanden"][date("n")]." ".date("Y")));
$pdf->ln($tussenruimte);
$pdf->row(array("Cliëntnummer",": ".$crmData['debiteurnr']));
$pdf->ln($tussenruimte);
$jaar=substr($crmData['datumTot'],2,2);
$factuurnummerFull = date("y").".70.".$factuurnummer;
$factuurnummerFull = $factuurnummer;

$pdf->row(array("Factuurnummer",": $factuurnummerFull"));


$pdf->SetY(130);
$pdf->SetFont($font,"",11);


$pdf->SetWidths(array(150));







$l12Marge = 30;
$pdf->Ln(10);
$pdf->row(array($data['tekstblok1']));
$pdf->Ln(5);

$pdf->SetWidths(array(115,5,25,10));
$pdf->SetAligns(array("L","R","R","L"));
/** maak de header */

$totEx = 0;
$btwTot[0] = 0;
$btwTot[6] = 0;
$btwTot[9] = 0;
$btwTot[21] = 0;

$rowCount = 0;
$thisRowCount = 0;
foreach ( $data['factuur'] as $row )
{
  if ( ! empty ($row['bedrag'])) {$thisRowCount++;}
}

$hasBTW = false;
$has0BTW = false;
foreach ( $data['factuur'] as $row )
{
  if (  empty ($row['bedrag'])) {continue;}
  $rowCount++;
  if ( $thisRowCount === $rowCount && $rowCount > 1 ) {$pdf->CellBorders = array('','','U','','');}
  $btwTot[$row['btw']] +=  ($row['bedrag'] * $row['btw']/100);
  if ( $has0BTW === false && $row['btw'] === '0' ) {
    $has0BTW = true;
  }
  if ( $hasBTW === false && $row['btw'] !== '' ) {
    $hasBTW = true;
  }
  
  $pdf->row(array( $row['ond'],"€",number_format($row['bedrag'], 2, ',', '.'), ($thisRowCount === $rowCount ? '+':'')));
  $pdf->ln($tussenruimte);
//  $pdf->Row(array(' ',$row['ond'],EURO,   ' ' . number_format($row['bedrag'], 2, ',', '.')));
  $totEx =  $totEx + $row['bedrag'];
}
if ( $rowCount > 1 && $hasBTW === true) {
  $pdf->CellBorders = array('','','','','');
  $pdf->Row(array('','€', '' . number_format($totEx, 2, ',', '.')));
}


$pdf->CellBorders = null;
//$pdf->ln(3);

$btwLast= false;

if ( $has0BTW === true ) {
  if ( empty ($btwTot[6]) && empty ($btwTot[9]) && empty ($btwTot[21]) ){$pdf->CellBorders = array('','','','','U'); $btwLast = true;}
  $pdf->Row(array('BTW 0% ', EURO , number_format(0, 2, ',', '.'), ($btwLast === true ? '+':'')));
  $pdf->ln($tussenruimte);
}

if ( ! empty ($btwTot[6]) ) {
  if ( empty ($btwTot[9]) && empty ($btwTot[21]) ){$pdf->CellBorders = array('','','','','U'); $btwLast = true;}
  $pdf->Row(array('BTW 6% ', EURO , number_format($btwTot[6], 2, ',', '.'), ($btwLast === true ? '+':'')));
  $pdf->ln($tussenruimte);
}

if ( ! empty ($btwTot[9]) ) {
  if ( empty ($btwTot[6]) && empty ($btwTot[21])  ){$pdf->CellBorders = array('','','','','U');$btwLast = true;}
  if ( ! empty ($btwTot[6]) && empty ($btwTot[21])  ){$pdf->CellBorders = array('','','','','U');$btwLast = true;}
  $pdf->Row(array('BTW 9% ', EURO , number_format($btwTot[9], 2, ',', '.'), ($btwLast === true ? '+':'')));
  $pdf->ln($tussenruimte);
}

if ( ! empty ($btwTot[21]) ) {
  if ( empty ($btwTot[9]) && ! empty ($btwTot[6]) ){$pdf->CellBorders = array('','','','','U');$btwLast = true;}
  if ( ! empty ($btwTot[9]) &&  empty ($btwTot[6]) ){$pdf->CellBorders = array('','','','','U');$btwLast = true;}
  if ( ! empty ($btwTot[9]) &&  !empty ($btwTot[6]) ){$pdf->CellBorders = array('','','','','U');$btwLast = true;}
  if ( empty ($btwTot[9]) &&  empty ($btwTot[6]) ){$pdf->CellBorders = array('','','','','U');$btwLast = true;}
  $pdf->Row(array('BTW 21%', EURO , number_format($btwTot[21], 2, ',', '.'), ($btwLast === true ? '+':'')));
}



$pdf->ln($tussenruimte);
//	$pdf->row(array("Subtotaal","€",$this->formatGetal($this->waarden['beheerfeePerPeriode']+$this->waarden['btw'],2)));
//	$pdf->ln($tussenruimte);
$pdf->Line($pdf->marge+115+5,$pdf->GetY(),$pdf->marge +115+5+25 ,$pdf->GetY());
//$pdf->row(array("Totaal","€",number_format($totEx, 2, ',', '.')));
$pdf->Row(array('Totaal', EURO , number_format($totEx + $btwTot[21] + $btwTot[9] + $btwTot[6], 2, ',', '.')));


$pdf->Ln(20);
$pdf->SetWidths(array($l12Marge-$pdf->marge,180));
$pdf->Row(array($data['tekstblok2']));
$pdf->Ln(5);
$pdf->ln();








//		"Per 1 januari 2012 is ons BTW-nummer gewijzigd in NL807290427B01."));
//	$pdf->ln(70);
//	$pdf->row(array("Bijlage"));
$x=$pdf->getX();
$y=$pdf->getY();
$pdf->AutoPageBreak=false;
$pdf->setXY(0,297-20);
$pdf->SetFont($font,"",10);
$pdf->SetTextColor(51,51,51);
$pdf->MultiCell(210,$pdf->rowHeight-0.5,"Waterland Investment Services B.V.
Krijn Taconiskade 428, 1087 HW Amsterdam, The Netherlands | + 31 20 246 6060 | www.waterland.co.nl
Bank NL03ABNA0519529693 | Chamber of Commerce 33306164 | VAT NL807290427B01",0,'C',0);
$pdf->AutoPageBreak=true;
$pdf->setXY($x,$y);


$pdf->marge=$mageBackup;
$pdf->rowHeight=$rowHeightBackup;
$pdf->SetLeftMargin($pdf->marge);
$pdf->SetRightMargin($pdf->marge);
$pdf->SetTopMargin($pdf->marge);




if ( isset($data['sub_email']) )
{
  $db = new DB();
  $fields = array(
    'crmId'         => $crmData['id'],
    'status'        => 'aangemaakt',
    'senderName'    => $_SESSION['usersession']['gebruiker']['Naam'],
    'senderEmail'   => $_SESSION['usersession']['gebruiker']['emailAdres'],
    'ccEmail'       => '',
    'bccEmail'      => '',
    'receiverName'  => $crmData['naam'],
    'receiverEmail' => $crmData['email'],
    'subject'       => 'Factuur ' . $data['factuurnr'],
    'bodyHtml'      => 'Factuur'
  );
  $query = "INSERT INTO emailQueue SET add_date=now(),add_user='$USR',change_date=now(),change_user='$USR'";
  foreach ($fields as $key => $value)
  {
    $query .= ",$key='" . mysql_escape_string($value) . "'";
  }
  
  $db->SQL($query);
  $db->Query();
  $lastId = $db->last_id();
  
  $blobData = bin2hex($pdf->Output('Factuur' . $crmData['id'] . '.pdf', 's'));
  
  $query = "INSERT INTO emailQueueAttachments
              SET add_date=now(),add_user='$USR',change_date=now(),change_user='$USR',
              emailQueueId='$lastId',
              filename = 'Factuur " . $data['factuurnr'] . ".pdf',
              Attachment=unhex('$blobData')";
  $db->SQL($query);
  $db->Query();
  
  echo '<div class="alert alert-info">In e-mail queue geplaatst</div>';
  
}
elseif ( isset ($data['sub_edos']) )
{
  
  $blobData = ($pdf->Output('Factuur' . $data['factuurnr'] . '.pdf', 's'));
  
  $filesize = strlen($blobData);
  $filetype = mime_content_type($blobData);
  $fileHandle = fopen($pdfFile, "r");
  
  $rec = array (
    'portefeuille' => $crmData['Portefeuille'],
    'filename' => 'factuur_' . $data['factuurnr'] . '.pdf',
    'keywords' => 'factuur_' . $data['factuurnr'] . '.pdf',
    'filesize' => $filesize,
    'filetype' => 'application/pdf',
    'categorie' => $data['categorie'],
    'description' => $data['description'],
    'keywords' => 'factuur_' . $data['factuurnr'] . '.pdf',
    'module' => 'CRM_naw',
    'module_id' => $crmData['id'],
    'blobdata' => $blobData
  );
  
  $dd = new digidoc();
  $extraVelden = array();
  $dd->useZlib = false;
  
  if ($dd->addDocumentToStore($rec, $extraVelden) == false)
  {
    echo '<div class="alert alert-warning">Niet in e-dossier  geplaatst</div>';
  }
  else
  {
    echo '<div class="alert alert-info">In e-dossier geplaatst</div>';
  }
  
  
  
  
} elseif ($verzenden === false)
{
  $pdf->Output($filename . '.pdf', 'I');
}
else
{
  echo $berichten;
}